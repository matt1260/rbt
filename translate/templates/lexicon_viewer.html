{% extends 'base.html' %}
{% block title %}{{ lexicon_name }} Lexicon - {{ page_number }}{% endblock %}
{% block content %}

<style>
.lexicon-viewer {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.viewer-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.viewer-title {
    font-size: 18px;
    font-weight: 600;
    color: #8e5c26;
}

.viewer-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.control-btn {
    padding: 8px 16px;
    background: #b78550;
    color: #fff;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 600;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}

.control-btn:hover {
    background: #965f35;
    transform: translateY(-1px);
}

.control-btn:disabled {
    background: #ccc;
    cursor: not-allowed;
    transform: none;
}

.control-btn i {
    font-size: 16px;
}

.zoom-controls {
    display: flex;
    gap: 6px;
    align-items: center;
    padding: 0 15px;
    border-left: 2px solid #ddd;
    border-right: 2px solid #ddd;
}

.zoom-level {
    font-size: 14px;
    color: #666;
    min-width: 45px;
    text-align: center;
}

.image-container {
    position: relative;
    background: #fff;
    border: 2px solid #ddd;
    border-radius: 8px;
    overflow: auto;
    max-height: calc(100vh - 200px);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    padding: 20px;
}

.lexicon-image {
    max-width: 100%;
    height: auto;
    transition: transform 0.3s ease;
    cursor: grab;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.lexicon-image:active {
    cursor: grabbing;
}

.loading-indicator {
    position: absolute;
    top: 70%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 18px;
    color: #666;
}

.keyboard-shortcuts {
    margin-top: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
    font-size: 13px;
}

.keyboard-shortcuts h4 {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #333;
}

.shortcut-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 8px;
}

.shortcut-item {
    display: flex;
    align-items: center;
    gap: 10px;
}

.shortcut-key {
    display: inline-block;
    padding: 2px 8px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-family: monospace;
    font-size: 12px;
    min-width: 30px;
    text-align: center;
}

.shortcut-desc {
    color: #666;
}

.error-message {
    text-align: center;
    padding: 40px;
    background: #fff3cd;
    border: 1px solid #ffc107;
    border-radius: 8px;
    margin: 20px 0;
}

.fullscreen-btn {
    background: #6c757d;
}

.fullscreen-btn:hover {
    background: #5a6268;
}
</style>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

<div class="lexicon-viewer">
    <div class="viewer-header">
        <div class="viewer-title">
            {{ lexicon_name }} Lexicon - {{ page_number }}
        </div>
        <div class="viewer-controls">
            <a href="{{ prev_url }}" class="control-btn" {% if not has_prev %}disabled{% endif %} title="Previous Page (←)">
                <i class="fas fa-chevron-left"></i>
                Prev
            </a>
            


            <a href="{{ next_url }}" class="control-btn" {% if not has_next %}disabled{% endif %} title="Next Page (→)">
                Next
                <i class="fas fa-chevron-right"></i>
            </a>

            <div class="zoom-controls">
                <button onclick="zoomOut()" class="control-btn" title="Zoom Out (-)">
                    <i class="fas fa-search-minus"></i>
                </button>
                <span class="zoom-level" id="zoomLevel">100%</span>
                <button onclick="zoomIn()" class="control-btn" title="Zoom In (+)">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button onclick="resetZoom()" class="control-btn" title="Reset Zoom (0)">
                    <i class="fas fa-compress"></i>
                </button>
            </div>

            <button onclick="toggleFullscreen()" class="control-btn fullscreen-btn" title="Fullscreen (F)">
                <i class="fas fa-expand"></i>
            </button>

            <button onclick="window.close()" class="control-btn" style="background: #6c757d;" title="Close Window">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <div class="image-container" id="imageContainer">
        {% if image_url %}
        <img src="{{ image_url }}" 
             alt="{{ lexicon_name }} Lexicon {{ page_number }}" 
             class="lexicon-image" 
             id="lexiconImage"
             onload="imageLoaded()"
             onerror="imageError()">
        <div class="loading-indicator" id="loadingIndicator">
            <i class="fas fa-spinner fa-spin"></i> Loading...
        </div>
        {% else %}
        <div class="error-message">
            <h3>Image Not Found</h3>
            <p>The lexicon page image could not be located.</p>
            <p><strong>Page:</strong> {{ page_number }}</p>
        </div>
        {% endif %}
    </div>

    <div class="keyboard-shortcuts">
        <h4><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h4>
        <div class="shortcut-list">
            <div class="shortcut-item">
                <span class="shortcut-key">+</span>
                <span class="shortcut-desc">Zoom in</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">-</span>
                <span class="shortcut-desc">Zoom out</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">0</span>
                <span class="shortcut-desc">Reset zoom</span>
            </div>
            <div class="shortcut-item">
                <span class="shortcut-key">F</span>
                <span class="shortcut-desc">Fullscreen</span>
            </div>
        </div>
    </div>
</div>

<script>
let currentZoom = 1.0;
const zoomStep = 0.25;
const minZoom = 0.5;
const maxZoom = 3.0;

function updateZoomDisplay() {
    document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
}

function zoomIn() {
    if (currentZoom < maxZoom) {
        currentZoom += zoomStep;
        applyZoom();
    }
}

function zoomOut() {
    if (currentZoom > minZoom) {
        currentZoom -= zoomStep;
        applyZoom();
    }
}

function resetZoom() {
    currentZoom = 1.0;
    applyZoom();
}

function applyZoom() {
    const img = document.getElementById('lexiconImage');
    if (img) {
        img.style.transform = `scale(${currentZoom})`;
        img.style.transformOrigin = 'top center';
    }
    updateZoomDisplay();
}

function toggleFullscreen() {
    const container = document.getElementById('imageContainer');
    if (!document.fullscreenElement) {
        container.requestFullscreen().catch(err => {
            console.error('Error attempting to enable fullscreen:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

function imageLoaded() {
    document.getElementById('loadingIndicator').style.display = 'none';
}

function imageError() {
    const loading = document.getElementById('loadingIndicator');
    loading.innerHTML = '<p><i class="fas fa-exclamation-triangle"></i> Page not found</p>';
    loading.style.color = '#dc3545';
}

function goToPage() {
    const pageInput = document.getElementById('pageInput');
    const pageNum = parseInt(pageInput.value);
    if (pageNum && pageNum > 0) {
        const lexiconType = '{{ lexicon_type }}';
        const currentPage = '{{ page_raw }}';
        
        // Detect the filename pattern from the current page
        let formattedPage;
        if (currentPage.startsWith('fuerst_lex_')) {
            formattedPage = `fuerst_lex_${pageNum.toString().padStart(4, '0')}.jpg`;
        } else if (currentPage.startsWith('gesenius_lexicon_')) {
            formattedPage = `gesenius_lexicon_${pageNum.toString().padStart(4, '0')}.jpg`;
        } else {
            // Default simple format with detected extension
            const ext = currentPage.includes('.') ? currentPage.split('.').pop() : 'png';
            formattedPage = `${pageNum.toString().padStart(4, '0')}.${ext}`;
        }
        
        window.location.href = `/lexicon/${lexiconType}/${formattedPage}`;
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    // Don't trigger if user is typing in input field
    if (e.target.tagName === 'INPUT') return;
    
    switch(e.key) {
        case 'ArrowLeft':
            e.preventDefault();
            const prevBtn = document.querySelector('.control-btn[href*="prev"]');
            if (prevBtn && !prevBtn.hasAttribute('disabled')) {
                window.location.href = prevBtn.href;
            }
            break;
        case 'ArrowRight':
            e.preventDefault();
            const nextBtn = document.querySelector('.control-btn[href*="next"]');
            if (nextBtn && !nextBtn.hasAttribute('disabled')) {
                window.location.href = nextBtn.href;
            }
            break;
        case '+':
        case '=':
            e.preventDefault();
            zoomIn();
            break;
        case '-':
            e.preventDefault();
            zoomOut();
            break;
        case '0':
            e.preventDefault();
            resetZoom();
            break;
        case 'f':
        case 'F':
            e.preventDefault();
            toggleFullscreen();
            break;
    }
});

// Pan image with mouse drag
let isDragging = false;
let startX, startY, scrollLeft, scrollTop;

const container = document.getElementById('imageContainer');
container.addEventListener('mousedown', (e) => {
    // Enable dragging at any zoom level
    isDragging = true;
    container.style.cursor = 'grabbing';
    startX = e.pageX - container.offsetLeft;
    startY = e.pageY - container.offsetTop;
    scrollLeft = container.scrollLeft;
    scrollTop = container.scrollTop;
    e.preventDefault(); // Prevent text selection while dragging
});

container.addEventListener('mouseleave', () => {
    isDragging = false;
    container.style.cursor = 'grab';
});

container.addEventListener('mouseup', () => {
    isDragging = false;
    container.style.cursor = 'grab';
});

container.addEventListener('mousemove', (e) => {
    if (!isDragging) return;
    e.preventDefault();
    const x = e.pageX - container.offsetLeft;
    const y = e.pageY - container.offsetTop;
    const walkX = (x - startX) * 1.5;
    const walkY = (y - startY) * 1.5;
    container.scrollLeft = scrollLeft - walkX;
    container.scrollTop = scrollTop - walkY;
});

// Allow Enter key in page input
document.getElementById('pageInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        goToPage();
    }
});
</script>

{% endblock %}
