{% extends 'base.html' %}
{% block title %}RBT Translator - {{ page_title }}{% endblock %}
{% load custom_tags %}
{% block content %}

<style>
/* Override base.html container constraints for full width */
.nv-content-wrap {
    max-width: 100% !important;
    padding: 0 !important;
}

.container {
    max-width: 100% !important;
    padding: 0 20px !important;
}

/* Page Layout */
.page-wrapper {
    max-width: 1800px;
    margin: 0 auto;
    padding: 20px;
}

/* Hebrew Interlinear Grid - Full Width */
.hebrew-interlinear-section {
    width: 100%;
    max-width: 100%;
    margin: 20px 0;
    padding: 20px;
    background: #fafafa;
    border-radius: 8px;
}

.hebrew-interlinear-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: flex-start;
    direction: rtl;
    width: 100% !important;
    max-width: 100% !important;
}

/* Editor Layout - Two Column */
.editor-layout {
    display: grid;
    grid-template-columns: 1fr 500px;
    gap: 30px;
    margin: 30px 0;
    overflow: visible;
}

.edit-table-container {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    overflow: visible;
    position: relative;
}

.table-scroll-wrapper {
    overflow-x: auto;
    overflow-y: visible;
    margin: 0 -20px;
    padding: 0 20px;
    position: relative;
}

/* Prevent scroll-locking when hovering popups */
.table-scroll-wrapper:has(.popup-container:hover) {
    overflow: visible;
}

/* Ensure popups can escape containers */
.popup-container {
    position: static;
    display: inline-block;
}

.popup-content {
    position: fixed;
    z-index: 9999;
    transform: translateY(0) !important;
}

.paraphrase-editor-container {
    background: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 20px;
    position: sticky;
    top: 20px;
    height: fit-content;
    overflow: visible;
}

/* Edit Table Styling */
.hebrewTable {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
    position: relative;
    z-index: 1;
}

.hebrewTable td {
    padding: 10px 8px;
    border-bottom: 1px solid #eee;
    vertical-align: middle;
    position: relative;
    overflow: visible;
}

.hebrewTable input[type="text"] {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

.hebrewTable input[type="text"]:focus {
    outline: none;
    border-color: #b78550;
    box-shadow: 0 0 0 2px rgba(183, 133, 80, 0.1);
}

/* Paraphrase Editor */
.paraphrase-editor-container h4 {
    margin: 0 0 15px 0;
    font-size: 18px;
    color: #333;
    border-bottom: 2px solid #b78550;
    padding-bottom: 10px;
}

#englishReader {
    display: block;
    padding: 15px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
    min-height: 100px;
    margin-bottom: 15px;
    font-size: 14px;
    line-height: 1.6;
}

#textArea {
    width: 100%;
    min-height: 200px;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    font-size: 14px;
    line-height: 1.6;
    resize: vertical;
}

#textArea:focus {
    outline: none;
    border-color: #b78550;
    box-shadow: 0 0 0 3px rgba(183, 133, 80, 0.1);
}

/* Editor Toolbar */
.editor-toolbar {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin: 15px 0;
    padding: 12px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
}

.editor-toolbar button {
    width: 32px;
    height: 32px;
    padding: 0;
    background: #b78550;
    border: none;
    border-radius: 4px;
    color: #fff;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    font-size: 14px;
}

.editor-toolbar button:hover {
    background: #965f35;
    transform: translateY(-1px);
}

.editor-toolbar button:active {
    transform: translateY(0);
}

.editor-toolbar button.wide {
    width: auto;
    padding: 0 12px;
}

.editor-toolbar button.reset {
    background: #000;
}

.editor-toolbar button.reset:hover {
    background: #333;
}

.editor-toolbar input[type="text"] {
    flex: 1;
    min-width: 150px;
    padding: 6px 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 13px;
}

/* Form Actions */
.form-actions {
    display: flex;
    align-items: center;
    gap: 15px;
    margin: 20px 0;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 6px;
}

.form-actions button[type="submit"] {
    padding: 10px 24px;
    background: #28a745;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.form-actions button[type="submit"]:hover {
    background: #218838;
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
}

.form-actions label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    cursor: pointer;
}

/* Interlinear Controls */
.interlinear-controls {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    font-size: 14px;
}

.interlinear-controls label {
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
}

/* Search Box */
.search {
    margin-bottom: 20px;
}

.search form {
    display: flex;
    gap: 10px;
}

.search input[type="text"] {
    flex: 1;
    max-width: 400px;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
}

.search button {
    padding: 10px 24px;
    background: #b78550;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
}

.search button:hover {
    background: #965f35;
}

/* Arrow Navigation */
.arrow-links {
    text-align: center;
    margin: 20px 0;
}

.arrow-links h3 {
    font-size: 24px;
    color: #333;
}

.arrow-links a {
    color: #b78550;
    text-decoration: none;
    margin: 0 10px;
    transition: all 0.2s;
}

.arrow-links a:hover {
    color: #965f35;
    transform: scale(1.1);
}

/* Chapter Reader */
.chapter-reader-section {
    margin: 30px 0;
    padding: 20px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
}

.chapter-reader-section h4 {
    margin: 0 0 15px 0;
    font-size: 18px;
    color: #333;
    border-bottom: 2px solid #b78550;
    padding-bottom: 10px;
}

/* Popup */
.popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 600px;
    max-height: 80vh;
    overflow-y: auto;
    padding: 20px;
    background: #fff;
    border: 2px solid #28a745;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 1000;
}

.popup .close {
    margin-top: 15px;
    padding: 8px 16px;
    background: #6c757d;
    color: #fff;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.popup .close:hover {
    background: #5a6268;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .editor-layout {
        grid-template-columns: 1fr;
    }
    
    .paraphrase-editor-container {
        position: static;
    }
}

@media (max-width: 768px) {
    .page-wrapper {
        padding: 10px;
    }
    
    .hebrew-interlinear-section {
        padding: 15px 10px;
    }
    
    .hebrew-interlinear-grid {
        gap: 8px;
    }
    
    .editor-toolbar {
        gap: 4px;
    }
    
    .editor-toolbar button {
        width: 28px;
        height: 28px;
        font-size: 12px;
    }
}

.tablefloat td {
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
</style>



<script>
  function toggleFootnote(button) {
    const target = button.getAttribute('data-target');
    const footnote = document.querySelector(`.${target}`);

    if (footnote.style.display === 'none') {
      showFootnote(target);
    } else {
      hideFootnote(target);
    }
  }

  function hideFootnote(target) {
    document.querySelector(`.${target}`).style.display = 'none';
  }

  function showFootnote(target) {
    document.querySelector(`.${target}`).style.display = 'table-cell';
  }

</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.tiny.cloud/1/z2v6hmacz3k9f8fruornolneh77m6jm8ybydwx3v3zwsfi55/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<script>
  $(document).ready(function () {
      tinymce.init({
        selector: 'textarea.my-tinymce', // Use a class selector for textareas
        plugins: 'anchor autolink charmap codesample code emoticons image link lists media searchreplace table visualblocks wordcount',
        toolbar: 'undo redo  | blocks fontfamily fontsize | code bold italic underline | link image media table mergetags | align lineheight | tinycomments | checklist numlist bullist indent outdent | charmap | removeformat',
        tinycomments_mode: 'embedded',
        tinycomments_author: 'Author name',
        mergetags_list: [
          { value: 'First.Name', title: 'First Name' },
          { value: 'Email', title: 'Email' },
        ],
        branding: false,  // Hide the TinyMCE branding
        ai_request: (request, respondWith) => respondWith.string(() => Promise.reject("See docs to implement AI Assistant"))
      });
  });
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var toggle = document.getElementById('cardNiqqudSwitch');
    if (!toggle) {
      return;
    }

    function setCardNiqqud(show) {
      var cardContainers = document.querySelectorAll('.interlinear-card .card-hebrew');
      cardContainers.forEach(function (card) {
        var withNiqqud = card.querySelector('.hebrew-with-niqqud');
        var noNiqqud = card.querySelector('.hebrew-no-niqqud');
        if (!withNiqqud || !noNiqqud) {
          return;
        }

        withNiqqud.style.display = show ? 'block' : 'none';
        noNiqqud.style.display = show ? 'none' : 'block';
      });
    }

    setCardNiqqud(false);
    toggle.addEventListener('change', function () {
      setCardNiqqud(this.checked);
    });
  });
</script>

<!-- <script>
  document.addEventListener("DOMContentLoaded", function () {
    // Get all elements with class "morph-cell"
    var morphCells = document.querySelectorAll(".morph-cell");

    // Add event listeners to show and hide the pop-up
    morphCells.forEach(function (cell) {
      cell.addEventListener("mouseover", function () {
        var morphPopup = this.querySelector(".morph-popup");
        morphPopup.style.display = "block";
      });

      cell.addEventListener("mouseout", function () {
        var morphPopup = this.querySelector(".morph-popup");
        morphPopup.style.display = "none";
      });
    });
  });
</script> -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />


<style>

    /* Style for the STRONGS pop-up container */
    .popup-container {
        position: relative; /* Create a positioning context */
        display: inline-block; /* Display the container inline */
    }
    /* Style for the pop-up content */
    .popup-content {
        display: none; /* Initially hide the content */
        position: absolute; /* Position it absolutely within the container */
        top: 100%; /* Position below the container */
        left: 0;
        background-color: #fff; /* Background color */
        border: 1px solid #e3e6ea; /* Border */
        padding: 10px; /* Padding */
        box-shadow: 0 6px 20px rgba(18, 38, 63, 0.08); /* Softer shadow */
        z-index: 200; /* Ensure it's above other content */
        width: 320px; /* Adjust the width as needed */
        font-size: 13px;
        text-align: left;
        border-radius: 8px;
        opacity: 0;
        transform: translateY(-6px);
        transition: opacity 0.12s ease, transform 0.12s ease;
    }

    /* Header label is now part of the content layout */

    /* Style to show the pop-up content on hover (fade/slide) */
    .popup-container:hover .popup-content {
        display: block; /* Show the content on hover */
        opacity: 1;
        transform: translateY(0);
    }

    /* Strong-specific popup enhancements */

    .strong-xlit {
        font-size: 13px;
        color: #7b675a;
        font-style: italic;
        margin-top: 2px;
        letter-spacing: 0.04em;
        text-transform: none;
    }

    .strong-details {
        margin-top: 8px;
    }

    .strong-details dt {
        font-weight: 600;
        font-size: 11px;
        color: #6b4b3d;
        margin-top: 8px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .strong-details dd {
        margin: 2px 0 6px 0;
        font-size: 13px;
        color: #2f2f2f;
        line-height: 1.35;
    }

    .strong-popup .strong-fine-print {
        font-size: 11px;
        color: #6b4b3d;
        margin-top: 8px;
    }

    .strong-citation {
        margin-top: 10px;
        border-top: 1px dashed #f1d7c7;
        padding-top: 6px;
        font-size: 11px;
        color: #7b675a;
    }

    .strong-citation a {
        color: #a4491d;
        text-decoration: none;
        font-weight: 600;
    }

    .strong-citation a:hover {
        text-decoration: underline;
    }

    .strong-link {
        text-decoration: none;
        color: #a4491d;
        font-weight: 700;
        font-size: 12px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
    }


    .fuerst-popup {
        display: inline-flex;
        align-items: center;
        margin-left: 6px;
    }

    .strongs-trigger,
    .fuerst-trigger {
        font-size: 10px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 600;
        color: #7a2f11;
        background: linear-gradient(120deg, #fff7f2, #ffe9df);
        border: 1px solid #f1c7b2;
        border-radius: 999px;
        padding: 2px 7px;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .strongs-trigger:hover,
    .strongs-trigger:focus,
    .fuerst-trigger:hover,
    .fuerst-trigger:focus {
        background: linear-gradient(120deg, #ffe1d0, #ffd2bb);
        color: #5c210c;
        border-color: #e4a583;
    }

    .strongs-popup {
        display: inline-flex;
        align-items: center;
        margin-right: 6px;
    }

    .strongs-popup-content {
        width: 360px;
        left: -180px;
        border-color: #f2d7c8;
    }



    .strongs-entry {
        padding: 8px 0;
        border-top: 1px dashed #f1d7c7;
    }

    .strongs-entry:first-of-type {
        border-top: none;
        padding-top: 0;
    }

    .strongs-headword {
        font-size: 28px;
        font-weight: 700;
        color: #2a1f18;
    }

    .strongs-meta {
        font-size: 13px;
        color: #7b675a;
        font-style: italic;
        margin-top: 2px;
        letter-spacing: 0.04em;
    }

    .strongs-definition,
    .strongs-derivation,
    .strongs-exhaustive {
        font-size: 13px;
        color: #2f2f2f;
        line-height: 1.35;
        margin-top: 6px;
    }

    .strongs-definition strong,
    .strongs-derivation strong,
    .strongs-exhaustive strong {
        font-weight: 600;
        font-size: 11px;
        color: #6b4b3d;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: block;
        margin-bottom: 2px;
    }

    .strongs-link {
        color: #a4491d;
        text-decoration: none;
        font-weight: 600;
    }

    .strongs-link:hover {
        text-decoration: underline;
    }

    .fuerst-popup-content {
        width: 360px;
        left: -180px;
        border-color: #f2d7c8;
    }

    .strongs-title,
    .gesenius-title,
    .fuerst-title {
        font-size: 12px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #9a4a26;
        margin-bottom: 8px;
    }
    .gesenius-entry,
    .strong-entry,
    .fuerst-entry {
        padding: 8px 0;
        border-top: 1px dashed #f1d7c7;
    }

    .fuerst-entry:first-of-type {
        border-top: none;
        padding-top: 0;
    }

    .strongs-headword,
    .fuerst-headword {
        font-size: 20px;
        font-weight: 600;
        color: #1f2d3d;
    }

    .fuerst-meta {
        font-size: 11px;
        color: #6b4b3d;
        margin-top: 4px;
    }

    .fuerst-definition {
        font-size: 13px;
        color: #2f3a44;
        margin-top: 6px;
        line-height: 1.4;
    }

    .fuerst-note {
        font-size: 12px;
        color: #4b2b1f;
        background: #fff5ee;
        border-left: 3px solid #f3c2a7;
        padding: 4px 6px;
        margin-top: 6px;
    }

    .fuerst-link {
        color: #a4491d;
        text-decoration: none;
        font-weight: 600;
    }

    .fuerst-link:hover {
        text-decoration: underline;
    }




     /* Default styles for the desktop view */
     .desktop-view {
        display: block;
    }

    .mobile-view {
        display: none;
    }

    .front_search {
        border: none;
        display: table;
    }

    .front_search form {
        text-align: left;
        margin-bottom: 10px;
    }

    /* Styles for the mobile view */
    @media only screen and (max-width: 767px) {
        .desktop-view {
            display: none;
        }

        .mobile-view {
            display: block;
            margin-bottom: 10px;
        }
    }

    .verse-view {
        margin-top: 1px;
    }

    .strongs {
        font-size: 10px;
    }

    .eng_reader{
        font-size: 12px;
    }

    .hebrew_reader{
        font-size: 20px;
    }

    .hebrew-interlinear-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: flex-start;
        direction: rtl;
        width: 100% !important;
        max-width: 100% !important;
    }

    .interlinear-card {
        background: #f6f7fa;
        border: 1px solid #d9dee6;
        border-radius: 8px;
        padding: 12px 14px;
        min-width: 120px;
        max-width: 220px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
    }

    .interlinear-card .card-hebrew {
        font-size: 28px;
        line-height: 1.3;
        text-align: right;
    }

    .card-hebrew > span {
        display: block;
    }

    .card-hebrew .hebrew-with-niqqud {
        display: none;
    }

    .interlinear-card .card-english {
        font-size: 14px;
        color: #2d2d2d;
        margin-top: 6px;
        direction: ltr;
        text-align: left;
    }

    .interlinear-card .card-strongs {
        font-size: 12px;
        color: #4a4a4a;
        margin-top: 6px;
        direction: ltr;
        text-align: left;
    }

    .interlinear-card .card-morph {
        font-size: 11px;
        color: #6d6d6d;
        margin-top: 6px;
        direction: ltr;
        text-align: left;
    }

    /* LXX (Septuagint) styles */
    .interlinear-card .card-lxx {
        font-size: 13px;
        color: #2e5984;
        margin-top: 6px;
        direction: ltr;
        text-align: left;
    }

    .interlinear-card .card-lxx a {
        color: #2e5984;
        text-decoration: none;
    }

    .interlinear-card .card-lxx a:hover {
        text-decoration: underline;
    }

    /* LXX popup tooltip container */
    .lxx-popup-container {
        position: relative;
        display: inline-block;
        cursor: help;
    }

    /* LXX popup content */
    .lxx-popup-content {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #fff;
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 100;
        width: 250px;
        font-size: 12px;
        text-align: left;
        border-radius: 4px;
        margin-bottom: 5px;
    }

    .lxx-popup-content .lxx-popup-header {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 2px;
        color: #333;
    }

    .lxx-popup-content .lxx-popup-header a {
        color: #2e5984;
        text-decoration: none;
        margin-left: 4px;
    }

    .lxx-popup-content .lxx-popup-header a:hover {
        text-decoration: underline;
    }

    .lxx-popup-content::after {
        content: "Greek translations of this Hebrew word in the Septuagint. This helps us understand how ancient translators interpreted the Hebrew text c. 250 BCE.";
        display: block;
        font-size: 10px;
        color: #888;
        margin-bottom: 6px;
        padding-bottom: 4px;
        border-bottom: 1px solid #eee;
    }

    .lxx-popup-container:hover .lxx-popup-content {
        display: block;
    }

    /* Gesenius trigger styling */
    .gesenius-trigger {
        font-size: 10px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 600;
        color: #7a2f11;
        background: linear-gradient(120deg, #fff7f2, #ffe9df);
        border: 1px solid #f1c7b2;
        border-radius: 999px;
        padding: 2px 7px;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .gesenius-trigger:hover,
    .gesenius-trigger:focus {
        background: linear-gradient(120deg, #ffe1d0, #ffd2bb);
        color: #5c210c;
        border-color: #e4a583;
    }

    .gesenius-popup-content {
        width: 300px;
        left: -150px;
    }

    /* Gesenius detailed styling (match Fuerst) */
    .gesenius-popup { display:inline-flex; align-items:center; margin-left:6px; }
    .gesenius-headword { font-size:20px; font-weight:600; color:#1f2d3d; }
    .gesenius-meta { font-size:11px; color:#6b4b3d; margin-top:4px; }
    .gesenius-definition { font-size:13px; color:#2f3a44; margin-top:6px; line-height:1.4; }
    .gesenius-note { font-size:12px; color:#4b2b1f; background:#fff5ee; border-left:3px solid #f3c2a7; padding:4px 6px; margin-top:6px; }
    .gesenius-link { color:#a4491d; text-decoration:none; font-weight:600; }
    .gesenius-link:hover { text-decoration:underline; }

    .lxx-stats-section {
        margin-top: 6px;
        padding-top: 4px;
        border-top: 1px dotted #ddd;
    }

    .lxx-stats-section .strongs-label {
        font-weight: 600;
        color: #555;
        font-size: 11px;
    }

    .lxx-stats-row {
        font-size: 11px;
        color: #444;
        line-height: 1.6;
        margin-bottom: 4px;
    }

    .lxx-stats-row .stat-label {
        display: inline-block;
        min-width: 80px;
        direction: ltr;
    }

    .lxx-stats-row .stat-label a {
        color: #2e5984;
        text-decoration: none;
    }

    .lxx-stats-row .stat-label a:hover {
        text-decoration: underline;
    }

    .lxx-stats-row .stat-bar-container {
        display: inline-block;
        width: 80px;
        height: 10px;
        background: #e9ecef;
        border-radius: 3px;
        margin: 0 6px;
        vertical-align: middle;
    }

    .lxx-stats-row .stat-bar {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #4a90a4, #2e5984);
        border-radius: 3px;
        min-width: 2px;
    }

    .lxx-stats-row .stat-info {
        font-size: 10px;
        color: #666;
    }

    .interlinear-legacy {
        margin-top: 12px;
    }

    .interlinear-legacy summary {
        cursor: pointer;
        font-size: 13px;
        color: #3f4b6b;
        outline: none;
    }

    @media only screen and (max-width: 1467px) {
        .hebrew-interlinear-grid {
            justify-content: flex-start;
            gap: 8px;
        }

        .interlinear-card {
            min-width: 100px;
            max-width: 180px;
        }

        .interlinear-card .card-hebrew {
            font-size: 24px;
        }
    }

</style>

<div class="page-wrapper">

<div class="search">
  <form method="get" action="./" style="text-align: left;">
    <input type="text" name="q" placeholder="Enter a reference...">
    <button type="submit">Go</button>
  </form>
  {{ invalid_verse|safe }}
</div>

<div class="arrow-links">
  <h3>
    <a href="{{ prev_ref }}"><i class="fas fa-chevron-circle-left"></i></a>
    {{ verse }}<a href="{{ next_ref }}"><i class="fas fa-chevron-circle-right"></i></a>
  </h3>

</div>

{% if rbt %}
<div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
  <strong>Hebrew RBT Translation:</strong> {{ rbt|safe }}
</div>
{% endif %}

{% if english_row %}

<div style="text-align: right; font-size: 34px; margin: 20px 0; padding: 15px; background: #fff; border-radius: 6px;">
  {{ hebrew|safe }}
</div>

<div style="text-align: left; margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 6px;">
  <strong>Smith Literal:</strong> {{ smith|safe }}
</div>

{% if hebrew_interlinear_cards %}
<div class="hebrew-interlinear-section">
  <div class="interlinear-controls">
    <label for="cardNiqqudSwitch">
      <input type="checkbox" id="cardNiqqudSwitch">
      Show Niqqud
    </label>
    <label style="margin-left:12px; font-size:13px; display:inline-block; vertical-align: middle;">
    <input id="toggleHebrewFont" type="checkbox"> Use Paleo Hebrew Font
  </label>
  </div>
  <div class="hebrew-interlinear-grid">
    {% for cell in hebrew_interlinear_cards %}
    <div class="interlinear-card">
      <div class="card-hebrew">
        <span class="hebrew-no-niqqud">{{ cell.hebrew|safe }}</span>
        <span class="hebrew-with-niqqud">{{ cell.hebrew_niqqud|safe }}</span>
      </div>
      <div class="card-english">{{ cell.english|safe }}</div>
      {% if cell.strongs %}
      <div class="card-strongs">{{ cell.strongs|safe }}</div>
      {% endif %}
      {% if cell.morph %}
      <div class="card-morph">{{ cell.morph|safe }}</div>
      {% endif %}
      {% if cell.lxx_words or cell.lxx or cell.lxx_data %}
      <div class="card-lxx">
        <span class="lxx-popup-container">
          <span style="color: #666; font-size: 11px;">LXX:</span>
          {% if cell.lxx_words %}
            {% for word in cell.lxx_words %}
              <a href="https://logeion.uchicago.edu/{{ word }}" target="_blank">{{ word }}</a>{% if not forloop.last %} {% endif %}
            {% endfor %}
          {% elif cell.lxx %}
            {% for word in cell.lxx.split %}
              <a href="https://logeion.uchicago.edu/{{ word }}" target="_blank">{{ word }}</a>{% if not forloop.last %} {% endif %}
            {% endfor %}
          {% endif %}
          {% if cell.lxx_data %}
          <div class="lxx-popup-content">
            <div class="lxx-popup-header">LXX Usage Statistics <a href="https://en.wikipedia.org/wiki/Septuagint" target="_blank" title="Learn about the Septuagint">↗</a></div>
            {% for lxx_item in cell.lxx_data %}
            <div class="lxx-stats-section">
              <div class="strongs-label">{{ lxx_item.strongs }}:</div>
              {% for stat in lxx_item.stats %}
              <div class="lxx-stats-row">
                <span class="stat-label"><a href="https://www.perseus.tufts.edu/hopper/morph?l={{ stat.0 }}" target="_blank">{{ stat.0 }}</a></span>
                <span class="stat-bar-container"><span class="stat-bar" style="width: {{ stat.2 }}%;"></span></span>
                <span class="stat-info">{{ stat.1 }}× ({{ stat.2 }}%)</span>
              </div>
              {% empty %}
              <div class="lxx-stats-row">No stats available</div>
              {% endfor %}
            </div>
            {% endfor %}
          </div>
          {% endif %}
        </span>
      </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- EDITOR LAYOUT -->
<form method="post">
{% csrf_token %}

<div class="editor-layout">
  <div class="edit-table-container">
    <h4 style="margin: 0 0 15px 0; font-size: 18px; color: #333; border-bottom: 2px solid #b78550; padding-bottom: 10px;">
      Verse Editor
    </h4>
    <div class="table-scroll-wrapper">
      <table class="hebrewTable">
        <tbody>
          {% for id, ref_data, eng_data, unique, heb_data, color, search_count, search_count2, strongs, formatted_strongs_list, morph, combined_heb_niqqud, combined_heb, footnote_btn, footnote, morphology_raw, morph_display in edit_table_data %}
          <tr>
            <td style="white-space: nowrap;">{{ ref_data }}</td>
            <td>
              <input type="text" name="eng_data" autocomplete="off" value="{{ eng_data }}" class="edit-input">
              <input type="hidden" name="eng_id" value="{{ id }}">
              <input type="hidden" name="original_eng" value="{{ eng_data }}">
              <input type="hidden" name="combined_heb" value="{{ combined_heb }}">
              <input type="hidden" name="combined_heb_niqqud" value="{{ combined_heb_niqqud }}">
            </td>
            <td style="font-size: 20px; text-align: right;">
              <span class="heb">{{ combined_heb }}</span>
              {{ search_count2|safe }}
            </td>
            <td class="morph-cell" style="font-size: 12px; width: 185px;">
              <input type="text" name="morphology" autocomplete="off" value="{{ morphology_raw }}" class="edit-input" style="width: 180px;">
              <input type="hidden" name="morph_id" value="{{ id }}">
              <input type="hidden" name="original_morphology" value="{{ morphology_raw }}">
              <div style="margin-top: 4px;">{{ morph_display|safe }}</div>
            </td>
            <td style="font-size: 12px;">
              {{ formatted_strongs_list|safe }}
            </td>
            <td>
              {{ footnote_btn|safe }}
            </td>
            <td>{{ color|safe }}{{ unique|safe }}</td>
            <td>
              <span class="heb">{{ combined_heb_niqqud }}</span>
              {{ search_count|safe }}
            </td>
            <td>
              <button type="button" class="map-lexicon-btn" 
                      data-hebrew-niqqud="{{ combined_heb_niqqud }}" 
                      data-hebrew-consonantal="{{ combined_heb }}" 
                      data-strongs="{{ strongs }}"
                      onclick="openMappingModal(this)">
                MAP LEXICON
              </button>
            </td>
          </tr>
          <tr>
            {{ footnote|safe }}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="paraphrase-editor-container">
    <h4>Paraphrase Editor</h4>
    
    <div id="englishReader">{{ english_reader|safe }}</div>
    
    <textarea name="html" id="textArea" autocomplete="off" oninput="updateEnglishReader(this.value)">{{ english_reader }}</textarea>
    
    <input type="hidden" name="verse_id" value="{{ verse_id }}">
    <input type="hidden" name="original_english_reader" value="{{ english_reader }}">
    
    <div class="editor-toolbar">
      <button type="button" onclick="applyFontStyle('italic'); updateEnglishReader(document.getElementById('textArea').value)" title="Italic">
        <i>I</i>
      </button>
      <button type="button" onclick="applyFontStyle('bold'); updateEnglishReader(document.getElementById('textArea').value)" title="Bold">
        <b>B</b>
      </button>
      <button type="button" onclick="applyCenterStyle(); updateEnglishReader(document.getElementById('textArea').value)" title="Center">
        <i class="fas fa-align-center"></i>
      </button>
      <button type="button" class="wide" onclick="applyLastCenterStyle(); updateEnglishReader(document.getElementById('textArea').value)" title="Center Last">
        <i class="fas fa-align-center"></i> Last
      </button>
      <button type="button" onclick="applyIndent(); updateEnglishReader(document.getElementById('textArea').value)" title="Indent">
        <i class="fas fa-indent"></i>
      </button>
      <button type="button" onclick="applyHayahStyle(); updateEnglishReader(document.getElementById('textArea').value)" title="Hayah Style">
        <i>היה</i>
      </button>
      <button type="button" style="background-color: red;" onclick="applyFontColor('red'); updateEnglishReader(document.getElementById('textArea').value)" title="Red"></button>
      <button type="button" style="background-color: #ff00aa;" onclick="applyFontColor('#ff00aa'); updateEnglishReader(document.getElementById('textArea').value)" title="Pink"></button>
      <button type="button" style="background-color: blue;" onclick="applyFontColor('blue'); updateEnglishReader(document.getElementById('textArea').value)" title="Blue"></button>
      <button type="button" onclick="applySunStyle(); updateReader(document.getElementById('editor-texto').value)" title="Sun Style">☀️</button>
      <button type="button" class="reset" onclick="resetText(); updateEnglishReader(document.getElementById('textArea').value)" title="Reset">
        <b>&#8630;</b>
      </button>
    </div>
    
    <div style="margin-top: 15px;">
      <input type="text" id="imageUrlInput" placeholder="Image URL" style="width: 100%; margin-bottom: 8px;">
      <button type="button" id="generate-code-button" style="width: 100%; padding: 8px; background: #b78550; color: #fff; border: none; border-radius: 4px; cursor: pointer; margin-bottom: 8px;">Insert Image</button>
      
      <input type="text" id="videoUrlInput" placeholder="Video URL" style="width: 100%; margin-bottom: 8px;">
      <button type="button" id="generate-video-button" style="width: 100%; padding: 8px; background: #b78550; color: #fff; border: none; border-radius: 4px; cursor: pointer;">Insert Video</button>
    </div>

    <div class="form-actions">
      <button type="submit">Save Changes</button>
      <label for="use_niqqud">
        <input type="checkbox" id="use_niqqud" name="use_niqqud" value="true">
        Use Niqqud
      </label>
    </div>
  </div>
</div>

</form>

<div class="chapter-reader-section">
  <h4>Chapter Reader</h4>
  {{ chapter_reader|safe }}
</div>

{% if updates %}
<div class="popup" id="popupDiv">
  <ul style="margin: 0; font-size: 14px; color: green;">
    {% for update in updates %}
    <li>{{ update }}</li>
    {% endfor %}
  </ul>
  <button class="close" type="button" onclick="closePopup()">Close</button>
</div>
{% endif %}

{% else %}
<div style="text-align: center; padding: 40px; background: #fff; border-radius: 8px; margin: 20px 0;">
  <h1 style="color: #dc3545;">No Rows Found</h1>
  <p>No rows matching the reference '{{ rbt_heb_ref }}' with a wildcard '*' at the end.</p>
</div>
{% endif %}

</div><!-- End page-wrapper -->


<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("generate-code-button").addEventListener("click", function () {
      var imageUrl = document.getElementById("imageUrlInput").value;
      var generatedCode = '<div class="tooltip-container"><img src="' + imageUrl + '" style="width: 500px; display: block; margin: 0 auto;">  <i class="touch-indicator fas fa-hand-pointer"></i><div class="tooltip">Image description.</div></div>';
      document.getElementById("textArea").value += generatedCode;
    });

    // Video insertion
    document.getElementById("generate-video-button").addEventListener("click", function() {
      let url = document.getElementById("videoUrlInput").value.trim();
      if (!url) return;
      let code = `<div class="tooltip-container"><video autoplay muted loop playsinline style="width:500px;display:block;margin:0 auto;border-radius:8px;"><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video><i class="touch-indicator fas fa-hand-pointer"></i><div class="tooltip"><p>Video description.</p></div></div>`;
      let textarea = document.getElementById("textArea");
      textarea.value += code;
    });
  });
</script>

<script>
  var originalText = '{{ english_verse|safe }}';

  function applyFontColor(color) {
    var textArea = document.getElementById('textArea');
    var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

    if (selectedText) {
      var coloredText = `<span style="color: ${color};">${selectedText}</span>`;
      var newText = textArea.value.substring(0, textArea.selectionStart) + coloredText + textArea.value.substring(textArea.selectionEnd);
      textArea.value = newText;
    }
  }

  function applySunStyle(style) {
            var textArea = document.getElementById('textArea');
            var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

            if (selectedText) {
                var styledText = `<div class="sun-icon">${selectedText}</div>`;
                var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
                textArea.value = newText;
            }
        }

  function applyFontStyle(style) {
      var textArea = document.getElementById('textArea');
      var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

      if (selectedText) {
          var styledText = selectedText;
          if (style.includes('italic')) {
              styledText = `<em>${styledText}</em>`;
          }
          if (style.includes('bold')) {
              styledText = `<strong>${styledText}</strong>`;
          }

          var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
          textArea.value = newText;
      }
    }

  function applyIndent() {
    var textArea = document.getElementById('textArea');
    var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

    if (selectedText) {
      var styledText = `<span class="poetry-indent">${selectedText}</span>`;
      var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
      textArea.value = newText;
    }
  }

  function applyLastCenterStyle() {
    var textArea = document.getElementById('textArea');
    var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

    if (selectedText) {
      var styledText = `<span class="last_center">${selectedText}</span>`;
      var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
      textArea.value = newText;
    }
  }

  function applyCenterStyle() {
    var textArea = document.getElementById('textArea');
    var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

    if (selectedText) {
      var styledText = `<span style="display: block; text-align: center;">${selectedText}</span>`;
      var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
      textArea.value = newText;
    }
  }

  function applyHayahStyle() {
    var textArea = document.getElementById('textArea');
    var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

    if (selectedText) {
      var styledText = `<span class="hayah">${selectedText}</span>`;
      var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
      textArea.value = newText;
    }
  }

  function resetText() {
    var textArea = document.getElementById('textArea');
    textArea.value = originalText;
    updateEnglishReader(originalText);
  }

  function updateEnglishReader(text) {
    var englishReader = document.getElementById('englishReader');
    englishReader.innerHTML = text;
  }

</script>


<script>
  window.onload = function () {
    var popupDiv = document.getElementById('popupDiv');
    if (popupDiv) {
      popupDiv.style.display = 'block';
    }
  }

  function closePopup() {
    document.getElementById('popupDiv').style.display = 'none';
  }
</script>

<script>
  var morphCodes = {
    'partOfSpeech': {
      'A': 'Adjective',
      'C': 'Conjunction',
      'D': 'Adverb',
      'N': 'Noun',
      'P': 'Pronoun',
      'R': 'Prep',
      'S': 'Suffix',
      'T': '',
      'V': 'Verb',
      'B': 'Prep-B',
      'K': 'Prep-K',
      'L': 'Prep-L'
    },
    'adjectiveType': {
      'a': '', // adjective
      'c': 'cardinal number',
      'g': 'gentilic',
      'o': 'ordinal number',
      'x': ''
    },
    'conjunctionType': {
      'c': 'conjunctive',
      'v': 'vav consecutive'
    },
    'nounType': {
      'c': '', // common
      'g': '', // gentilic
      'p': '', // proper name
      'x': '',
    },
    'pronounType': {
      'd': 'demonstrative',
      'f': 'indefinite',
      'i': 'interrogative',
      'p': 'personal',
      'r': 'relative',
      'x': ''
    },
    'suffixType': {
      'd': 'directional he',
      'h': 'paragogic he',
      'n': 'paragogic nun',
      'p': 'pronominal',
      'x': ''
    },
    'particleType': {
      'a': 'affirmation',
      'd': 'Art',
      'e': 'exhortation',
      'i': 'Int',
      'j': 'interjection',
      'm': 'demonstrative',
      'n': 'negative',
      'o': 'את',
      'p': 'Art with inseparable preposition',
      'r': 'Rel'
    },
    'verbStemHebrew': {
      'q': 'Qal',
      'N': 'Niphal',
      'p': 'Piel',
      'P': 'Pual',
      'h': 'Hiphil',
      'H': 'Hophal',
      't': 'Hithpael',
      'o': 'Polel',
      'O': 'Polal',
      'r': 'Hithpolel',
      'm': 'Poel',
      'M': 'Poal',
      'k': 'Palel',
      'K': 'Pulal',
      'Q': 'Qal passive',
      'l': 'Pilpel',
      'L': 'Polpal',
      'f': 'Hithpalpel',
      'D': 'Nithpael',
      'j': 'Pealal',
      'i': 'Pilel',
      'u': 'Hothpaal',
      'c': 'Tiphil',
      'v': 'Hishtaphel',
      'w': 'Nithpalel',
      'y': 'Nithpoel',
      'z': 'Hithpoel',
      'x': ''
    },
    'verbStemAramaic': {
      'q': 'peal',
      'Q': 'peil',
      'u': 'hithpeel',
      'N': 'niphal',
      'p': 'pael',
      'P': 'ithpaal',
      'M': 'hithpaal',
      'a': 'aphel',
      'h': 'haphel',
      's': 'saphel',
      'e': 'shaphel',
      'H': 'hophal',
      'i': 'ithpeel',
      't': 'hishtaphel',
      'v': 'ishtaphel',
      'w': 'hithaphel',
      'o': 'polel',
      'z': 'ithpoel',
      'r': 'hithpolel',
      'f': 'hithpalpel',
      'b': 'hephal',
      'c': 'tiphel',
      'm': 'poel',
      'l': 'palpel',
      'L': 'ithpalpel',
      'O': 'ithpolel',
      'G': 'ittaphal',
      'x': ''
    },
    'verbAspect': {
      'a': 'infinitive abs',
      'c': 'infinitive con',
      'h': 'cohortative',
      'i': 'imperfect',
      'j': 'jussive',
      'p': 'perfect',
      'q': 'sequential perfect',
      'r': 'participle active',
      's': 'participle passive',
      'v': 'imperative',
      'w': 'sequential imperfect',
      'x': ''
    },
    'adjCase': {
      'a': 'accusative',
      'n': 'nominative',
      'x': ''
    },
    'person': {
      '1': '1st',
      '2': '2nd',
      '3': '3rd',
      'x': ''
    },
    'gender': {
      'b': 'both',
      'c': 'common',
      'f': 'feminine',
      'm': 'masculine',
      'x': ''
    },
    'number': {
      'd': 'dual',
      'p': 'plural',
      's': 'singular',
      'x': ''
    },
    'state': {
      'a': 'absolute',
      'c': 'construct',
      'd': 'determined'
    },
    'language': {
      'H': 'Hebrew',
      'A': 'Aramaic'
    },
    'prepTypeK': {
      'd': '-Like Art',
    },
    'prepTypeB': {
      'd': '-Within Art',
    },
    'prepTypeL': {
      'd': '-For/Into Art',
    }
  }
</script>
<script>/**
* @fileOverview MorphParse is a parser for morphology codes,
* based on MorphCodes.js.
* @version 1.2
* @author David
*/
  var MorphParse = function () {
    var language;
    /**
     * Parses the given code.
     * @param {string} code A morph code
     * @returns (string} The morphology
     */
    this.Parse = function (code) {
      language = code.charAt(0);
      code = code.substring(1);
      var parts = code.split('/');
      var morph = parseCode(parts[0]);
      for (var i = 1; i < parts.length; i++) {
        morph += ', ' + parseCode(parts[i]);
      }
      return morph;
    };

    var parseCode = function (code) {
      // console.log('Original Code:', code);
      var pos = code.charAt(0);
      var morph = morphCodes.partOfSpeech[pos];

      if (code.length > 1) {
        switch (pos) {
          case 'A':
            morph += ' ' + parseAdjective(code);
            break;
          case 'C':
            morph += ' ' + parseConjunction(code);
            break;
          case 'N':
            // console.log('Parsing Noun:', code);
            morph += ' ' + parseNoun(code);
            break;
          case 'P':
            morph += ' ' + parsePronoun(code);
            break;
          case 'S':
            morph += ' ' + parseSuffix(code);
            break;
          case 'T':
            morph += ' ' + parseParticle(code);
            break;
          case 'V':
            morph += ' ' + parseVerb(code);
            break;
          case 'B':
            morph += ' ' + parsePrepB(code);
            break;
          case 'K':
            morph += ' ' + parsePrepK(code);
            break;


          default:
            morph += ' ' + code;
        }
      }
      return morph;
    };

    var parseAdjective = function (code) {
      var morph = morphCodes.adjectiveType[code.charAt(1)];
      if (code.length > 2) {
        morph += ' ' + parseGender(code, 2);
      }
      return morph;
    };

    var parseConjunction = function (code) {
      var morph = morphCodes.conjunctionType[code.charAt(1)];
      return morph;
    };

    var parseNoun = function (code) {
      if (code === 'Npl') {
        return 'Place';  
      }

      var morph = morphCodes.nounType[code.charAt(1)];
      if (code.length > 2) {
        morph += ' ' + parseGender(code, 2);
      }
      return morph;
    };

    var parsePronoun = function (code) {
      var morph = morphCodes.pronounType[code.charAt(1)];
      if (code.length > 2) {
        morph += ' ' + parseCase(code);
      }
      return morph;
    };

    var parseSuffix = function (code) {
      var morph = morphCodes.suffixType[code.charAt(1)];
      if (code.length > 2) {
        morph += ' ' + parsePerson(code, 2);
      }
      return morph;
    };

    var parseParticle = function (code) {
      if (code === 'Tc') {
        return 'Conj';  
      }
      var morph = morphCodes.particleType[code.charAt(1)];
      return morph;
    };

    var parseVerb = function (code) {
      var morph;
      if (language === 'H') {
        morph = morphCodes.verbStemHebrew[code.charAt(1)];
      } else {
        morph = morphCodes.verbStemAramaic[code.charAt(1)];
      }
      if (code.length > 2) {
        morph += ' ' + parseAspect(code);
      }
      return morph;
    };

    var parseAspect = function (code) {
      var morph = morphCodes.verbAspect[code.charAt(2)];
      if (code.length > 3) {
        morph += ' ' + parsePerson(code, 3);
      }
      return morph;
    };

    var parseCase = function (code) {
      var morph = morphCodes.adjCase[code.charAt(2)];
      if (morph === undefined) {
        morph = parsePerson(code, 2);
      } else if (code.length > 3) {
        morph += ' ' + parsePerson(code, 3);
      }
      return morph;
    };

    var parsePerson = function (code, pos) {
      var morph = morphCodes.person[code.charAt(pos)];
      if (morph === undefined) {
        morph = parseGender(code, pos);
      } else {
        pos++;
        if (code.length > pos) {
          morph += ' ' + parseGender(code, pos);
        }
      }

      return morph;
    };

    var parseGender = function (code, pos) {
      var morph = morphCodes.gender[code.charAt(pos)];
      pos++;
      if (code.length > pos) {
        morph += ' ' + parseNumber(code, pos);
      }
      return morph;
    };

    var parseNumber = function (code, pos) {
      var morph = morphCodes.number[code.charAt(pos)];
      pos++;
      if (code.length > pos) {
        morph += ' ' + parseState(code, pos);
      }
      return morph;
    };

    var parseState = function (code, pos) {
      var morph = morphCodes.state[code.charAt(pos)];
      return morph;
    };

    var parsePrepK = function (code) {
      var morph = morphCodes.prepTypeK[code.charAt(1)];

      return morph;
    };

    var parsePrepB = function (code) {
      var morph = morphCodes.prepTypeB[code.charAt(1)];
      return morph;
    };

    var parsePrepL = function (code) {
      var morph = morphCodes.prepTypeL[code.charAt(1)];
      return morph;
    };

  };
</script>
<script>

  mp = {
    code: null,
    parse: null,
    morph: null,
    parser: null,

    init: function () {
      code = document.getElementById("code");
      parse = document.getElementById("parse");
      morph = document.getElementById("morph");
      parser = new MorphParse();
      code.select();
    }(),

    parseClick: function () {
      var morphCode = code.value;
      morph.value = parser.Parse(morphCode);
    }
  }</script>

<script>
  // Initialize morph parsing after DOM is ready and handle missing elements safely
  document.addEventListener('DOMContentLoaded', function () {
    // If there is a popupDiv (updates list), ensure it's visible
    var popupDiv = document.getElementById('popupDiv');
    if (popupDiv) {
      popupDiv.style.display = 'block';
    }

    // Call the parseClick() function for each element with class "morph-cell"
    var morphCells = document.querySelectorAll('.morph-cell');
    morphCells.forEach(function (cell) {
      var codeInput = cell.querySelector('input[type="hidden"]'); // Find the hidden input element
      var morphDiv = cell.querySelector('.morph-popup'); // Find the div for displaying parsed morph

      // Defensive checks: skip if required nodes or API are missing
      if (!codeInput || !morphDiv) {
        return;
      }
      if (!mp || typeof mp.parseClick !== 'function') {
        return;
      }

      try {
        mp.parseClick(codeInput, morphDiv);
      } catch (err) {
        console.error('Morph parse error for cell:', cell, err);
      }
    });
  });

  var mp = {
    parser: null, // Define parser here

    init: function () {
      this.parser = new MorphParse(); // Initialize parser
    },

    parseClick: function (codeInput, morphDiv) {
      // Defensive: ensure inputs exist
      if (!codeInput || !morphDiv) {
        return;
      }

      // Ensure parser is initialized
      if (!this.parser || typeof this.parser.Parse !== 'function') {
        try {
          this.init();
        } catch (e) {
          console.error('Failed to initialize morph parser:', e);
          return;
        }
      }

      // Get the morph code value from the hidden input
      var morphCode = (codeInput.value || '').trim();
      try {
        // Parse the morph code using the parser defined within the object
        var parsedMorph = this.parser.Parse(morphCode);
        // Set the parsed value to the morph div (textContent for safety)
        morphDiv.textContent = parsedMorph;
      } catch (err) {
        console.error('Error parsing morph code:', morphCode, err);
      }
    }
  };

  // Initialize the mp object
  mp.init();
</script>

<!-- Manual Lexicon Mapping Modal -->
<div id="mappingModal" class="mapping-modal" style="display: none;">
  <div class="mapping-modal-content">
    <div class="mapping-modal-header">
      <h3>Manual Lexicon Mapping</h3>
      <button type="button" class="close-modal-btn" onclick="closeMappingModal()">×</button>
    </div>
    <div class="mapping-modal-body">
      <div class="mapping-info">
        <div class="mapping-info-row">
          <strong>Hebrew (with niqqud):</strong>
          <span id="modalHebrewNiqqud" style="font-size: 20px;"></span>
        </div>
        <div class="mapping-info-row">
          <strong>Hebrew (consonantal):</strong>
          <span id="modalHebrewConsonantal" style="font-size: 20px;"></span>
        </div>
        <div class="mapping-info-row">
          <strong>Strong's Number:</strong>
          <input type="text" id="modalStrongsInput" style="font-size: 1em; padding: 3px 8px; border: 1px solid #ccc; border-radius: 4px; width: 120px;" placeholder="e.g., H8176">
        </div>
      </div>

      <div class="mapping-search">
        <h4>Search Lexicon Entries</h4>
        <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
          <select id="lexiconTypeSelect" class="mapping-input">
            <option value="both">Both Lexicons</option>
            <option value="fuerst">Fürst Only</option>
            <option value="gesenius">Gesenius Only</option>
          </select>

          <select id="matchTypeSelect" class="mapping-input" title="Choose search mode">
            <option value="exact">Exact Match (Hebrew)</option>
            <option value="contains">Contains (partial)</option>
            <option value="root">Root</option>
            <option value="id">ID</option>
            <option value="strong">Strong's</option>
            <option value="definition">Definition</option>
          </select>

          <input id="searchTermInput" type="text" class="mapping-input" placeholder="Extra term: root / substring / id" />

          <button type="button" onclick="searchLexiconEntries()" class="mapping-btn mapping-btn-search">
            <i class="fas fa-search"></i> Search
          </button>
        </div>

        <div id="searchResults" class="search-results"></div>
      </div>

      <div class="mapping-actions">
        <button type="button" onclick="closeMappingModal()" class="mapping-btn mapping-btn-cancel">
          Cancel
        </button>
      </div>
    </div>
  </div>
</div>

<style>
.card-map-button {
  margin-top: 8px;
}

.map-lexicon-btn {
  font-size: 10px;
  padding: 3px 8px;
  background: #6c757d;
  color: #fff;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.map-lexicon-btn:hover {
  background: #5a6268;
  transform: translateY(-1px);
}

.map-lexicon-btn i {
  font-size: 9px;
  margin-right: 3px;
}

.mapping-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.mapping-modal-content {
  background: #fff;
  border-radius: 8px;
  max-width: 800px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.mapping-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 2px solid #b78550;
}

.mapping-modal-header h3 {
  margin: 0;
  font-size: 20px;
  color: #333;
}

.close-modal-btn {
  font-size: 32px;
  background: none;
  border: none;
  color: #666;
  cursor: pointer;
  line-height: 1;
  padding: 0;
  width: 32px;
  height: 32px;
}

.close-modal-btn:hover {
  color: #000;
}

.mapping-modal-body {
  padding: 20px;
}

.mapping-info {
  background: #f8f9fa;
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 20px;
}

.mapping-info-row {
  padding: 8px 0;
  display: flex;
  align-items: center;
  gap: 10px;
}

.mapping-info-row strong {
  min-width: 180px;
  color: #666;
  font-size: 13px;
}

.mapping-search h4 {
  margin: 0 0 15px 0;
  font-size: 16px;
  color: #333;
}

.mapping-input {
  flex: 1;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  font-size: 14px;
}

.mapping-btn {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.mapping-btn-search {
  background: #b78550;
  color: #fff;
}

.mapping-btn-search:hover {
  background: #965f35;
}

.mapping-btn-cancel {
  background: #6c757d;
  color: #fff;
}

.mapping-btn-cancel:hover {
  background: #5a6268;
}

.mapping-btn-add {
  background: #28a745;
  color: #fff;
  padding: 6px 12px;
  font-size: 12px;
}

.mapping-btn-add:hover {
  background: #218838;
}

.mapping-actions {
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid #ddd;
}

.search-results {
  max-height: 400px;
  overflow-y: auto;
}

.lexicon-result-section {
  margin-bottom: 20px;
}

.lexicon-result-section h5 {
  margin: 0 0 10px 0;
  font-size: 14px;
  color: #b78550;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.lexicon-entry-card {
  background: #f8f9fa;
  border: 1px solid #ddd;
  border-radius: 6px;
  padding: 12px;
  margin-bottom: 10px;
}

.lexicon-entry-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.lexicon-entry-hebrew {
  font-size: 18px;
  font-weight: 600;
  color: #333;
}

.lexicon-entry-meta {
  font-size: 12px;
  color: #666;
  margin-bottom: 8px;
}

.lexicon-entry-definition {
  font-size: 13px;
  color: #444;
  line-height: 1.4;
}

.no-results {
  text-align: center;
  padding: 40px;
  color: #999;
  font-style: italic;
}
</style>

<script>
let currentMappingData = {};

// Helper: strip Hebrew niqqud / vowels from a string
function stripHebrewVowels(s) {
  if (!s) return '';
  // Unicode ranges used for Hebrew diacritics and cantillation
  return s.replace(/[\u0591-\u05AF\u05B0-\u05BD\u05BF\u05C1-\u05C2\u05C4-\u05C5\u05C7]/g, '');
}

function openMappingModal(buttonElement) {
  // Read data from button's data attributes
  const hebrewNiqqud = buttonElement.getAttribute('data-hebrew-niqqud') || '';
  const hebrewConsonantal = buttonElement.getAttribute('data-hebrew-consonantal') || '';
  const strongsRaw = buttonElement.getAttribute('data-strongs') || '';
  
  // Extract first Strong's number from potentially concatenated string
  // Match pattern: H followed by digits (e.g., H8179)
  const strongsMatch = strongsRaw.match(/H\d+/);
  const firstStrongs = strongsMatch ? strongsMatch[0] : '';
  
  currentMappingData = {
    hebrew_niqqud: hebrewNiqqud,
    hebrew_consonantal: hebrewConsonantal
  };

  document.getElementById('modalHebrewNiqqud').textContent = hebrewNiqqud;
  document.getElementById('modalHebrewConsonantal').textContent = hebrewConsonantal;
  document.getElementById('modalStrongsInput').value = firstStrongs || '';

  // Prefill search term with consonantal root (strip vowels) and auto-select Root mode when it looks like Hebrew
  const prefill = stripHebrewVowels(hebrewNiqqud) || hebrewConsonantal || '';
  const searchInput = document.getElementById('searchTermInput');
  if (searchInput) {
    searchInput.value = prefill;
    // If the prefill contains Hebrew letters, pick the 'root' match mode as a convenience
    if (/[\u0590-\u05FF]/.test(prefill)) {
      const matchSelect = document.getElementById('matchTypeSelect');
      if (matchSelect) matchSelect.value = 'root';
    }
  }

  document.getElementById('mappingModal').style.display = 'flex';
  document.getElementById('searchResults').innerHTML = '';
}

function closeMappingModal() {
  document.getElementById('mappingModal').style.display = 'none';
  currentMappingData = {};
}

// Auto-detect Hebrew input in the search box and switch to Root mode
(function () {
  const searchInput = document.getElementById('searchTermInput');
  const matchSelect = document.getElementById('matchTypeSelect');
  if (!searchInput || !matchSelect) return;

  let debounce;
  searchInput.addEventListener('input', function () {
    clearTimeout(debounce);
    debounce = setTimeout(() => {
      const val = searchInput.value.trim();
      if (!val) return;
      // If the user typed Hebrew letters (likely a root), auto-switch to root mode
      if (/^[\u0590-\u05FF\s]+$/.test(val)) {
        matchSelect.value = 'root';
        // normalize by stripping niqqud for convenience
        const stripped = stripHebrewVowels(val);
        if (stripped !== val) searchInput.value = stripped;
      }
    }, 150);
  });
})();

async function searchLexiconEntries() {
  const lexiconType = document.getElementById('lexiconTypeSelect').value;
  const matchType = document.getElementById('matchTypeSelect').value;
let searchTerm = document.getElementById('searchTermInput').value.trim();
    const resultsDiv = document.getElementById('searchResults');

    // If user entered Hebrew in the search field and the match mode is root or auto-detected, strip niqqud client-side
    if (searchTerm && /[\u0590-\u05FF]/.test(searchTerm)) {
      searchTerm = stripHebrewVowels(searchTerm);
    }

  resultsDiv.innerHTML = '<div class="no-results"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';

  try {
    // Get Strong's number from editable input
    const strongsNumber = document.getElementById('modalStrongsInput').value.trim();

    const params = new URLSearchParams({
      hebrew: currentMappingData.hebrew_niqqud || currentMappingData.hebrew_consonantal || '',
      strong: strongsNumber,
      lexicon: lexiconType,
      match: matchType,
      search: searchTerm
    });

    const response = await fetch(`/translate/api/search-lexicon/?${params}`);
    const data = await response.json();

    if (data.error) {
      resultsDiv.innerHTML = `<div class="no-results" style="color: #dc3545;">${data.error}</div>`;
      return;
    }

    let html = '';

    // Display Fürst results
    if (data.fuerst && data.fuerst.length > 0) {
      html += '<div class="lexicon-result-section">';
      html += '<h5>Fürst Lexicon</h5>';
      data.fuerst.forEach(entry => {
        html += renderLexiconEntry(entry, 'fuerst');
      });
      html += '</div>';
    }

    // Display Gesenius results
    if (data.gesenius && data.gesenius.length > 0) {
      html += '<div class="lexicon-result-section">';
      html += '<h5>Gesenius Lexicon</h5>';
      data.gesenius.forEach(entry => {
        html += renderLexiconEntry(entry, 'gesenius');
      });
      html += '</div>';
    }

    if (!html) {
      html = '<div class="no-results">No matching entries found. Try adjusting your search or try a different match mode.</div>';
    }

    resultsDiv.innerHTML = html;

  } catch (error) {
    console.error('Search error:', error);
    resultsDiv.innerHTML = '<div class="no-results" style="color: #dc3545;">Search failed. Please try again.</div>';
  }
}

function renderLexiconEntry(entry, lexiconType) {
  const idField = lexiconType === 'fuerst' ? 'id' : 'id';
  const entryId = entry[idField];
  
  // Escape HTML to prevent XSS and template string issues
  const escapeHtml = (text) => {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  };
  
  const hebrewText = escapeHtml(entry.hebrew_word || entry.hebrew_consonantal);
  const partOfSpeech = entry.part_of_speech ? escapeHtml(entry.part_of_speech) + ' • ' : '';
  const root = entry.root ? 'Root: ' + escapeHtml(entry.root) + ' • ' : '';
  const sourcePage = entry.source_page ? 'Page: ' + escapeHtml(entry.source_page) : '';
  const definition = escapeHtml(entry.definition || 'No definition available');
  
  // Create the card element
  const cardHtml = `
    <div class="lexicon-entry-card">
      <div class="lexicon-entry-header">
        <div class="lexicon-entry-hebrew">${hebrewText}</div>
        <button type="button" class="mapping-btn mapping-btn-add" 
                data-lexicon-id="${escapeHtml(String(entryId))}" 
                data-lexicon-type="${escapeHtml(lexiconType)}">
          <i class="fas fa-plus"></i> Add Mapping
        </button>
      </div>
      <div class="lexicon-entry-meta">
        ${partOfSpeech}${root}${sourcePage}
      </div>
      <div class="lexicon-entry-definition">${definition}</div>
    </div>
  `;
  
  return cardHtml;
}

// Delegate click events for dynamically created buttons
document.addEventListener('click', function(e) {
  if (e.target.closest('.mapping-btn-add')) {
    const btn = e.target.closest('.mapping-btn-add');
    const lexiconId = btn.getAttribute('data-lexicon-id');
    const lexiconType = btn.getAttribute('data-lexicon-type');
    addMapping(lexiconId, lexiconType);
  }
});

async function addMapping(lexiconId, lexiconType) {
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  
  // Parse lexiconId as integer, removing any non-numeric prefix
  const numericId = parseInt(String(lexiconId).replace(/\D/g, ''), 10);
  
  if (isNaN(numericId)) {
    alert('Invalid lexicon ID: ' + lexiconId);
    return;
  }
  
  // Get Strong's number from editable input
  const strongsNumber = document.getElementById('modalStrongsInput').value.trim();
  
  if (!strongsNumber) {
    alert('Please enter a Strong\'s number');
    return;
  }
  
  // Global mappings only - no book/chapter/verse specificity
  const payload = {
    hebrew_word: currentMappingData.hebrew_niqqud,
    strong_number: strongsNumber,
    lexicon_type: lexiconType,
    book: null,
    chapter: null,
    verse: null,
    notes: 'Global manual mapping for similar lexemes'
  };
  
  if (lexiconType === 'fuerst') {
    payload.fuerst_id = numericId;
  } else {
    payload.gesenius_id = numericId;
  }
  
  try {
    const response = await fetch('/translate/api/add-manual-lexicon-mapping/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrfToken
      },
      body: JSON.stringify(payload)
    });
    
    const data = await response.json();
    
    if (data.success) {
      alert('✓ Mapping added successfully! You can add more mappings or close the modal.');
    } else {
      alert('Error: ' + (data.error || 'Failed to add mapping'));
    }
  } catch (error) {
    console.error('Add mapping error:', error);
    alert('Failed to add mapping. Please try again.');
  }
}

// Close modal on escape key
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape' && document.getElementById('mappingModal').style.display === 'flex') {
    closeMappingModal();
  }
});
</script>

{% endblock %}