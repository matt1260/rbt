{% extends 'base.html' %}
{% load custom_tags %}
{% block content %}
<p><a href="./">Back to Edit Search</a></p>

<!-- Font Awesome already loaded in base; removed duplicate to avoid extra render delay -->
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>

<script>
    $(document).ready(function () {
      // Function to update dynamic content
      function updateDynamicContent() {
        // Get the value from the input field
        var inputValue = $('#footnote_id').val();
  
        // Update the content of the span element
        $('#dynamic_content').text(inputValue);
      }
  
      // Attach an event listener to the input field to detect changes
      $('#footnote_id').on('input', updateDynamicContent);
    });
  </script>
  <script>
    function copyText() {
        // Get the text from rbt_display
        var rbtText = document.querySelector('.single_verse').innerText;

        // Replace dashes with spaces
        var editedParaphraseText = rbtText.replace(/-/g, ' ');

        // Remove the word 'becoming' from the text
        editedParaphraseText = editedParaphraseText.replace(/\bbecoming\b/g, '');

        // Replace 'אֶת' with 'eternal self'
        editedParaphraseText = editedParaphraseText.replace(/אֶת/g, 'self eternal');

        // Replace 'את' with 'eternal self with'
        editedParaphraseText = editedParaphraseText.replace(/את/g, 'self eternal with');

        // Replace 'elohim' with 'mighty ones'
        editedParaphraseText = editedParaphraseText.replace(/elohim/g, 'mighty ones');

        // Replace 'heavens' with 'mighty ones'
        editedParaphraseText = editedParaphraseText.replace(/heavens/g, 'heavenly ones');

        editedParaphraseText = editedParaphraseText.replace(/Heavens/g, 'Heavenly ones');

        // Replace 'Waters' with 'mighty ones'
        editedParaphraseText = editedParaphraseText.replace(/Waters/g, 'Waters');

        // Replace 'whole' with 'all'
        editedParaphraseText = editedParaphraseText.replace(/the whole/g, 'all');

        // Replace 'is saying' with 'say'
        editedParaphraseText = editedParaphraseText.replace(/is saying/g, 'is saying');

        // Remove numbers from the text
        editedParaphraseText = editedParaphraseText.replace(/\d+/g, '');

        // Set the modified text in the edited_paraphrase textarea
        document.getElementById('edited_paraphrase').value = editedParaphraseText;
    }
</script>
  
  
<style>
    textarea {
    height: 230px;
    }

    /* Style for the green notice bar */
    .notice-bar {
        background-color: #7BD77F;
        color: white;
        font-size: 14px;
        text-align: left;
        padding: 4px; 
        border-radius: 5px; 
        font-family: sans-serif;

    }

    /* Style for the checkmark icon */
    .icon {
        margin-right: 10px; /* Add space between the icon and text */
        margin-left: 5px;
    }

    .hdr-icon {
        display: inline-block;
        font-weight: 700;
        line-height: 1;
        font-size: 20px;
        margin: 0 6px;
        vertical-align: middle;
    }

    .hdr-icon.hebrew {
        font-family: 'Times New Roman', serif;
        color: #6b1e1e;
    }
</style>

<style>
    .gemini-trigger {
        margin-top: 8px;
        background: #17324f;
        color: #fff;
        border: none;
        padding: 8px 14px;
        border-radius: 6px;
        cursor: pointer;
    }

    .gemini-trigger:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .gemini-modal {
        position: fixed;
        inset: 0;
        background: rgba(9, 18, 36, 0.6);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }

    .gemini-modal.is-visible {
        display: flex;
    }

    .gemini-modal__content {
        background: #fff;
        border-radius: 12px;
        padding: 20px;
        width: min(600px, 90%);
        box-shadow: 0 20px 45px rgba(10, 26, 56, 0.25);
    }

    .gemini-modal__content textarea {
        width: 100%;
        min-height: 200px;
        border: 1px solid #d5dbe4;
        border-radius: 8px;
        padding: 10px;
        font-size: 14px;
        font-family: 'Courier New', Courier, monospace;
    }

    .gemini-modal__actions {
        margin-top: 16px;
        display: flex;
        justify-content: flex-end;
        gap: 10px;
    }

    .gemini-modal__actions button {
        border: none;
        border-radius: 6px;
        padding: 6px 12px;
        cursor: pointer;
    }

    .gemini-modal__actions .primary {
        background: #0c63ff;
        color: #fff;
    }

    .gemini-modal__actions .secondary {
        background: #e2e8f0;
        color: #1f2933;
    }

    .gemini-modal__status {
        margin-top: 8px;
        font-size: 13px;
        color: #a32a1a;
    }

    .gemini-modal__field {
        margin-bottom: 12px;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .gemini-modal__field label {
        font-size: 13px;
        font-weight: 600;
        color: #12223b;
    }

    .gemini-modal__field input {
        border: 1px solid #d5dbe4;
        border-radius: 6px;
        padding: 6px 8px;
        font-size: 14px;
    }
</style>

<style>
    .genesis-editor {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .panel {
        background: #fff;
        border: 1px solid #d5dbe4;
        border-radius: 10px;
        padding: 16px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
    }

    .interlinear-panel {
        overflow: visible;
        position: relative;
    }

    .chapter-switcher {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
    }

    .chapter-switcher__label {
        font-size: 14px;
        font-weight: 600;
        color: #12223b;
    }

    .chapter-links {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 6px;
    }

    .chapter-links a {
        padding: 4px 10px;
        border-radius: 6px;
        border: 1px solid #d5dbe4;
        font-size: 13px;
        color: #0f172a;
        text-decoration: none;
        transition: background 0.2s ease;
    }

    .chapter-links a:hover {
        background: #e4ecf7;
    }

    .status-banner {
        margin-bottom: 4px;
    }

    .editor-grid {
        display: grid;
        grid-template-columns: minmax(0, 1fr);
        gap: 24px;
    }

    .genesis-tools-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 20px;
    }

    .hebrewdata-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 12px;
    }

    .hebrewdata-table th,
    .hebrewdata-table td {
        border-bottom: 1px solid #e2e8f0;
        padding: 6px 8px;
        vertical-align: top;
    }

    .hebrewdata-table th {
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-size: 10px;
        color: #475569;
        font-weight: 600;
        background: #f8fafc;
    }

    .token-hebrew {
        font-size: 18px;
        text-align: right;
        line-height: 1.2;
    }

    .token-ordinal {
        font-size: 10px;
        color: #64748b;
        margin-top: 2px;
        line-height: 1.3;
    }

    .hebrewdata-table input[type="text"],
    .hebrewdata-table textarea {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 4px;
        padding: 4px 6px;
        font-size: 12px;
        line-height: 1.4;
    }

    .hebrewdata-table textarea {
        min-height: 42px;
        max-height: 80px;
        resize: vertical;
        font-family: inherit;
    }

    .hebrewdata-meta {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 12px;
        color: #475569;
    }

    .hebrewdata-actions {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
    }

    .hebrewdata-actions button {
        padding: 6px 12px;
        border-radius: 5px;
        border: none;
        background: #0c63ff;
        color: #fff;
        font-weight: 600;
        font-size: 13px;
        cursor: pointer;
    }

    .hebrewdata-table-wrapper {
        margin-top: 8px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
    }

    .interlinear-table {
        width: 100%;
        border-collapse: collapse;
    }

    .interlinear-table td {
        border: 1px solid #e2e8f0;
        padding: 6px 8px;
        text-align: center;
    }

    .hebrew-large {
        font-size: 28px;
        text-align: right;
        margin-bottom: 12px;
    }

    .hebrew-interlinear-section {
        margin-top: 12px;
    }

    .interlinear-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        font-size: 13px;
        color: #12223b;
        align-items: center;
        margin-bottom: 12px;
    }

    .interlinear-controls__font {
        margin-left: auto;
        font-size: 13px;
        color: #12223b;
    }

    .hebrew-interlinear-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: flex-start;
        direction: rtl;
    }

    .interlinear-card {
        background: #f6f7fa;
        border: 1px solid #d9dee6;
        border-radius: 8px;
        padding: 12px 14px;
        min-width: 110px;
        max-width: 160px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
        flex: 0 1 auto;
    }

    .interlinear-card .card-hebrew {
        font-size: 28px;
        line-height: 1.3;
        text-align: right;
    }

    .card-hebrew > span {
        display: block;
    }

    .card-hebrew .hebrew-with-niqqud {
        display: none;
    }

    .interlinear-card .card-english,
    .interlinear-card .card-strongs,
    .interlinear-card .card-morph,
    .interlinear-card .card-lxx {
        direction: ltr;
        text-align: left;
        margin-top: 6px;
    }

    .interlinear-card .card-english {
        font-size: 14px;
        color: #2d2d2d;
    }

    .interlinear-card .card-strongs {
        font-size: 12px;
        color: #4a4a4a;
    }

    .interlinear-card .card-morph {
        font-size: 11px;
        color: #6d6d6d;
    }

    .interlinear-card .card-lxx {
        font-size: 13px;
        color: #2e5984;
    }

    .interlinear-card .card-lxx a {
        color: #2e5984;
        text-decoration: none;
    }

    .interlinear-card .card-lxx a:hover {
        text-decoration: underline;
    }

    .popup-container {
        position: relative;
        display: inline-block;
    }

    .popup-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        background-color: #fff;
        border: 1px solid #e3e6ea;
        padding: 10px;
        box-shadow: 0 6px 20px rgba(18, 38, 63, 0.08);
        z-index: 200;
        width: 320px;
        font-size: 13px;
        text-align: left;
        border-radius: 8px;
        opacity: 0;
        transform: translateY(-6px);
        transition: opacity 0.12s ease, transform 0.12s ease;
    }

    .popup-container:hover .popup-content {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .lxx-popup-container {
        position: relative;
        display: inline-block;
        cursor: help;
    }

    .lxx-popup-content {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        background-color: #fff;
        border: 1px solid #ccc;
        padding: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        z-index: 100;
        width: 250px;
        font-size: 12px;
        text-align: left;
        border-radius: 4px;
        margin-bottom: 5px;
    }

    .lxx-popup-content .lxx-popup-header {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 2px;
        color: #333;
    }

    .lxx-popup-content .lxx-popup-header a {
        color: #2e5984;
        text-decoration: none;
        margin-left: 4px;
    }

    .lxx-popup-content .lxx-popup-header a:hover {
        text-decoration: underline;
    }

    .lxx-popup-content::after {
        content: "Greek translations of this Hebrew word in the Septuagint. This helps us understand how ancient translators interpreted the Hebrew text c. 250 BCE.";
        display: block;
        font-size: 10px;
        color: #888;
        margin-bottom: 6px;
        padding-bottom: 4px;
        border-bottom: 1px solid #eee;
    }

    .lxx-popup-container:hover .lxx-popup-content {
        display: block;
    }

    .lxx-stats-section {
        margin-top: 6px;
        padding-top: 4px;
        border-top: 1px dotted #ddd;
    }

    .lxx-stats-section .strongs-label {
        font-weight: 600;
        color: #555;
        font-size: 11px;
    }

    .lxx-stats-row {
        font-size: 11px;
        color: #444;
        line-height: 1.6;
        margin-bottom: 4px;
    }

    .lxx-stats-row .stat-label {
        display: inline-block;
        min-width: 80px;
        direction: ltr;
    }

    .lxx-stats-row .stat-label a {
        color: #2e5984;
        text-decoration: none;
    }

    .lxx-stats-row .stat-label a:hover {
        text-decoration: underline;
    }

    .lxx-stats-row .stat-bar-container {
        display: inline-block;
        width: 80px;
        height: 10px;
        background: #e9ecef;
        border-radius: 3px;
        margin: 0 6px;
        vertical-align: middle;
    }

    .lxx-stats-row .stat-bar {
        display: block;
        height: 100%;
        background: linear-gradient(90deg, #4a90a4, #2e5984);
        border-radius: 3px;
        min-width: 2px;
    }

    .lxx-stats-row .stat-info {
        font-size: 10px;
        color: #666;
    }

    .strongs-trigger,
    .fuerst-trigger {
        font-size: 10px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 600;
        color: #7a2f11;
        background: linear-gradient(120deg, #fff7f2, #ffe9df);
        border: 1px solid #f1c7b2;
        border-radius: 999px;
        padding: 2px 7px;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .strongs-trigger:hover,
    .strongs-trigger:focus,
    .fuerst-trigger:hover,
    .fuerst-trigger:focus {
        background: linear-gradient(120deg, #ffe1d0, #ffd2bb);
        color: #5c210c;
        border-color: #e4a583;
    }

    .strongs-popup {
        display: inline-flex;
        align-items: center;
        margin-right: 6px;
    }

    .strongs-popup-content,
    .fuerst-popup-content {
        display: none;
        position: absolute;
        top: 100%;
        left: -180px;
        width: 360px;
        background-color: #fff;
        border: 1px solid #f2d7c8;
        padding: 10px;
        box-shadow: 0 6px 20px rgba(18, 38, 63, 0.08);
        z-index: 200;
        font-size: 13px;
        text-align: left;
        border-radius: 8px;
        opacity: 0;
        transform: translateY(-6px);
        transition: opacity 0.12s ease, transform 0.12s ease;
    }

    .strongs-popup:hover .strongs-popup-content,
    .fuerst-popup:hover .fuerst-popup-content {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .strongs-entry,
    .fuerst-entry {
        padding: 8px 0;
        border-top: 1px dashed #f1d7c7;
    }

    .strongs-entry:first-of-type,
    .fuerst-entry:first-of-type {
        border-top: none;
        padding-top: 0;
    }

    .strongs-headword,
    .fuerst-headword {
        font-size: 20px;
        font-weight: 600;
        color: #1f2d3d;
    }

    .strongs-meta,
    .fuerst-meta {
        font-size: 11px;
        color: #6b4b3d;
        margin-top: 4px;
    }

    .strongs-definition,
    .strongs-derivation,
    .strongs-exhaustive,
    .fuerst-definition {
        font-size: 13px;
        color: #2f3a44;
        margin-top: 6px;
        line-height: 1.4;
    }

    .strongs-definition strong,
    .strongs-derivation strong,
    .strongs-exhaustive strong {
        font-weight: 600;
        font-size: 11px;
        color: #6b4b3d;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        display: block;
        margin-bottom: 2px;
    }

    .strongs-link {
        color: #a4491d;
        text-decoration: none;
        font-weight: 600;
    }

    .strongs-link:hover {
        text-decoration: underline;
    }

    .gesenius-trigger {
        font-size: 10px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 600;
        color: #7a2f11;
        background: linear-gradient(120deg, #fff7f2, #ffe9df);
        border: 1px solid #f1c7b2;
        border-radius: 999px;
        padding: 2px 7px;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .gesenius-trigger:hover,
    .gesenius-trigger:focus {
        background: linear-gradient(120deg, #ffe1d0, #ffd2bb);
        color: #5c210c;
        border-color: #e4a583;
    }

    .gesenius-popup {
        display: inline-flex;
        align-items: center;
        margin-left: 6px;
    }

    .gesenius-popup-content {
        display: none;
        position: absolute;
        top: 100%;
        left: -150px;
        width: 300px;
        background-color: #fff;
        border: 1px solid #f2d7c8;
        padding: 10px;
        box-shadow: 0 6px 20px rgba(18, 38, 63, 0.08);
        z-index: 200;
        font-size: 13px;
        text-align: left;
        border-radius: 8px;
        opacity: 0;
        transform: translateY(-6px);
        transition: opacity 0.12s ease, transform 0.12s ease;
    }

    .gesenius-popup:hover .gesenius-popup-content {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .gesenius-entry {
        padding: 8px 0;
        border-top: 1px dashed #f1d7c7;
    }

    .gesenius-entry:first-of-type {
        border-top: none;
        padding-top: 0;
    }

    .gesenius-headword {
        font-size: 20px;
        font-weight: 600;
        color: #1f2d3d;
    }

    .gesenius-meta {
        font-size: 11px;
        color: #6b4b3d;
        margin-top: 4px;
    }

    .gesenius-definition {
        font-size: 13px;
        color: #2f3a44;
        margin-top: 6px;
        line-height: 1.4;
    }

    .gesenius-note {
        font-size: 12px;
        color: #4b2b1f;
        background: #fff5ee;
        border-left: 3px solid #f3c2a7;
        padding: 4px 6px;
        margin-top: 6px;
    }

    .gesenius-link {
        color: #a4491d;
        text-decoration: none;
        font-weight: 600;
    }

    .gesenius-link:hover {
        text-decoration: underline;
    }

    /* BDB trigger styling */
    .bdb-trigger {
        font-size: 10px;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        font-weight: 600;
        color: #7a2f11;
        background: linear-gradient(120deg, #fff7f2, #ffe9df);
        border: 1px solid #f1c7b2;
        border-radius: 999px;
        padding: 2px 7px;
        cursor: pointer;
        transition: background 0.15s ease, color 0.15s ease, border-color 0.15s ease;
    }

    .bdb-trigger:hover,
    .bdb-trigger:focus {
        background: linear-gradient(120deg, #ffe1d0, #ffd2bb);
        color: #5c210c;
        border-color: #e4a583;
    }

    .bdb-popup-content {
        width: 400px;
        left: -200px;
    }

    /* BDB detailed styling (match Fuerst/Gesenius) */
    .bdb-popup { display:inline-flex; align-items:center; margin-left:6px; }
    .bdb-title { font-size:12px; font-weight:700; text-transform:uppercase; letter-spacing:0.08em; color:#9a4a26; margin-bottom:8px; }
    .bdb-entry { padding:8px 0; border-top:1px dashed #f1d7c7; }
    .bdb-entry:first-of-type { border-top:none; padding-top:0; }
    .bdb-definition { font-size:13px; color:#2f3a44; line-height:1.5; }
    .bdb-definition p { margin:6px 0; }
    .bdb-definition strong, .bdb-definition b { font-weight:600; color:#1f2d3d; }
    .bdb-definition em, .bdb-definition i { font-style:italic; color:#4b2b1f; }
    .bdb-definition a { color:#a4491d; text-decoration:none; font-weight:600; }
    .bdb-definition a:hover { text-decoration:underline; }

    /* BDB headings and list styles */
    .bdb-definition h3,
    .bdb-definition h4,
    .bdb-definition h5,
    .bdb-definition h6 {
        color: #1f2d3d;
        margin-top: 10px;
        margin-bottom: 6px;
        line-height: 1.2;
    }
    .bdb-definition h3 { font-size: 16px; }
    .bdb-definition h4 { font-size: 15px; }
    .bdb-definition h5 { font-size: 14px; letter-spacing: 0.02em; }
    .bdb-definition h6 { font-size: 13px; }

    .bdb-definition .headword { font-weight:700; font-size:16px; color:#2a1f18; }
    .bdb-definition .cognates { margin-left:20px; font-size:0.95em; color:#4b2b1f; margin-top:4px; }
    .bdb-definition ol, .bdb-definition ul { margin-left:18px; margin-bottom:8px; }
    .bdb-definition li { margin-bottom:6px; }
    .bdb-strongs-ref { font-size:12px; color:#6b4b3d; margin-bottom:6px; }

    .chapter-cache {
        font-size: 12px;
        color: #475569;
    }

    .map-lexicon-btn {
        font-size: 10px;
        padding: 4px 8px;
        background: #6c757d;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .map-lexicon-btn:hover {
        background: #5a6268;
        transform: translateY(-1px);
    }

    .mapping-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .mapping-modal-content {
        background: #fff;
        border-radius: 8px;
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .mapping-modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px;
        border-bottom: 2px solid #b78550;
    }

    .mapping-modal-header h3 {
        margin: 0;
        font-size: 20px;
        color: #333;
    }

    .close-modal-btn {
        font-size: 32px;
        background: none;
        border: none;
        color: #666;
        cursor: pointer;
        line-height: 1;
        padding: 0;
        width: 32px;
        height: 32px;
    }

    .close-modal-btn:hover {
        color: #000;
    }

    .mapping-modal-body {
        padding: 20px;
    }

    .mapping-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
    }

    .mapping-info-row {
        padding: 8px 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .mapping-info-row strong {
        min-width: 180px;
        color: #666;
        font-size: 13px;
    }

    .mapping-search h4 {
        margin: 0 0 15px 0;
        font-size: 16px;
        color: #333;
    }

    .mapping-input {
        flex: 1;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .mapping-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .mapping-btn-search {
        background: #b78550;
        color: #fff;
    }

    .mapping-btn-search:hover {
        background: #965f35;
    }

    .mapping-btn-cancel {
        background: #6c757d;
        color: #fff;
    }

    .mapping-btn-cancel:hover {
        background: #5a6268;
    }

    .mapping-btn-add {
        background: #28a745;
        color: #fff;
        padding: 6px 12px;
        font-size: 12px;
    }

    .mapping-btn-add:hover {
        background: #218838;
    }

    .mapping-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
    }

    .search-results {
        max-height: 400px;
        overflow-y: auto;
    }

    .lexicon-result-section {
        margin-bottom: 20px;
    }

    .lexicon-result-section h5 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #b78550;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .lexicon-entry-card {
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 10px;
    }

    .lexicon-entry-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .lexicon-entry-hebrew {
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

    .lexicon-entry-meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 8px;
    }

    .lexicon-entry-definition {
        font-size: 13px;
        color: #444;
        line-height: 1.4;
    }

    .no-results {
        text-align: center;
        padding: 40px;
        color: #999;
        font-style: italic;
    }

    @media (min-width: 1100px) {
        .editor-grid {
            grid-template-columns: minmax(0, 0.6fr) minmax(0, 0.4fr);
        }
    }

    @media (max-width: 640px) {
        .chapter-links a {
            padding: 4px 6px;
        }

        .interlinear-card {
            min-width: 90px;
            max-width: 140px;
            padding: 8px 10px;
        }

        .interlinear-card .card-hebrew {
            font-size: 22px;
        }
    }
</style>



<div class="genesis-editor">
<div class="chapter-switcher panel">
    <div>
        <span class="chapter-switcher__label">Genesis Chapters</span>
        <div class="chapter-links">{{ chapters|safe }}</div>
    </div>
    <div class="chapter-cache">Cached: {{ cached_hit }}</div>
</div>

<div class="arrow-links panel">
    <h3>
        <a href="{{ previous_verse }}"><i class="fas fa-chevron-circle-left"></i></a>
        {{ book }} {{ chapter_num }}:{{ verse_num }}<a href="{{ next_verse }}"><i class="fas fa-chevron-circle-right"></i></a>
    </h3>
    <div class="verse-jump-form">
        <span>Skip to verse:</span>
        <form method="post" action="./" id="verse-jump-form">
            {% csrf_token %}
            <input id="verse_input" name="verse_input" maxlength="2" size="2">
            <input type="hidden" name="book" value="{{ book }}">
            <input type="hidden" name="chapter" value="{{ chapter_num }}">
            <button type="submit" id="go-button">Go</button>
        </form>
    </div>
</div>

{% if edit_result %}
<div class="status-banner">
    {{ edit_result|safe }}
</div>
{% endif %}

<h4>Verse</h4>
<div style="display: flex; justify-content: flex-end;">
    <label for="niqqudSwitch" style="font-size: 12px;">Show Niqqud &nbsp</label>
    <input type="checkbox" id="niqqudSwitch" onclick="toggleNiqqud()">
</div>
<div>
    <div style="display: flex; justify-content: flex-end;">
        <div style="font-size: 28px;text-align: right;" id="hebText"></div>
    </div>
</div>
 
</div>

<script>
    // Assuming you have already defined the 'rbt_heb' variable from Python
    var rbt_heb = `{{ hebrew | safe }}`;  // To safely pass the Python variable to JavaScript

    // Function to remove niqqud characters from the Hebrew text
    function removeNiqqud(text) {
        // Regular expression pattern to match niqqud characters
        var niqqudPattern = /[\u0591-\u05BD\u05BF\u05C1-\u05C5\u05C7]/g;
        return text.replace(niqqudPattern, '');
    }

    // Function to toggle the niqqud visibility based on the checkbox state
    function toggleNiqqud() {
        var hebText = document.getElementById("hebText");
        var niqqudSwitch = document.getElementById("niqqudSwitch");

        if (niqqudSwitch.checked) {
            hebText.innerHTML = rbt_heb;
        } else {
            hebText.innerHTML = removeNiqqud(rbt_heb);
        }
    }

    // Initially, set the innerHTML to the original rbt_heb content with niqqud removed
    document.getElementById("hebText").innerHTML = removeNiqqud(rbt_heb);
</script>

<strong>RBT Translation:</strong><br>
 <div class="single_verse">{{ rbt_display|safe }}</div>   
   
<form method="post" action="./" id="literal-form" class="panel">            
    {% csrf_token %}
    <textarea id="editor-texto" name="edited_content" rows="4" cols="80">{{ rbt|safe }}</textarea>
    <input type="hidden" name="record_id" value="{{ record_id }}">
    <input type="hidden" name="book" value="{{ book }}">
    <input type="hidden" name="chapter" value="{{ chapter_num }}">
    <input type="hidden" name="verse" value="{{ verse_num }}"><br>
    <button type="submit" id="save-button">Save</button>
    <button type="button" id="hebrew-hdr-editor" title="Hebrew header" aria-label="Hebrew header"><span class="hdr-icon hebrew">א</span></button>
</form>

<div id="hebrew-gemini-config"
    data-book="{{ book2|default:book }}"
    data-chapter="{{ chapter_num }}"
    data-verse="{{ verse_num }}"
    data-endpoint="{% url 'gemini_translate_api' %}"
    data-translation-type="hebrew"
    data-default-model="{{ default_gemini_model }}"
    data-save-endpoint="{% url 'gemini_save_preferences' %}"
    hidden></div>

<div class="gemini-modal" id="hebrewGeminiModal" aria-hidden="true">
    <div class="gemini-modal__content">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 10px;">
            <h3 style="margin:0;">Gemini Prompt</h3>
            <button type="button" class="secondary" data-action="close">&times;</button>
        </div>
        <div class="gemini-modal__field">
            <label for="hebrewGeminiModel">Model</label>
            <input type="text" id="hebrewGeminiModel" autocomplete="off">
        </div>
        <textarea id="hebrewGeminiPrompt" spellcheck="false"></textarea>
        <div class="gemini-modal__actions">
            <button type="button" class="secondary" id="hebrewGeminiReset">Reset</button>
            <button type="button" class="secondary" id="hebrewGeminiSave">Save Prompt</button>
            <button type="button" class="secondary" data-action="close">Cancel</button>
            <button type="button" class="primary" id="hebrewGeminiRun">Run &amp; Load</button>
        </div>
        <div class="gemini-modal__status" id="hebrewGeminiStatus"></div>
    </div>
</div>

<strong>RBT Paraphrase:</strong><br>
 <div class="single_verse">{{ rbt_paraphrase|safe }}</div>   
<form method="post" action="./" id="paraphrase-form" class="panel">            
    {% csrf_token %}
    <textarea id="edited_paraphrase" name="edited_paraphrase" rows="4" cols="80">{{ rbt_paraphrase|safe }}</textarea>
    <input type="hidden" name="record_id" value="{{ record_id }}">
    <input type="hidden" name="book" value="{{ book }}">
    <input type="hidden" name="chapter" value="{{ chapter_num }}">
    <input type="hidden" name="verse" value="{{ verse_num }}"><br>
    <button type="submit" id="save-button">Save</button>
    <button type="button" id="copy-button" onclick="copyText()">Copy</button>
    <input type="text" id="imageUrlInput" placeholder="Enter Image URL">
    <button type="button" id="generate-code-button">Insert Image URL</button>
    <input type="text" id="videoUrlInput" placeholder="Enter Video URL">
    <button type="button" id="generate-video-button">Insert Video URL</button>
    <button type="button" id="h5-button">h5</button>
    <button type="button" id="hebrew-hdr-paraphrase" title="Hebrew header" aria-label="Hebrew header"><span class="hdr-icon hebrew">א</span></button>
    <button type="button" onclick="applyHayahStyle('hayah');"><i>היה</i></button>
    <button type="button" onclick="applyCenterStyle('center');">
        <i class="fas fa-align-center" style="font-size: 18px;"></i>
      </button>
    <button type="button" onclick="applyLastCenterStyle('center');">
    <i class="fas fa-align-center" style="font-size: 18px;"></i> Last
    </button>
    <button type="button" id="sun-button">☀️</button>
    <button type="button" style="background-color: #ff00aa;"
    onclick="applyFontColor('#ff00aa'); updateReader(document.getElementById('edited_paraphrase').value)"><i
        class="fas fa-circle" style="font-size: 18px; color: pink;"></i></button>
<button type="button" style="background-color: blue;"
    onclick="applyFontColor('blue'); updateReader(document.getElementById('edited_paraphrase').value)"><i
        class="fas fa-circle" style="font-size: 18px; color: rgb(58, 147, 198);"></i></button>
    <button type="button" class="gemini-trigger" id="hebrewGeminiOpen">Gemini Suggestion</button>
</form>



<p></p>
{{ litv|safe }}
{{ eng_lxx|safe }}

<h4>Footnotes</h4>
<div>
    {{ footnotes|safe }}
</div>

<strong>Add Footnote:</strong><br>
&lt;span class="footnote_header"&gt;Add Header&lt;/span&gt;

<form method="post" action="./" id="footnote-form" class="panel">            
    {% csrf_token %}
    Footnote ID: <input type="text" id="footnote_id" name="footnote_id" value="{{chapter_num }}-{{verse_num}}-" autocomplete="off">
    <br>Copy & Paste:<font style="color:blue;">  &lt;a class=&quot;sdfootnoteanc&quot; href=&quot;?footnote=<span id="dynamic_content"></span>&quot;&gt;&lt;sup&gt;num&lt;/sup&gt;&lt;/a&gt;</font><br>
    <textarea id="editor-text" name="add_footnote" rows="4" cols="80"></textarea>
    <input type="hidden" name="book" value="{{ book }}">
    <input type="hidden" name="chapter" value="{{ chapter_num }}">
    <input type="hidden" name="verse" value="{{ verse_num }}"><br>
    <button type="submit" id="save-button">Add</button>
    

</form>

<h4><a href="../find_and_replace_ot">Replace a Text in Entire Old Testament</a></h4>

{% if hebrew_clean or hebrew_cards %}
<div class="panel interlinear-panel">
    <h4>Hebrew Interlinear Preview</h4>
    {% if hebrew_clean %}
    <div class="hebrew-large">{{ hebrew_clean|safe }}</div>
    {% endif %}
    {% if hebrew_cards %}
    <div class="hebrew-interlinear-section">
        <div class="interlinear-controls">
            <label for="cardNiqqudSwitch">
                <input type="checkbox" id="cardNiqqudSwitch">
                Show Niqqud
            </label>
            <label class="interlinear-controls__font">
                <input id="toggleHebrewFont" type="checkbox">
                Use Paleo Hebrew Font
            </label>
        </div>
        <div class="hebrew-interlinear-grid">
            {% for cell in hebrew_cards %}
            <div class="interlinear-card">
                <div class="card-hebrew">
                    <span class="hebrew-no-niqqud">{{ cell.hebrew|safe }}</span>
                    <span class="hebrew-with-niqqud">{{ cell.hebrew_niqqud|safe }}</span>
                </div>
                {% if cell.english %}
                <div class="card-english">{{ cell.english|safe }}</div>
                {% endif %}
                {% if cell.strongs %}
                <div class="card-strongs">{{ cell.strongs|safe }}</div>
                {% endif %}
                {% if cell.morph %}
                <div class="card-morph">{{ cell.morph|safe }}</div>
                {% endif %}
                {% if cell.lxx_words or cell.lxx or cell.lxx_data %}
                <div class="card-lxx">
                    <span class="lxx-popup-container">
                        <span style="color: #666; font-size: 11px;">LXX:</span>
                        {% if cell.lxx_words %}
                            {% for word in cell.lxx_words %}
                                <a href="https://logeion.uchicago.edu/{{ word }}" target="_blank">{{ word }}</a>{% if not forloop.last %} {% endif %}
                            {% endfor %}
                        {% elif cell.lxx %}
                            {% for word in cell.lxx.split %}
                                <a href="https://logeion.uchicago.edu/{{ word }}" target="_blank">{{ word }}</a>{% if not forloop.last %} {% endif %}
                            {% endfor %}
                        {% endif %}
                        {% if cell.lxx_data %}
                        <div class="lxx-popup-content">
                            <div class="lxx-popup-header">LXX Usage Statistics <a href="https://en.wikipedia.org/wiki/Septuagint" target="_blank" title="Learn about the Septuagint">↗</a></div>
                            {% for lxx_item in cell.lxx_data %}
                            <div class="lxx-stats-section">
                                <div class="strongs-label">{{ lxx_item.strongs }}:</div>
                                {% for stat in lxx_item.stats %}
                                <div class="lxx-stats-row">
                                    <span class="stat-label"><a href="https://www.perseus.tufts.edu/hopper/morph?l={{ stat.0 }}" target="_blank">{{ stat.0 }}</a></span>
                                    <span class="stat-bar-container"><span class="stat-bar" style="width: {{ stat.2 }}%;"></span></span>
                                    <span class="stat-info">{{ stat.1 }}× ({{ stat.2 }}%)</span>
                                </div>
                                {% empty %}
                                <div class="lxx-stats-row">No stats available</div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </span>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% elif hebrew_row or english_row or strong_row %}
    <div class="hebrewdata-table-wrapper" style="max-height: unset;">
        <table class="interlinear-table">
            <tbody>
                {% if hebrew_row %}{{ hebrew_row|safe }}{% endif %}
                {% if english_row %}{{ english_row|safe }}{% endif %}
                {% if strong_row %}{{ strong_row|safe }}{% endif %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="font-size: 13px; color: #475569;">No interlinear data available for this verse.</p>
    {% endif %}
</div>
{% endif %}

<div class="genesis-tools-grid">
    {% if hebrewdata_rows %}
    <div class="panel hebrewdata-panel">
        <h4>Hebrew Data Editor</h4>
        <p style="font-size: 13px; color: #475569; margin-bottom: 12px;">Adjust individual records from <code>old_testament.hebrewdata</code> for this Genesis verse. Each edit is saved immediately to Postgres.</p>
        <form method="post" action="./" id="hebrewdata-form">
            {% csrf_token %}
            <input type="hidden" name="hebrewdata_action" value="update_rows">
            <input type="hidden" name="book" value="{{ book }}">
            <input type="hidden" name="chapter" value="{{ chapter_num }}">
            <input type="hidden" name="verse" value="{{ verse_num }}">
            <div class="hebrewdata-table-wrapper">
                <table class="hebrewdata-table">
                    <thead>
                        <tr>
                            <th style="width: 24%;">Word</th>
                            <th style="width: 26%;">English</th>
                            <th style="width: 32%;">Morphology</th>
                            <th style="width: 18%;">Map</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in hebrewdata_rows %}
                        <tr>
                            <td>
                                <div class="token-hebrew">{{ row.hebrew|safe }}</div>
                                {% if row.hebrew_niqqud and row.hebrew_niqqud != row.hebrew %}
                                <div class="token-ordinal">{{ row.hebrew_niqqud|safe }}</div>
                                {% endif %}
                                <div class="token-ordinal">{{ row.ref|default:'-' }}</div>
                                <div class="token-ordinal">{{ row.strongs|striptags }}</div>
                                <input type="hidden" name="hebrew_ids" value="{{ row.id }}">
                                <input type="hidden" name="hebrew_refs" value="{{ row.ref }}">
                            </td>
                            <td>
                                <input type="text" name="hebrew_eng" value="{{ row.english|default_if_none:'' }}" autocomplete="off">
                                <input type="hidden" name="hebrew_eng_original" value="{{ row.english_original|default_if_none:'' }}">
                            </td>
                            <td>
                                <input type="text" name="hebrew_morph" value="{{ row.morphology|default_if_none:''|striptags }}" autocomplete="off">
                                <input type="hidden" name="hebrew_morph_original" value="{{ row.morphology|default_if_none:''|striptags }}">
                            </td>
                            <td>
                                <button type="button" class="map-lexicon-btn"
                                        data-hebrew-niqqud="{{ row.hebrew_niqqud|default:row.hebrew }}"
                                        data-hebrew-consonantal="{{ row.hebrew }}"
                                        data-strongs="{{ row.strongs|striptags }}"
                                        onclick="openMappingModal(this)">
                                    MAP LEXICON
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="hebrewdata-actions" style="margin-top: 8px;">
                <button type="submit">Save Hebrew Data</button>
                <span style="font-size: 11px; color: #64748b;">Changes invalidate cache automatically.</span>
            </div>
        </form>
    </div>
    {% endif %}
</div>

</div>

<script>
    // Map Lexicon Modal Functions - Define globally before table renders
    let currentMappingData = {};

    function stripHebrewVowels(s) {
        if (!s) return '';
        return s.replace(/[\u0591-\u05AF\u05B0-\u05BD\u05BF\u05C1-\u05C2\u05C4-\u05C5\u05C7]/g, '');
    }

    function openMappingModal(buttonElement) {
        const hebrewNiqqud = buttonElement.getAttribute('data-hebrew-niqqud') || '';
        const hebrewConsonantal = buttonElement.getAttribute('data-hebrew-consonantal') || '';
        
        currentMappingData = {
            hebrew_niqqud: hebrewNiqqud,
            hebrew_consonantal: hebrewConsonantal
        };

        document.getElementById('modalHebrewNiqqud').textContent = hebrewNiqqud;
        document.getElementById('modalHebrewConsonantal').textContent = hebrewConsonantal;
        document.getElementById('modalStrongsInput').value = '';

        const prefill = stripHebrewVowels(hebrewNiqqud) || hebrewConsonantal || '';
        const searchInput = document.getElementById('searchTermInput');
        if (searchInput) {
            searchInput.value = prefill;
            if (/[\u0590-\u05FF]/.test(prefill)) {
                const matchSelect = document.getElementById('matchTypeSelect');
                if (matchSelect) matchSelect.value = 'root';
            }
        }

        document.getElementById('mappingModal').style.display = 'flex';
        document.getElementById('searchResults').innerHTML = '';
    }

    function closeMappingModal() {
        document.getElementById('mappingModal').style.display = 'none';
        currentMappingData = {};
    }

    async function searchLexiconEntries() {
        const lexiconType = document.getElementById('lexiconTypeSelect').value;
        const matchType = document.getElementById('matchTypeSelect').value;
        let searchTerm = document.getElementById('searchTermInput').value.trim();
        const resultsDiv = document.getElementById('searchResults');

        if (searchTerm && /[\u0590-\u05FF]/.test(searchTerm)) {
            searchTerm = stripHebrewVowels(searchTerm);
        }

        resultsDiv.innerHTML = '<div class="no-results"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';

        try {
            const strongsNumber = document.getElementById('modalStrongsInput').value.trim();

            const params = new URLSearchParams({
                hebrew: currentMappingData.hebrew_niqqud || currentMappingData.hebrew_consonantal || '',
                strong: strongsNumber,
                lexicon: lexiconType,
                match: matchType,
                search: searchTerm
            });

            const response = await fetch(`/translate/api/search-lexicon/?${params}`);
            const data = await response.json();

            if (data.error) {
                resultsDiv.innerHTML = `<div class="no-results" style="color: #dc3545;">${data.error}</div>`;
                return;
            }

            let html = '';

            if (data.fuerst && data.fuerst.length > 0) {
                html += '<div class="lexicon-result-section">';
                html += '<h5>Fürst Lexicon</h5>';
                data.fuerst.forEach(entry => {
                    html += renderLexiconEntry(entry, 'fuerst');
                });
                html += '</div>';
            }

            if (data.gesenius && data.gesenius.length > 0) {
                html += '<div class="lexicon-result-section">';
                html += '<h5>Gesenius Lexicon</h5>';
                data.gesenius.forEach(entry => {
                    html += renderLexiconEntry(entry, 'gesenius');
                });
                html += '</div>';
            }

            if (!html) {
                html = '<div class="no-results">No matching entries found. Try adjusting your search or try a different match mode.</div>';
            }

            resultsDiv.innerHTML = html;

        } catch (error) {
            console.error('Search error:', error);
            resultsDiv.innerHTML = '<div class="no-results" style="color: #dc3545;">Search failed. Please try again.</div>';
        }
    }

    function renderLexiconEntry(entry, lexiconType) {
        const idField = lexiconType === 'fuerst' ? 'id' : 'id';
        const entryId = entry[idField];
        
        const escapeHtml = (text) => {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        const hebrewText = escapeHtml(entry.hebrew_word || entry.hebrew_consonantal);
        const partOfSpeech = entry.part_of_speech ? escapeHtml(entry.part_of_speech) + ' • ' : '';
        const root = entry.root ? 'Root: ' + escapeHtml(entry.root) + ' • ' : '';
        const sourcePage = entry.source_page ? 'Page: ' + escapeHtml(entry.source_page) : '';
        const definition = escapeHtml(entry.definition || 'No definition available');
        
        const cardHtml = `
            <div class="lexicon-entry-card">
                <div class="lexicon-entry-header">
                    <div class="lexicon-entry-hebrew">${hebrewText}</div>
                    <button type="button" class="mapping-btn mapping-btn-add" 
                            data-lexicon-id="${escapeHtml(String(entryId))}" 
                            data-lexicon-type="${escapeHtml(lexiconType)}">
                        <i class="fas fa-plus"></i> Add Mapping
                    </button>
                </div>
                <div class="lexicon-entry-meta">
                    ${partOfSpeech}${root}${sourcePage}
                </div>
                <div class="lexicon-entry-definition">${definition}</div>
            </div>
        `;
        
        return cardHtml;
    }

    async function addMapping(lexiconId, lexiconType) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const numericId = parseInt(String(lexiconId).replace(/\D/g, ''), 10);
        
        if (isNaN(numericId)) {
            alert('Invalid lexicon ID: ' + lexiconId);
            return;
        }
        
        const strongsNumber = document.getElementById('modalStrongsInput').value.trim();
        
        if (!strongsNumber) {
            alert('Please enter a Strong\'s number');
            return;
        }
        
        const payload = {
            hebrew_word: currentMappingData.hebrew_niqqud,
            strong_number: strongsNumber,
            lexicon_type: lexiconType,
            book: null,
            chapter: null,
            verse: null,
            notes: 'Global manual mapping for similar lexemes'
        };
        
        if (lexiconType === 'fuerst') {
            payload.fuerst_id = numericId;
        } else {
            payload.gesenius_id = numericId;
        }
        
        try {
            const response = await fetch('/translate/api/add-manual-lexicon-mapping/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(payload)
            });
            
            const data = await response.json();
            
            if (data.success) {
                alert('✓ Mapping added successfully! You can add more mappings or close the modal.');
            } else {
                alert('Error: ' + (data.error || 'Failed to add mapping'));
            }
        } catch (error) {
            console.error('Add mapping error:', error);
            alert('Network error: ' + error.message);
        }
    }

    // Auto-detect Hebrew input
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchTermInput');
        const matchSelect = document.getElementById('matchTypeSelect');
        if (searchInput && matchSelect) {
            let debounce;
            searchInput.addEventListener('input', function () {
                clearTimeout(debounce);
                debounce = setTimeout(() => {
                    const val = searchInput.value.trim();
                    if (!val) return;
                    if (/^[\u0590-\u05FF\s]+$/.test(val)) {
                        matchSelect.value = 'root';
                        const stripped = stripHebrewVowels(val);
                        if (stripped !== val) searchInput.value = stripped;
                    }
                }, 150);
            });
        }

        // Delegate click events for dynamically created buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.mapping-btn-add')) {
                const btn = e.target.closest('.mapping-btn-add');
                const lexiconId = btn.getAttribute('data-lexicon-id');
                const lexiconType = btn.getAttribute('data-lexicon-type');
                addMapping(lexiconId, lexiconType);
            }
        });
    });
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById("generate-code-button").addEventListener("click", function() {
        var imageUrl = document.getElementById("imageUrlInput").value;
        var generatedCode = '<div class="tooltip-container"><img src="' + imageUrl + '" style="width: 500px; display: block; margin: 0 auto;">  <i class="touch-indicator fas fa-hand-pointer"></i><div class="tooltip">Image description.</div></div>';
        document.getElementById("edited_paraphrase").value += generatedCode;
      });
    });

    // Video insertion
    document.getElementById("generate-video-button").addEventListener("click", function() {
        let url = document.getElementById("videoUrlInput").value.trim();
        if (!url) return;
        let code = `<div class="tooltip-container"><video autoplay muted loop playsinline style="width:500px;display:block;margin:0 auto;border-radius:8px;"><source src="${url}" type="video/mp4">Your browser does not support the video tag.</video><i class="touch-indicator fas fa-hand-pointer"></i><div class="tooltip"><p>Video description.</p></div></div>`;
        let textarea = document.getElementById("edited_paraphrase");
        textarea.value += code;
    });

    document.getElementById("h5-button").addEventListener("click", function() {
        var textarea = document.getElementById("edited_paraphrase");
        var selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
        var newText = '<h5>' + selectedText + '</h5>';
        var beforeSelection = textarea.value.substring(0, textarea.selectionStart);
        var afterSelection = textarea.value.substring(textarea.selectionEnd, textarea.value.length);
        textarea.value = beforeSelection + newText + afterSelection;
    });

    // Hebrew header for paraphrase textarea
    document.getElementById("hebrew-hdr-paraphrase").addEventListener("click", function() {
        var textarea = document.getElementById("edited_paraphrase");
        var selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
        var newText = '<span class="hebrew-header">' + selectedText + '</span>';
        var beforeSelection = textarea.value.substring(0, textarea.selectionStart);
        var afterSelection = textarea.value.substring(textarea.selectionEnd, textarea.value.length);
        textarea.value = beforeSelection + newText + afterSelection;
    });

    // Hebrew header for editor-texto (literal form)
    document.getElementById("hebrew-hdr-editor").addEventListener("click", function() {
        var textarea = document.getElementById("editor-texto");
        var selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
        var newText = '<span class="hebrew-header">' + selectedText + '</span>';
        var beforeSelection = textarea.value.substring(0, textarea.selectionStart);
        var afterSelection = textarea.value.substring(textarea.selectionEnd, textarea.value.length);
        textarea.value = beforeSelection + newText + afterSelection;
    });

    document.getElementById("sun-button").addEventListener("click", function() {
        var textarea = document.getElementById("edited_paraphrase");
        var selectedText = textarea.value.substring(textarea.selectionStart, textarea.selectionEnd);
        var newText = '<div class="sun-icon">' + selectedText + '</div>';
        var beforeSelection = textarea.value.substring(0, textarea.selectionStart);
        var afterSelection = textarea.value.substring(textarea.selectionEnd, textarea.value.length);
        textarea.value = beforeSelection + newText + afterSelection;
    });

    function applyCenterStyle(style) {
        var textArea = document.getElementById('edited_paraphrase');
        var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

        if (selectedText) {
            var styledText = `<span style="display: block; text-align: center;">${selectedText}</span>`;
            var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
            textArea.value = newText;
        }
    }
    
    function applyHayahStyle(style) {
        var textArea = document.getElementById('edited_paraphrase');
        var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

        if (selectedText) {
            var styledText = `<span class="hayah">${selectedText}</span>`;
            var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
            textArea.value = newText;
        }
    }

    function applyLastCenterStyle(style) {
        var textArea = document.getElementById('edited_paraphrase');
        var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

        if (selectedText) {
            var styledText = `<span class="last_center">${selectedText}</span>`;
            var newText = textArea.value.substring(0, textArea.selectionStart) + styledText + textArea.value.substring(textArea.selectionEnd);
            textArea.value = newText;
        }
    }

    function applyFontColor(color) {
            var textArea = document.getElementById('edited_paraphrase');
            var selectedText = textArea.value.substring(textArea.selectionStart, textArea.selectionEnd);

            if (selectedText) {
                var coloredText = `<span style="color: ${color};">${selectedText}</span>`;
                var newText = textArea.value.substring(0, textArea.selectionStart) + coloredText + textArea.value.substring(textArea.selectionEnd);
                textArea.value = newText;
            }
        }

    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var niqqudToggle = document.getElementById('cardNiqqudSwitch');
            if (!niqqudToggle) {
                return;
            }

            function setCardNiqqud(show) {
                var cardContainers = document.querySelectorAll('.interlinear-card .card-hebrew');
                cardContainers.forEach(function (card) {
                    var withNiqqud = card.querySelector('.hebrew-with-niqqud');
                    var noNiqqud = card.querySelector('.hebrew-no-niqqud');
                    if (!withNiqqud || !noNiqqud) {
                        return;
                    }

                    withNiqqud.style.display = show ? 'block' : 'none';
                    noNiqqud.style.display = show ? 'none' : 'block';
                });
            }

            setCardNiqqud(false);
            niqqudToggle.addEventListener('change', function () {
                setCardNiqqud(this.checked);
            });
        });
    </script>

    {{ default_hebrew_prompt|json_script:"defaultHebrewGeminiPrompt" }}

    <script>
        (function () {
            const config = document.getElementById('hebrew-gemini-config');
            const openButton = document.getElementById('hebrewGeminiOpen');
            const modal = document.getElementById('hebrewGeminiModal');
            const promptInput = document.getElementById('hebrewGeminiPrompt');
            const statusEl = document.getElementById('hebrewGeminiStatus');
            const runButton = document.getElementById('hebrewGeminiRun');
            const resetButton = document.getElementById('hebrewGeminiReset');
            const saveButton = document.getElementById('hebrewGeminiSave');
            const modelInput = document.getElementById('hebrewGeminiModel');
            const defaultPromptScript = document.getElementById('defaultHebrewGeminiPrompt');
            const defaultPrompt = defaultPromptScript ? JSON.parse(defaultPromptScript.textContent) : '';
            const defaultModel = config ? (config.dataset.defaultModel || '') : '';
            let currentPrompt = defaultPrompt;
            let currentModel = defaultModel;
            const saveEndpoint = config ? config.dataset.saveEndpoint : '';
            const targetTextarea = document.getElementById('edited_paraphrase');

            if (!config || !openButton || !modal || !promptInput) {
                return;
            }

            const endpoint = config.dataset.endpoint;

            function getCsrfToken() {
                const name = 'csrftoken=';
                const cookies = document.cookie ? document.cookie.split(';') : [];
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name)) {
                        return decodeURIComponent(cookie.substring(name.length));
                    }
                }
                return '';
            }

            function toggleModal(show) {
                modal.classList.toggle('is-visible', !!show);
                modal.setAttribute('aria-hidden', String(!show));
            }

            function resetPrompt() {
                promptInput.value = currentPrompt;
                if (modelInput) {
                    modelInput.value = currentModel;
                }
                statusEl.textContent = '';
            }

            openButton.addEventListener('click', () => {
                resetPrompt();
                toggleModal(true);
            });

            modal.querySelectorAll('[data-action="close"]').forEach((btn) => {
                btn.addEventListener('click', () => toggleModal(false));
            });

            resetButton.addEventListener('click', resetPrompt);

            if (saveButton && saveEndpoint) {
                saveButton.addEventListener('click', async () => {
                    statusEl.textContent = 'Saving prompt…';
                    saveButton.disabled = true;
                    try {
                        const response = await fetch(saveEndpoint, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken(),
                            },
                            body: JSON.stringify({
                                translation_type: config.dataset.translationType,
                                prompt: promptInput.value,
                                model: modelInput ? modelInput.value : undefined,
                            }),
                        });
                        const data = await response.json();
                        if (!response.ok || data.error) {
                            throw new Error(data.error || 'Unable to save prompt.');
                        }
                        currentPrompt = promptInput.value;
                        currentModel = modelInput ? modelInput.value : currentModel;
                        statusEl.textContent = 'Prompt saved.';
                    } catch (error) {
                        statusEl.textContent = error.message;
                    } finally {
                        saveButton.disabled = false;
                    }
                });
            }

            runButton.addEventListener('click', async () => {
                statusEl.textContent = 'Requesting suggestion…';
                runButton.disabled = true;
                openButton.disabled = true;

                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken(),
                        },
                        body: JSON.stringify({
                            translation_type: config.dataset.translationType,
                            book: config.dataset.book,
                            chapter: config.dataset.chapter,
                            verse: config.dataset.verse,
                            prompt: promptInput.value,
                            model: modelInput ? modelInput.value : undefined,
                        }),
                    });

                    const data = await response.json();
                    if (!response.ok || data.error) {
                        throw new Error(data.error || 'Unable to fetch Gemini suggestion.');
                    }

                    if (targetTextarea) {
                        targetTextarea.value = data.suggestion || '';
                    }

                    statusEl.textContent = 'Suggestion loaded into editor.';
                    toggleModal(false);
                } catch (error) {
                    statusEl.textContent = error.message;
                } finally {
                    runButton.disabled = false;
                    openButton.disabled = false;
                }
            });
        })();
    </script>

    <!-- Manual Lexicon Mapping Modal -->
    <div id="mappingModal" class="mapping-modal" style="display: none;">
        <div class="mapping-modal-content">
            <div class="mapping-modal-header">
                <h3>Manual Lexicon Mapping</h3>
                <button type="button" class="close-modal-btn" onclick="closeMappingModal()">×</button>
            </div>
            <div class="mapping-modal-body">
                <div class="mapping-info">
                    <div class="mapping-info-row">
                        <strong>Hebrew (with niqqud):</strong>
                        <span id="modalHebrewNiqqud" style="font-size: 20px;"></span>
                    </div>
                    <div class="mapping-info-row">
                        <strong>Hebrew (consonantal):</strong>
                        <span id="modalHebrewConsonantal" style="font-size: 20px;"></span>
                    </div>
                    <div class="mapping-info-row">
                        <strong>Strong's Number:</strong>
                        <input type="text" id="modalStrongsInput" style="font-size: 1em; padding: 3px 8px; border: 1px solid #ccc; border-radius: 4px; width: 120px;" placeholder="e.g., H8176">
                    </div>
                </div>

                <div class="mapping-search">
                    <h4>Search Lexicon Entries</h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                        <select id="lexiconTypeSelect" class="mapping-input">
                            <option value="both">Both Lexicons</option>
                            <option value="fuerst">Fürst Only</option>
                            <option value="gesenius">Gesenius Only</option>
                        </select>

                        <select id="matchTypeSelect" class="mapping-input" title="Choose search mode">
                            <option value="exact">Exact Match (Hebrew)</option>
                            <option value="contains">Contains (partial)</option>
                            <option value="root">Root</option>
                            <option value="id">ID</option>
                            <option value="strong">Strong's</option>
                            <option value="definition">Definition</option>
                        </select>

                        <input id="searchTermInput" type="text" class="mapping-input" placeholder="Extra term: root / substring / id" />

                        <button type="button" onclick="searchLexiconEntries()" class="mapping-btn mapping-btn-search">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>

                    <div id="searchResults" class="search-results"></div>
                </div>

                <div class="mapping-actions">
                    <button type="button" onclick="closeMappingModal()" class="mapping-btn mapping-btn-cancel">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}
