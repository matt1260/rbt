{% extends 'base.html' %}
{% block title %}Real Bible Translation - {{ page_title }}{% endblock %}
{% load custom_tags %}
{% load static %}
{% block content %}
<!-- Preload and apply critical storehouse CSS (Firefox-friendly) to avoid FOUC -->
<link rel="preload" href="{% static 'chapter-viewer.css' %}" as="style">
<link rel="stylesheet" href="{% static 'chapter-viewer.css' %}" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="{% static 'chapter-viewer.css' %}"></noscript>

<!-- Critical inline CSS (above-the-fold) to prevent flash of unstyled content -->
<style>
  /* Critical storehouse styles */
  #toggleButtonsContainer{display:flex; gap:8px; justify-content:flex-end; background:#fafafa; border:1px solid #e0e0e0; padding:8px; position:sticky; top:0; z-index:50;}
  .chapter-selector{display:flex; flex-wrap:wrap; gap:6px; margin-bottom:12px;}
  .chapter-pill{display:inline-flex;padding:4px 12px;border-radius:999px;border:1px solid #d3c0b2;color:#ba8666;text-decoration:none;font-size:14px;}
  .storehouse-container{display:flex;}
  .verse-card{background:#fffaf7;border:1px solid #e4d6cc;border-radius:8px;padding:16px;}
</style>

<!-- Language Selection Modal -->
<div id="languageModal" class="language-modal-overlay" style="display:none;visibility:hidden;opacity:0;">
    <div class="language-modal">
        <button class="language-modal-close" onclick="closeLanguageModal()" aria-label="Close">&times;</button>
        <div class="language-modal-header">
            <i class="fas fa-language"></i>
            <h3>Select Language</h3>
        </div>
        <div class="language-modal-content">
            <button class="language-option {% if current_language == 'en' or not current_language %}active{% endif %}" onclick="changeLanguage('en')">
                <span class="lang-name">English</span>
                {% if current_language == 'en' or not current_language %}<i class="fas fa-check"></i>{% endif %}
            </button>
            {% for lang_code, lang_name in supported_languages.items %}
            <button class="language-option {% if current_language == lang_code %}active{% endif %}" onclick="changeLanguage('{{ lang_code }}')">
                <span class="lang-name">{{ lang_name }}</span>
                {% if current_language == lang_code %}<i class="fas fa-check"></i>{% endif %}
            </button>
            {% endfor %}
        </div>
        <p class="language-modal-hint">AI-powered translations via Google Gemini</p>
    </div>
</div>

<!-- Translation Loading Modal (starts hidden, JS shows it when needed) -->
<div id="translationLoadingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: none; align-items: center; justify-content: center; opacity: 1;" onclick="if(event.target === this) hideTranslationLoading();">
    <div style="background: white; padding: 40px 50px; border-radius: 12px; text-align: center; max-width: 450px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); position: relative;">
        <button onclick="hideTranslationLoading()" style="position: absolute; top: 12px; right: 12px; width: 32px; height: 32px; border: none; background: #f0f0f0; border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: #666; transition: all 0.2s ease;" onmouseover="this.style.background='#e0e0e0'" onmouseout="this.style.background='#f0f0f0'">&times;</button>
        <div style="margin-bottom: 20px;">
            <i class="fas fa-language" style="font-size: 56px; color: #ba8666; animation: pulse 1.5s ease-in-out infinite;"></i>
        </div>
        <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Translating Content...</h2>
        <p style="color: #666; margin: 0 0 8px 0; font-size: 16px;">
            {{ supported_languages|get_item:current_language|default:current_language }} Translation
        </p>
        <p id="translationProgressText" style="color: #999; margin: 0 0 15px 0; font-size: 13px;">
            Preparing translation request...
        </p>
        <div style="width: 100%; height: 4px; background: #eee; border-radius: 2px; overflow: hidden; margin-bottom: 15px;">
            <div style="height: 100%; background: linear-gradient(90deg, #ba8666, #d4a574, #ba8666); animation: loading 2s ease-in-out infinite;"></div>
        </div>
        <p style="color: #aaa; margin: 0; font-size: 11px; font-style: italic;">
            This typically takes 1-3 minutes. You may leave this page—<br>translation will continue in the background.
        </p>
    </div>
</div>

<script>
// Language modal functions
function openLanguageModal() {
    const modal = document.getElementById('languageModal');
    if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
        modal.style.visibility = 'visible';
        modal.style.opacity = '1';
    }
}

function closeLanguageModal() {
    const modal = document.getElementById('languageModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.style.display = 'none';
            modal.style.visibility = 'hidden';
        }, 300);
    }
}

function changeLanguage(lang) {
    const url = new URL(window.location.href);
    if (lang === 'en') {
        url.searchParams.delete('lang');
    } else {
        url.searchParams.set('lang', lang);
    }
    window.location.href = url.toString();
}

// Close modal on overlay click
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('languageModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeLanguageModal();
            }
        });
    }
    
    // Allow ESC key to close translation loading modal
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const loadingModal = document.getElementById('translationLoadingModal');
            if (loadingModal && loadingModal.style.display === 'flex') {
                hideTranslationLoading();
            }
        }
    });
});

// Functions to show/hide translation loading modal
function showTranslationLoading() {
    const modal = document.getElementById('translationLoadingModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.opacity = '1';
    }
}

function hideTranslationLoading() {
    const modal = document.getElementById('translationLoadingModal');
    if (modal) {
        modal.style.transition = 'opacity 0.5s ease-out';
        modal.style.opacity = '0';
        setTimeout(function() {
            modal.style.display = 'none';
        }, 500);
    }
}
</script>

<p><a href="/">Back to Search</a></p>

<div class="chapter-selector">
    <strong>Select a Chapter:</strong>
    {% if chapters %}
        {{ chapters|safe }}

    {% endif %}

</div>

{% with title_prefix=book|title %}
<div id="toggleButtonsContainer">
    {% if paraphrase %}
    <div id="languageSelector" class="language-selector" onclick="openLanguageModal()" aria-haspopup="dialog" role="button" title="Select language">
        <i class="fas fa-language"></i> <span class="language-label">{{ supported_languages|get_item:current_language|default:'English' }}</span>
    </div>
    {% endif %}
    <div id="h5ToggleButton"><i class="fas fa-eye-slash"></i> Headers (H)</div>
    <div id="imageToggleButton"><i class="fas fa-eye-slash"></i> Images (I)</div>
    <div id="verseRefToggleButton"><i class="fas fa-eye"></i>Verse References (V)</div>
    {% if greek %}
    <div id="literalToggleButton"><i class="fas fa-eye"></i>Greek (G)</div>
    {% endif %}
    <div id="parenthesesToggleButton"><i class="fas fa-eye"></i>Names (P)</div>
    {% if footnotes %}
    <div id="footnotesToggleButton"><i class="fas fa-book"></i>Notes (N)</div>
    {% endif %}
</div>
{% endwith %}

{% if current_language in 'ar,he,ur,fa' %}
<style>
    /* RTL support for Arabic, Hebrew, Urdu, Persian */
    #paraphrase-area, #mainTextArea, .paraphrase, .paraphrase-only {
        direction: rtl;
        text-align: right;
    }
</style>
{% endif %}

<em>Joseph and Aseneth</em>
<h1>{{ book }} {{ chapter_num }}</h1>

<div class="storehouse-container">
    <div id="mainTextArea">
        {% if greek %}
        <div class="storehouse-split greek-hidden" data-initial-hidden="true">
            <div id="paraphrase-area" class="split-column paraphrase">
                {% if paraphrase %}
                    {{ paraphrase|safe }}
                {% else %}
                    <p>No paraphrase available for chapter {{ chapter_num }}.</p>
                {% endif %}
            </div>
            <div id="literal-area" class="split-column literal">
                {{ greek|safe }}
            </div>
        </div>
        {% elif paraphrase %}
        <div id="paraphrase-area" class="paraphrase-only">{{ paraphrase|safe }}</div>
        {% elif verses %}
        <section class="storehouse-body">
            {% for verse in verses %}
            <article class="verse-card" id="aseneth-{{ verse.anchor }}">
                <div class="verse-ref">{{ verse.chapter }}:{{ verse.verse }}</div>
                <div class="verse-content">{{ verse.content|safe }}</div>
            </article>
            {% endfor %}
        </section>
        {% else %}
        <p>No results found for chapter {{ chapter_num }}.</p>
        {% endif %}
    </div>

    {% if footnotes %}
    <aside id="footnotesSidebar" class="footnotes-sidebar">
        <div id="resizeHandle"><div></div></div>
        <div class="footnotes-header">
            <h3>Footnotes</h3>
            <div id="closeSidebarButton">&times;</div>
        </div>
        <div id="footnotesContent">
            {% for footnote_id, footnote_data in footnotes.items %}
            <div id="footnote-{{ footnote_id }}" class="footnote-entry">
                <div class="footnote-label"><sup>{{ footnote_id }}</sup> (Verse {{ footnote_data.verse }})</div>
                <div class="footnote-body">{{ footnote_data.content|safe }}</div>
            </div>
            {% endfor %}
        </div>
    </aside>
    {% endif %}
</div>

<div class="chapter-selector bottom">
    <strong>Select a Chapter:</strong>
    {% if chapters %}
        {{ chapters|safe }}
    {% else %}
        <div class="chapter-pill-list">
            {% for number in chapter_list %}
                {% if number == chapter_num %}
                    <span class="chapter-pill current">{{ number }}</span>
                {% else %}
                    <a class="chapter-pill" href="{% url 'storehouse' %}?chapter={{ number }}">{{ number }}</a>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
</div>

<style>
.chapter-selector { display: flex; flex-wrap: wrap; align-items: center; gap: 3px; margin-bottom: 16px; }
.chapter-selector.bottom { margin-top: 24px; }
.chapter-pill-list { display: flex; flex-wrap: wrap; gap: 8px; }
.chapter-pill { display: inline-flex; align-items: center; justify-content: center; padding: 4px 12px; border-radius: 999px; border: 1px solid #d3c0b2; color: #ba8666; text-decoration: none; font-size: 14px; transition: background 0.2s ease, color 0.2s ease; }
.chapter-pill:hover { background: #f4ebe5; }
.chapter-pill.current { background: #ba8666; color: #fff; border-color: #ba8666; cursor: default; }
.cache-indicator { margin-left: 12px; font-size: 13px; color: #6f9b4b; background: #e7f4dc; padding: 3px 8px; border-radius: 4px; }

#toggleButtonsContainer { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 8px; background: #fafafa; border: 1px solid #e0e0e0; border-radius: 10px; padding: 8px 12px; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50; }
#toggleButtonsContainer > div { display: flex; align-items: center; gap: 6px; font-size: 14px; padding: 6px 12px; color: #ba8666; background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; user-select: none; }
#toggleButtonsContainer > div:hover { background: #f4ebe5; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
#toggleButtonsContainer > div:active { transform: scale(0.97); }
#toggleButtonsContainer i { color: #ba8666; font-size: 14px; }

.storehouse-container { display: flex; position: relative; }
#mainTextArea { flex: 1; width: 100%; max-width: 100%; box-sizing: border-box; transition: margin-right 0.3s ease; }
.storehouse-split { display: flex; gap: 20px; }
.split-column { width: 50%; box-sizing: border-box; }
.paraphrase { border-right: 1px solid #d2d2d2; padding-right: 14px; }
.literal { padding-left: 14px; }
.paraphrase-only { line-height: 1.6; }
.storehouse-split.greek-hidden .literal { display: none; }
.storehouse-split.greek-hidden .paraphrase { width: 100%; border-right: none; padding-right: 0; }
.storehouse-split.greek-hidden { gap: 0; }

.storehouse-body { display: flex; flex-direction: column; gap: 18px; }
.verse-card { border: 1px solid #e4d6cc; border-radius: 8px; padding: 16px; background: #fffaf7; box-shadow: 0 2px 4px rgba(186, 134, 102, 0.08); }
.verse-ref { font-weight: 700; color: #ba8666; margin-bottom: 8px; }
.verse-content { line-height: 1.6; color: #2f2f2f; }

.footnotes-sidebar { position: fixed; right: -400px; top: 0; width: 350px; height: 100vh; background: #f9f9f9; border-left: 2px solid #ba8666; padding: 0 20px; overflow-y: auto; transition: right 0.3s ease; z-index: 1000; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
#resizeHandle { position: absolute; left: 0; top: 0; bottom: 0; width: 10px; cursor: ew-resize; }
#resizeHandle > div { position: absolute; left: 3px; top: 40%; bottom: 40%; width: 4px; background: #ba8666; border-radius: 2px; opacity: 0.8; }
.footnotes-header { display: flex; justify-content: space-between; align-items: center; margin: 20px 0; position: sticky; top: 0; background: #f9f9f9; padding-bottom: 10px; border-bottom: 2px solid #ba8666; z-index: 10; }
.footnotes-header h3 { margin: 0; color: #ba8666; }
#closeSidebarButton { cursor: pointer; font-size: 24px; color: #ba8666; }
.footnote-entry { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd; }
.footnote-entry:last-child { border-bottom: none; }
.footnote-label { font-weight: bold; color: #ba8666; margin-bottom: 5px; }
.footnote-body { font-size: 14px; line-height: 1.6; }

@media (max-width: 768px) {
    #toggleButtonsContainer { justify-content: center; gap: 6px; padding: 10px; position: static; }
    #toggleButtonsContainer > div { font-size: 13px; padding: 5px 10px; }
    .storehouse-split { flex-direction: column; }
    .split-column { width: 100%; padding: 0; border: none; }
    .paraphrase { border: none; padding-right: 0; }
    .literal { padding-left: 0; }
    #mainTextArea { padding-left: 15px; padding-right: 15px; }
    .footnotes-sidebar { width: 97vw; right: -100vw; }
    #resizeHandle { display: none; }
}

img, video, .tooltip-container img, .tooltip-container video { width: 100% !important; height: auto !important; max-width: 500px; display: block; margin: 0 auto; background: #fff; transition: transform 0.3s ease, box-shadow 0.3s ease; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    function wrapParenthesesText(element) {
        if (!element) return;
        function wrapTextNodes(node) {
            if (node.nodeType === Node.TEXT_NODE) {
                const replaced = node.textContent.replace(/\s\([^()]*\)/g, match => '<span class="paren-hide">' + match + '</span>');
                if (replaced !== node.textContent) {
                    const temp = document.createElement('span');
                    temp.innerHTML = replaced;
                    while (temp.firstChild) {
                        node.parentNode.insertBefore(temp.firstChild, node);
                    }
                    node.parentNode.removeChild(node);
                }
            } else if (node.nodeType === Node.ELEMENT_NODE) {
                Array.from(node.childNodes).forEach(wrapTextNodes);
            }
        }
        wrapTextNodes(element);
    }

    // Defer heavy DOM transformations until styles have been applied to avoid forced layouts / FOUC
    function runDeferredTransforms() {
        try {
            wrapParenthesesText(document.getElementById('paraphrase-area'));
            wrapParenthesesText(document.getElementById('literal-area'));
            // Hide the wrapped parentheses spans after they exist
            requestAnimationFrame(function() {
                setTimeout(function() {
                    document.querySelectorAll('.paren-hide').forEach(span => span.style.setProperty('display', 'none', 'important'));
                }, 0);
            });
        } catch (e) {
            // Fail silently if element not present
        }
    }

    if (document.readyState === 'complete') {
        requestAnimationFrame(runDeferredTransforms);
    } else {
        document.addEventListener('DOMContentLoaded', function() {
            requestAnimationFrame(runDeferredTransforms);
        });
    }

    const h5ToggleButton = document.getElementById('h5ToggleButton');
    const imageToggleButton = document.getElementById('imageToggleButton');
    const literalToggleButton = document.getElementById('literalToggleButton');
    const verseRefToggleButton = document.getElementById('verseRefToggleButton');
    const footnotesToggleButton = document.getElementById('footnotesToggleButton');
    const parenthesesToggleButton = document.getElementById('parenthesesToggleButton');
    const closeSidebarButton = document.getElementById('closeSidebarButton');
    const footnotesSidebar = document.getElementById('footnotesSidebar');
    const mainTextArea = document.getElementById('mainTextArea');
    const resizeHandle = document.getElementById('resizeHandle');
    const verseRefs = document.querySelectorAll('.verse_ref');
    const storehouseSplit = document.querySelector('.storehouse-split');
    const literalArea = document.getElementById('literal-area');

    let isLiteralVisible = false;
    let isImageVisible = true;
    let isH5Visible = true;
    let isVerseRefVisible = false;
    let isFootnotesVisible = false;
    let isParenthesesVisible = false;

    let isResizing = false;
    let startX = 0;
    let startWidth = 380;
    const minWidth = 250;
    const maxWidth = 800;

    function isMobile() {
        return window.innerWidth <= 768;
    }

    function initializeSidebar() {
        if (!footnotesSidebar) return;

        if (isMobile()) {
            footnotesSidebar.style.width = '97vw';
            footnotesSidebar.style.right = '-100vw';
            footnotesSidebar.style.position = 'fixed';
            footnotesSidebar.style.top = '0';
            footnotesSidebar.style.height = '100vh';
            footnotesSidebar.style.zIndex = '1000';
            footnotesSidebar.style.overflowY = 'auto';
            footnotesSidebar.style.overflowX = 'hidden';
            if (mainTextArea) {
                mainTextArea.style.marginRight = '0';
                mainTextArea.style.width = '100%';
                mainTextArea.style.maxWidth = '100%';
            }
            if (resizeHandle) {
                resizeHandle.style.display = 'none';
            }
        } else {
            footnotesSidebar.style.width = '380px';
            footnotesSidebar.style.position = 'fixed';
            footnotesSidebar.style.top = '89.6px';
            footnotesSidebar.style.height = 'calc(100vh - 89.6px)';
            footnotesSidebar.style.zIndex = '100';
            footnotesSidebar.style.overflowY = 'auto';
            footnotesSidebar.style.overflowX = 'hidden';
            if (!isFootnotesVisible) {
                footnotesSidebar.style.right = '-400px';
            }
            if (resizeHandle) {
                resizeHandle.style.display = 'block';
            }
        }
    }

    function toggleFootnotes() {
        if (!footnotesSidebar) return;

        if (isFootnotesVisible) {
            if (isMobile()) {
                footnotesSidebar.style.right = '-100vw';
                const backdrop = document.getElementById('footnotesBackdrop');
                if (backdrop) {
                    backdrop.style.opacity = '0';
                    setTimeout(() => backdrop.remove(), 300);
                }
                if (mainTextArea) {
                    mainTextArea.style.marginRight = '0';
                }
            } else {
                const sidebarWidth = footnotesSidebar.offsetWidth;
                footnotesSidebar.style.right = `-${sidebarWidth + 20}px`;
                if (mainTextArea) {
                    mainTextArea.style.marginRight = '0';
                }
            }
            if (footnotesToggleButton) {
                footnotesToggleButton.innerHTML = '<i class="fas fa-book"></i>Notes (N)';
            }
        } else {
            if (isMobile()) {
                let backdrop = document.getElementById('footnotesBackdrop');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.id = 'footnotesBackdrop';
                    backdrop.style.cssText = 'position: fixed;top: 0;left: 0;width: 100vw;height: 100vh;background-color: rgba(0,0,0,0.5);z-index: 999;opacity: 0;transition: opacity 0.3s ease;';
                    backdrop.addEventListener('click', toggleFootnotes);
                    document.body.appendChild(backdrop);
                }
                setTimeout(() => backdrop.style.opacity = '1', 10);
                footnotesSidebar.style.right = '0';
            } else {
                footnotesSidebar.style.right = '0';
                const sidebarWidth = footnotesSidebar.offsetWidth;
                const margin = Math.max(50, sidebarWidth - 330);
                if (mainTextArea) {
                    mainTextArea.style.marginRight = margin + 'px';
                }
            }
            if (footnotesToggleButton) {
                footnotesToggleButton.innerHTML = '<i class="fas fa-book-open"></i> Hide Notes (N)';
            }
        }

        isFootnotesVisible = !isFootnotesVisible;
    }

    if (resizeHandle) {
        resizeHandle.addEventListener('mousedown', function(e) {
            if (isMobile()) return;
            isResizing = true;
            startX = e.clientX;
            startWidth = footnotesSidebar.offsetWidth;
            document.body.classList.add('resizing');
            footnotesSidebar.style.transition = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', function(e) {
            if (!isResizing || isMobile()) return;
            const deltaX = startX - e.clientX;
            let newWidth = startWidth + deltaX;
            newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
            footnotesSidebar.style.width = newWidth + 'px';
            if (isFootnotesVisible && mainTextArea) {
                const margin = Math.max(50, newWidth - 330);
                mainTextArea.style.marginRight = margin + 'px';
            }
        });

        document.addEventListener('mouseup', function() {
            if (!isResizing) return;
            isResizing = false;
            document.body.classList.remove('resizing');
            footnotesSidebar.style.transition = 'right 0.3s ease';
        });
    }

    function toggleVerseRefs() {
        verseRefs.forEach(ref => {
            ref.style.display = isVerseRefVisible ? 'none' : 'inline';
        });
        isVerseRefVisible = !isVerseRefVisible;
        if (verseRefToggleButton) {
            verseRefToggleButton.innerHTML = isVerseRefVisible ?
                '<i class="fas fa-eye-slash"></i>Verse References (V)' :
                '<i class="fas fa-eye"></i>Verse References (V)';
        }
    }

    function toggleH5Headers() {
        const h5Elements = document.querySelectorAll('h5');
        h5Elements.forEach(element => {
            element.style.display = isH5Visible ? 'none' : 'block';
        });
        isH5Visible = !isH5Visible;
        if (h5ToggleButton) {
            h5ToggleButton.innerHTML = isH5Visible ?
                '<i class="fas fa-eye-slash"></i>Headers (H)' :
                '<i class="fas fa-eye"></i>Headers (H)';
        }
    }

    function toggleImages() {
        const tooltipContainers = document.querySelectorAll('.tooltip-container');
        tooltipContainers.forEach(container => {
            container.style.display = isImageVisible ? 'none' : 'block';
        });
        isImageVisible = !isImageVisible;
        if (imageToggleButton) {
            imageToggleButton.innerHTML = isImageVisible ?
                '<i class="fas fa-eye-slash"></i>Images (I)' :
                '<i class="fas fa-eye"></i>Images (I)';
        }
    }

    function toggleParentheses() {
        document.querySelectorAll('.paren-hide').forEach(span => {
            if (isParenthesesVisible) {
                span.style.setProperty('display', 'none', 'important');
            } else {
                span.style.setProperty('display', 'inline', 'important');
            }
        });
        isParenthesesVisible = !isParenthesesVisible;
        if (parenthesesToggleButton) {
            parenthesesToggleButton.innerHTML = isParenthesesVisible ?
                '<i class="fas fa-eye-slash"></i>Names (P)' :
                '<i class="fas fa-eye"></i>Names (P)';
        }
    }

    function setLiteralVisibility(visible) {
        if (!storehouseSplit || !literalArea) return;
        if (visible) {
            storehouseSplit.classList.remove('greek-hidden');
            literalArea.style.display = '';
            isLiteralVisible = true;
            if (literalToggleButton) {
                literalToggleButton.innerHTML = '<i class="fas fa-eye-slash"></i>Greek (G)';
            }
        } else {
            storehouseSplit.classList.add('greek-hidden');
            literalArea.style.display = 'none';
            isLiteralVisible = false;
            if (literalToggleButton) {
                literalToggleButton.innerHTML = '<i class="fas fa-eye"></i>Greek (G)';
            }
        }
    }

    function toggleLiteral() {
        setLiteralVisibility(!isLiteralVisible);
    }

    function handleKeyDown(event) {
        if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
            return;
        }
        const key = event.key;
        if ((key === 'v' || key === 'V') && verseRefToggleButton) {
            toggleVerseRefs();
        } else if ((key === 'h' || key === 'H') && h5ToggleButton) {
            toggleH5Headers();
        } else if ((key === 'i' || key === 'I') && imageToggleButton) {
            toggleImages();
        } else if ((key === 'g' || key === 'G') && literalToggleButton) {
            toggleLiteral();
        } else if ((key === 'n' || key === 'N') && footnotesSidebar) {
            toggleFootnotes();
        } else if ((key === 'p' || key === 'P') && parenthesesToggleButton) {
            toggleParentheses();
        } else if (key === 'Escape' && isFootnotesVisible && isMobile()) {
            toggleFootnotes();
        }
    }

    document.addEventListener('keydown', handleKeyDown);
    if (h5ToggleButton) h5ToggleButton.addEventListener('click', toggleH5Headers);
    if (imageToggleButton) imageToggleButton.addEventListener('click', toggleImages);
    if (literalToggleButton) literalToggleButton.addEventListener('click', toggleLiteral);
    if (verseRefToggleButton) verseRefToggleButton.addEventListener('click', toggleVerseRefs);
    if (footnotesToggleButton) footnotesToggleButton.addEventListener('click', toggleFootnotes);
    if (parenthesesToggleButton) parenthesesToggleButton.addEventListener('click', toggleParentheses);
    if (closeSidebarButton) closeSidebarButton.addEventListener('click', toggleFootnotes);

    document.querySelectorAll('.footnote-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            if (!isFootnotesVisible) {
                toggleFootnotes();
            }
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                setTimeout(() => {
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    targetElement.style.backgroundColor = '#ffe6d5';
                    setTimeout(() => targetElement.style.backgroundColor = '', 2000);
                }, 100);
            }
        });
    });

    let resizeTimeout;
    window.addEventListener('resize', function() {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(function() {
            if (isFootnotesVisible) {
                toggleFootnotes();
            }
            initializeSidebar();
        }, 250);
    });

    initializeSidebar();
    if (storehouseSplit && storehouseSplit.dataset.initialHidden === 'true') {
        setLiteralVisibility(false);
    } else if (storehouseSplit) {
        setLiteralVisibility(true);
    }
    if (verseRefs.length) {
        toggleVerseRefs();
    }
});
</script>

<script>
    // Handle post-translation reload - this must run even if needs_translation is false
    // Use sessionStorage to track post-translation state to avoid infinite loops
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const debugMode = urlParams.has('_debug');
        // If no _t in URL, clear any stale reload flag so new chapters don't get skipped
        if (!urlParams.has('_t')) {
            sessionStorage.removeItem('post_translation_reload');
        }
        if (debugMode) {
            console.log('Debug mode active: skipping post-translation cleanup');
            return;
        }
        if (urlParams.has('_t')) {
            console.log("Post-translation reload detected, setting flag and cleaning up URL");
            // Set flag BEFORE cleaning URL so other scripts know not to trigger translation
            sessionStorage.setItem('post_translation_reload', 'true');
            // Clean up the URL by removing the _t parameter
            urlParams.delete('_t');
            const cleanUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.replaceState({}, '', cleanUrl);
            // Hide modal if visible
            var modal = document.getElementById('translationLoadingModal');
            if (modal) modal.style.display = 'none';
        }
    });
</script>

{% if needs_translation and paraphrase %}
<script>
    // Detect browser back/forward cache (bfcache) loads
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            // Page was loaded from bfcache (browser back/forward button)
            console.log('Page loaded from bfcache, cleaning up active modals and overlays');

            // Hide translation loading modals
            const tlById = document.getElementById('translationLoadingModal');
            if (tlById) {
                try { tlById.style.display = 'none'; } catch(e){}
                tlById.classList.remove('active');
                tlById.style.opacity = '';
            }

            // Close language modal if it was left open
            const langModal = document.getElementById('languageModal');
            if (langModal) langModal.classList.remove('active');

            // Reset body overflow
            try { document.body.style.overflow = ''; } catch(e){}
            try { window.scrollTo(0,0); } catch(e){}
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Check if this is a post-translation reload using sessionStorage flag
        const urlParams = new URLSearchParams(window.location.search);
        const debugMode = urlParams.has('_debug');
        if (urlParams.has('_t') || sessionStorage.getItem('post_translation_reload') === 'true') {
            console.log("Post-translation reload detected, skipping translation trigger");
            // Clear the flag after checking
            sessionStorage.removeItem('post_translation_reload');
            return; // Don't trigger translation again
        }
        if (debugMode) {
            console.log('Debug mode active: skipping auto-translation trigger');
            return;
        }
        
        // Check server-side flag whether translation is needed
        const needsTranslation = {{ needs_translation|yesno:'true,false'|default:'false' }};
        if (!needsTranslation) {
            console.log('No translations required (cached). Skipping translation trigger.');
            return; // Do not show the modal or start a translation job
        }
        
        console.log("Translations needed, triggering API...");
        
        // Use original book name from context (for translation database lookup)
        const book = '{{ original_book|default:book }}';
        const chapter = '{{ chapter_num }}';
        const lang = '{{ current_language }}';
        
        console.log(`Triggering translation for: ${book} ch${chapter} (${lang})`);

        if (book && chapter && lang && lang !== 'en') {
            // Prevent rapid re-triggers from reload or quick refreshes
            try {
                const triggerKey = `trans_trigger:${book}:${chapter}:${lang}`;
                const last = sessionStorage.getItem(triggerKey);
                if (last && (Date.now() - parseInt(last, 10) < 30000)) { // 30s guard
                    console.log('Translation recently triggered; skipping re-trigger.');
                    return;
                }
                sessionStorage.setItem(triggerKey, String(Date.now()));
            } catch (e) { /* sessionStorage may be unavailable */ }

            // Small delay to ensure page content is rendered before showing modal
            setTimeout(function() {
                // Show the loading modal
                var modal = document.getElementById('translationLoadingModal');
                var progressText = document.getElementById('translationProgressText');
                if (modal) modal.style.display = 'flex';
                if (typeof showTranslationLoading === 'function') {
                    showTranslationLoading();
                }
                
                // Update progress text
                if (progressText) progressText.textContent = 'Starting background translation job...';
                
                // Start background translation job (non-blocking)
                fetch(`/api/translation/start/?book=${encodeURIComponent(book)}&chapter=${chapter}&lang=${lang}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'cached') {
                            if (progressText) progressText.textContent = 'Translations already cached.';
                            if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                            return;
                        }
                        if (data.status === 'ok' && data.job_id) {
                            console.log("Translation job started:", data.job_id);
                            if (progressText) progressText.textContent = 'Translation job started. Processing...';
                            
                            // Poll for job status
                            pollJobStatus(data.job_id, book, chapter, lang, progressText);
                        } else {
                            console.error('Failed to start translation job:', data.message);
                            if (progressText) {
                                progressText.innerHTML = '<span style="color: #d32f2f;">⚠️ Failed to start translation</span><br><span style="font-size: 11px; color: #666;">' + (data.message || 'Unknown error') + '</span>';
                            }
                            setTimeout(() => {
                                if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                            }, 5000);
                        }
                    })
                    .catch(err => {
                        console.error('API Error:', err);
                        if (progressText) {
                            progressText.innerHTML = '<span style="color: #d32f2f;">⚠️ Connection failed</span><br><span style="font-size: 11px; color: #666;">Unable to connect to translation service.</span>';
                        }
                        setTimeout(() => {
                            if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                        }, 5000);
                    });
            }, 100);
        }
    });
    
    // Poll for translation job status
    function pollJobStatus(jobId, book, chapter, lang, progressText) {
        const pollInterval = 2000; // Poll every 2 seconds
        const maxPolls = 300; // Max 10 minutes (300 * 2 seconds)
        let pollCount = 0;
        
        const poll = () => {
            pollCount++;
            
            fetch(`/api/translation/status/?job_id=${jobId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Job status:", data);
                    
                    if (data.status === 'completed') {
                        // Job completed successfully
                        const verses = data.translated_verses || 0;
                        const footnotes = data.translated_footnotes || 0;
                        console.log(`Translation completed! ${verses} verses, ${footnotes} footnotes`);
                        if (progressText) {
                            progressText.textContent = `Translated ${verses} verses and ${footnotes} footnotes. Clearing cache...`;
                        }
                        
                        // Clear cache and reload
                        console.log('Clearing cache...');
                        fetch(`/api/translation/clear-cache/?book=${encodeURIComponent(book)}&chapter=${chapter}&lang=${lang}`)
                            .then(() => {
                                console.log('Cache cleared, preparing to reload...');
                                if (progressText) progressText.textContent = 'Reloading page...';
                                setTimeout(() => {
                                    // Build URL with cache-busting parameter
                                    const url = new URL(window.location.href);
                                    url.searchParams.set('_t', Date.now());
                                    const newUrl = url.toString();
                                    console.log('Reloading to:', newUrl);
                                    
                                    // Simple location change - server has no-cache headers
                                    window.location.href = newUrl;
                                }, 500);
                            })
                            .catch(err => {
                                console.error('Cache clear failed:', err);
                                // Reload anyway
                                const url = new URL(window.location.href);
                                url.searchParams.set('_t', Date.now());
                                window.location.href = url.toString();
                            });
                            
                    } else if (data.status === 'failed') {
                        // Job failed
                        console.error('Translation job failed:', data.error);
                        if (progressText) {
                            let errorMsg = data.error || 'Unknown error';
                            if (errorMsg.includes('quota') || errorMsg.includes('429')) {
                                progressText.innerHTML = '<span style="color: #d32f2f;">⚠️ Translation quota exhausted</span><br><span style="font-size: 11px; color: #666;">API limits reached. Please try again later.</span>';
                            } else {
                                progressText.innerHTML = '<span style="color: #d32f2f;">⚠️ Translation failed</span><br><span style="font-size: 11px; color: #666;">' + errorMsg + '</span>';
                            }
                        }
                        setTimeout(() => {
                            if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                        }, 5000);
                        
                    } else if (data.status === 'processing' || data.status === 'pending') {
                        // Still processing - update progress and poll again
                        const progress = data.progress || 0;
                        const verses = data.translated_verses || 0;
                        const totalVerses = data.total_verses || 0;
                        const footnotes = data.translated_footnotes || 0;
                        const totalFootnotes = data.total_footnotes || 0;
                        
                        if (progressText) {
                            if (data.status === 'pending' && data.queue_position) {
                                // Show queue position
                                let queueMsg = `Position in queue: #${data.queue_position}`;
                                if (data.current_job) {
                                    queueMsg += `<br><span style="font-size: 11px; color: #666;">Currently processing: ${data.current_job.book} ${data.current_job.chapter} (${data.current_job.progress}%)</span>`;
                                }
                                progressText.innerHTML = queueMsg;
                            } else if (totalVerses > 0 || totalFootnotes > 0) {
                                progressText.textContent = `Translating ${data.book || ''} ${data.chapter || ''}... ${progress}% (${verses}/${totalVerses} verses, ${footnotes}/${totalFootnotes} footnotes)`;
                            } else {
                                progressText.textContent = data.status === 'pending' ? 'Starting translation...' : 'Processing translation...';
                            }
                        }
                        
                        if (pollCount < maxPolls) {
                            setTimeout(poll, pollInterval);
                        } else {
                            // Timeout
                            if (progressText) {
                                progressText.innerHTML = '<span style="color: #d32f2f;">⚠️ Translation timeout</span><br><span style="font-size: 11px; color: #666;">Translation is taking too long. It will continue in the background.</span>';
                            }
                            setTimeout(() => {
                                if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                            }, 5000);
                        }
                        
                    } else {
                        // Unknown status
                        console.warn('Unknown job status:', data.status);
                        if (pollCount < maxPolls) {
                            setTimeout(poll, pollInterval);
                        }
                    }
                })
                .catch(err => {
                    console.error('Poll error:', err);
                    // Retry a few times on network errors
                    if (pollCount < maxPolls) {
                        setTimeout(poll, pollInterval * 2);
                    }
                });
        };
        
        // Start polling
        poll();
    }
</script>
{% endif %}

{% endblock %}
