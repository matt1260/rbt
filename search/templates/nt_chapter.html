{% extends 'base.html' %}
{% block title %}Real Bible Translation - {{ page_title }}{% endblock %}
{% load custom_tags %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" crossorigin="anonymous">
<p><a href="/">Back to Search</a></p>

<div style="padding-bottom: 20px;">
<strong>Select a Chapter:</strong>
    {{ chapters|safe }}
</div>

{% with title_prefix=book|title %}
<div id="toggleButtonsContainer" style="display: flex; justify-content: flex-end;">
    <div id="h5ToggleButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-eye-slash"></i> Headers (H)
    </div>
    <div id="imageToggleButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-eye-slash"></i> Images (I)
    </div>
    <div id="verseRefToggleButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-eye"></i> Verse References (V)
    </div>
    <div id="parenthesesToggleButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-eye"></i> Names (P)
    </div>
    <div id="fontDecreaseButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-minus"></i>
    </div>
    <div id="fontIncreaseButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-plus"></i>
    </div>

</div>
{% endwith %}
<h1>{{book}} {{ chapter_num }}</h1>
<!-- Main Content Container -->
<div style="display: flex; position: relative;">
    
    <!-- Main Text Area -->
    <div id="mainTextArea" style="flex: 1; transition: margin-right 0.3s ease;">

        {% if html %}
        <div style="display: flex; justify-content: space-between;">
            <div id="paraphrase-area" style="width: 50%; border-right: 1px solid #000; padding-right: 10px;">
                {% if paraphrase %}
                    {{ paraphrase|safe }}
                {% else %}
                    <p>No results found for chapter {{ chapter_num }}.</p>
                {% endif %}
            </div>

            <div id="literal-area" style="width: 50%; padding-left: 10px;">
                <h4>RBT Greek Literal</h4>
                {{ html|safe }}
            </div>
        </div>
        {% else %}
            {% if paraphrase %}
                <div id="paraphrase-area" style="padding-right: 10px;">{{ paraphrase|safe }}</div>
            {% else %}
                <p>No results found for chapter {{ chapter_num }}.</p>
            {% endif %}
        {% endif %}

    </div>

    <!-- Hidden footnotes data for popup access -->
    {% if footnotes %}
    <div id="footnotesData" style="display: none;">
        {% for footnote_id, footnote_data in footnotes.items %}
        <div id="footnote-{{ footnote_id }}" class="footnote-entry" data-verse="{{ footnote_data.verse }}">
            <div class="footnote-title">
                <sup>{{ footnote_id }}</sup> (Verse {{ footnote_data.verse }})
            </div>
            <div class="footnote-body">
                {{ footnote_data.content|safe }}
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

<!-- Store footnotes data for JavaScript access -->
<script>
    window.footnotesData = {
        {% for footnote_id, footnote_data in footnotes.items %}
        "{{ footnote_id }}": {
            "verse": "{{ footnote_data.verse }}",
            "content": {{ footnote_data.content|safe|escapejs|safe }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    };
</script>

</div>

<div style="padding-top: 20px;">
    <strong>Select a Chapter:</strong>
        {{ chapters|safe }}
</div>

<style>
    /* Mobile responsive fixes for main text area */
    #mainTextArea {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }

    @media (max-width: 768px) {
        #mainTextArea {
            padding-left: 15px !important;
            padding-right: 15px !important;
            margin-right: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        body {
            overflow-x: hidden;
        }
    }

    .footnote-link,
    .sdfootnoteanc {
        color: #ba8666;
        text-decoration: none;
        cursor: pointer;
    }
    .footnote-link:hover,
    .sdfootnoteanc:hover {
        text-decoration: underline;
    }

    /* Modern footnote reference styling */
    .sdfootnoteanc sup,
    .footnote-link sup,
    a[href*="footnote="] sup {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 600;
        font-style: normal;
        color: #fff;
        background: linear-gradient(135deg, #ba8666, #d4a574);
        padding: 2px 5px;
        border-radius: 4px;
        margin: 0 2px;
        vertical-align: middle;
        position: relative;
        top: -2px;
        min-width: 16px;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
        line-height: 1.2;
    }

    .sdfootnoteanc:hover sup,
    .footnote-link:hover sup,
    a[href*="footnote="]:hover sup {
        background: linear-gradient(135deg, #a67550, #c99562);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transform: translateY(-1px);
    }

    /* Modern Footnote Popup Styles */
    .footnote-popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.25s ease;
    }

    .footnote-popup-overlay.active {
        display: block;
        opacity: 1;
    }

    .footnote-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        padding: 0;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        z-index: 10001;
        opacity: 0;
        transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .footnote-popup.active {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .footnote-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #ba8666, #d4a574);
        color: #fff;
    }

    .footnote-popup-title {
        font-size: 15px;
        font-weight: 600;
        margin: 0;
    }

    .footnote-popup-close {
        width: 28px;
        height: 28px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #fff;
        transition: background 0.2s ease;
    }

    .footnote-popup-close:hover {
        background: rgba(255, 255, 255, 0.35);
    }

    .footnote-popup-content {
        padding: 20px;
        font-size: 16px;
        line-height: 1.7;
        color: #333;
        overflow-y: auto;
        max-height: calc(80vh - 60px);
    }

    .footnote-popup-content .hebrew_footnote {
        font-size: 1.4em;
    }

    .footnote-popup-hint {
        padding: 10px 20px;
        background: #f8f8f8;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #999;
        text-align: center;
    }

    @media (max-width: 600px) {
        .footnote-popup {
            width: 94%;
            max-height: 85vh;
        }
        
        .footnote-popup-content {
            font-size: 15px;
            max-height: calc(85vh - 60px);
        }
        
        .footnote-popup-hint {
            display: none;
        }
    }
    
    /* Mobile: Ensure all images and videos scale responsively */
    @media (max-width: 768px) {
        img, video, .tooltip-container img, .tooltip-container video {
            width: 100% !important;
            height: auto !important;
            max-width: 100% !important;
            display: block;
            margin: 0 auto;
            background: #fff;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
    }

     /* Ensure all images and videos scale responsively */
    img, video, .tooltip-container img, .tooltip-container video {
        max-width: 500px;
        display: block;
        margin: 0 auto;
        background: #fff;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* Modern toolbar container */
    #toggleButtonsContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 8px;
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 8px 12px;
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    /* Toolbar buttons */
    #toggleButtonsContainer > div {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        padding: 6px 12px;
        color: #ba8666;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    /* Hover and active states */
    #toggleButtonsContainer > div:hover {
        background: #f4ebe5;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    /* Icon styling */
    #toggleButtonsContainer i {
        color: #ba8666;
        font-size: 14px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        #toggleButtonsContainer {
            justify-content: center;
            gap: 6px;
            padding: 10px;
            position: static;
        }

        #toggleButtonsContainer > div {
            font-size: 13px;
            padding: 5px 10px;
        }
    }


</style>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Parentheses toggle logic
        function wrapParenthesesText(element) {
            if (!element) return;
            // Only wrap text nodes, not HTML tags
            function wrapTextNodes(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    // Replace space + ( ... ) with span (include preceding space)
                    // Only match parentheses that contain double-quoted text, e.g. ("word")
                    let replaced = node.textContent.replace(/\s\(\s*\"([^\"]+)\"\s*\)/g, function(match) {
                        return '<span class="paren-hide">' + match + '</span>';
                    });
                    if (replaced !== node.textContent) {
                        const temp = document.createElement('span');
                        temp.innerHTML = replaced;
                        while (temp.firstChild) {
                            node.parentNode.insertBefore(temp.firstChild, node);
                        }
                        node.parentNode.removeChild(node);
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    Array.from(node.childNodes).forEach(wrapTextNodes);
                }
            }
            wrapTextNodes(element);
        }

        // Wrap parentheses in both areas on page load
        wrapParenthesesText(document.getElementById('paraphrase-area'));
        wrapParenthesesText(document.getElementById('literal-area'));
        
        // Hide parentheses by default (including server-side rendered ones)
        setTimeout(() => {
            document.querySelectorAll('.paren-hide').forEach(span => {
                span.style.setProperty('display', 'none', 'important');
            });
        }, 0);

        const literalToggleButton = document.getElementById("literalToggleButton");
        const imageToggleButton = document.getElementById("imageToggleButton");
        const h5ToggleButton = document.getElementById("h5ToggleButton");
        const verseRefToggleButton = document.getElementById("verseRefToggleButton");
        const parenthesesToggleButton = document.getElementById("parenthesesToggleButton");
        const mainTextArea = document.getElementById("mainTextArea");
        const verseRefs = document.querySelectorAll(".verse_ref");
        const paraphraseArea = document.getElementById("paraphrase-area");
        const fontDecreaseButton = document.getElementById("fontDecreaseButton");
        const fontIncreaseButton = document.getElementById("fontIncreaseButton");
        
        // Font size management
        let currentFontSize = 100; // percentage
        const MIN_FONT_SIZE = 80;
        const MAX_FONT_SIZE = 150;
        const FONT_STEP = 10;
        
        function updateFontSize() {
            document.getElementById('mainTextArea').style.fontSize = currentFontSize + '%';
            if (document.getElementById('sidePanel')) {
                document.getElementById('sidePanel').style.fontSize = currentFontSize + '%';
            }
            localStorage.setItem('ntChapterFontSize', currentFontSize);
        }
        
        // Load saved font size
        const savedFontSize = localStorage.getItem('ntChapterFontSize');
        if (savedFontSize) {
            currentFontSize = parseInt(savedFontSize);
            updateFontSize();
        }
        
        let isLiteralVisible = false;
        let isImageVisible = true;
        let isH5Visible = true;
        let isVerseRefVisible = false;
        let isParenthesesVisible = false;
        
        // Detect if mobile
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        function toggleVerseRefs() {
            verseRefs.forEach(function(ref) {
                ref.style.display = isVerseRefVisible ? "none" : "inline";
            });
            isVerseRefVisible = !isVerseRefVisible;
            verseRefToggleButton.innerHTML = isVerseRefVisible ? 
                '<i class="fas fa-eye-slash"></i> Verse References (V)' : 
                '<i class="fas fa-eye"></i> Verse References (V)';       
        }

        function toggleH5Headers() {
            const h5Elements = document.querySelectorAll("h5");
            h5Elements.forEach(function(element) {
                element.style.display = isH5Visible ? "none" : "block";
            });
            isH5Visible = !isH5Visible;
            h5ToggleButton.innerHTML = isH5Visible ? 
                '<i class="fas fa-eye-slash"></i> Headers (H)' : 
                '<i class="fas fa-eye"></i> Headers (H)';
        }

        function toggleImages() {
            const tooltipContainers = document.querySelectorAll(".tooltip-container");
            tooltipContainers.forEach(function(container) {
                container.style.display = isImageVisible ? "none" : "block";
            });
            isImageVisible = !isImageVisible;
            imageToggleButton.innerHTML = isImageVisible ? 
                '<i class="fas fa-eye-slash"></i> Images (I)' : 
                '<i class="fas fa-eye"></i> Images (I)';
        }

        function toggleParentheses() {
            document.querySelectorAll('.paren-hide').forEach(span => {
                if (isParenthesesVisible) {
                    span.style.setProperty('display', 'none', 'important');
                } else {
                    span.style.setProperty('display', 'inline', 'important');
                }
            });
            isParenthesesVisible = !isParenthesesVisible;
            parenthesesToggleButton.innerHTML = isParenthesesVisible ? 
                '<i class="fas fa-eye-slash"></i> Names (P)' : 
                '<i class="fas fa-eye"></i> Names (P)';
        }

        function handleKeyDown(event) {
            // Don't trigger if user is typing in an input
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            if (event.key === "v" || event.key === "V") {
                toggleVerseRefs();
            } else if (event.key === "h" || event.key === "H") { 
                toggleH5Headers();
            } else if (event.key === "i" || event.key === "I") { 
                toggleImages();
            } else if (event.key === "p" || event.key === "P") {
                toggleParentheses();
            } else if (event.key === "+" || event.key === "=") {
                if (fontIncreaseButton) fontIncreaseButton.click();
            } else if (event.key === "-" || event.key === "_") {
                if (fontDecreaseButton) fontDecreaseButton.click();
            }
        }

        // Event Listeners
        document.addEventListener("keydown", handleKeyDown);
        
        if (h5ToggleButton) h5ToggleButton.addEventListener("click", toggleH5Headers);
        if (imageToggleButton) imageToggleButton.addEventListener("click", toggleImages);
        if (verseRefToggleButton) verseRefToggleButton.addEventListener("click", toggleVerseRefs);
        if (parenthesesToggleButton) parenthesesToggleButton.addEventListener("click", toggleParentheses);
        
        if (fontIncreaseButton) fontIncreaseButton.addEventListener("click", function() {
            if (currentFontSize < MAX_FONT_SIZE) {
                currentFontSize += FONT_STEP;
                updateFontSize();
            }
        });
        
        if (fontDecreaseButton) fontDecreaseButton.addEventListener("click", function() {
            if (currentFontSize > MIN_FONT_SIZE) {
                currentFontSize -= FONT_STEP;
                updateFontSize();
            }
        });
        
        // Handle footnote link clicks - open panel and scroll to footnote
        function attachFootnoteHandlers() {
            // Handle both .footnote-link and .sdfootnoteanc (standard footnote links)
            document.querySelectorAll('.footnote-link, .sdfootnoteanc, a[href*="?footnote="], a[href*="footnote="]').forEach(function(link) {
                // Skip if already initialized
                if (link.dataset.footnoteInit) return;
                link.dataset.footnoteInit = 'true';
                
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Extract footnote ID from href
                    let hrefFootnoteId;
                    const href = this.getAttribute('href') || '';
                    
                    if (href.includes('footnote=')) {
                        // Format: ?footnote=22-10-41b&book=Mat
                        const match = href.match(/footnote=([^&]+)/);
                        if (match) {
                            hrefFootnoteId = match[1];
                        }
                    } else if (href.startsWith('#footnote-')) {
                        hrefFootnoteId = href.replace('#footnote-', '');
                    } else if (href.startsWith('#')) {
                        hrefFootnoteId = href.substring(1);
                    }
                    
                    // Also try getting text content from the sup element
                    const supEl = this.querySelector('sup');
                    const supText = supEl ? supEl.textContent.trim() : null;
                    
                    console.log('Href footnote ID:', hrefFootnoteId, 'Sup text:', supText);
                    
                    if (!hrefFootnoteId && !supText) {
                        console.log('No footnote ID found');
                        return;
                    }
                    
                    // Try to find the footnote element
                    // The href ID format is: chapter-verse-footnoteNumber (e.g., 22-10-41b)
                    // The actual footnote ID might just be the footnoteNumber (e.g., 41b)
                    let footnoteElement = null;
                    let matchedId = null;
                    
                    // First try direct match
                    footnoteElement = document.getElementById('footnote-' + hrefFootnoteId);
                    if (footnoteElement) {
                        matchedId = hrefFootnoteId;
                    }
                    
                    // If not found, try using just the sup text (e.g., "41b")
                    if (!footnoteElement && supText) {
                        footnoteElement = document.getElementById('footnote-' + supText);
                        if (footnoteElement) {
                            matchedId = supText;
                        }
                    }
                    
                    // If still not found, search all footnote entries for partial match
                    if (!footnoteElement) {
                        const allFootnotes = document.querySelectorAll('.footnote-entry');
                        const searchParts = hrefFootnoteId ? hrefFootnoteId.split('-') : [];
                        const lastPart = searchParts.length > 0 ? searchParts[searchParts.length - 1] : supText;
                        
                        console.log('Searching for footnote ending with:', lastPart);
                        
                        allFootnotes.forEach(function(fn) {
                            if (footnoteElement) return; // Already found
                            const fnId = fn.id.replace('footnote-', '');
                            // Check if the footnote ID ends with the same suffix
                            if (fnId === lastPart || fnId.endsWith('-' + lastPart)) {
                                footnoteElement = fn;
                                matchedId = fnId;
                            }
                        });
                    }
                    
                    console.log('Found element:', footnoteElement, 'Matched ID:', matchedId);
                    
                    if (footnoteElement) {
                        showFootnotePopup(matchedId, footnoteElement);
                    } else {
                        // Fallback: Show the link text content
                        console.log('Footnote element not found, showing fallback');
                        showFootnotePopupFallback(hrefFootnoteId || supText);
                    }
                });
            });
        }
        
        // ============================================
        // Modern Footnote Popup System
        // ============================================
        
        // Create popup elements
        const footnotePopupOverlay = document.createElement('div');
        footnotePopupOverlay.className = 'footnote-popup-overlay';
        document.body.appendChild(footnotePopupOverlay);
        
        const footnotePopup = document.createElement('div');
        footnotePopup.className = 'footnote-popup';
        footnotePopup.innerHTML = `
            <div class="footnote-popup-header">
                <span class="footnote-popup-title"></span>
                <button class="footnote-popup-close" aria-label="Close">&times;</button>
            </div>
            <div class="footnote-popup-content"></div>
            <div class="footnote-popup-hint">Press Escape or click outside to close</div>
        `;
        document.body.appendChild(footnotePopup);
        
        const popupTitle = footnotePopup.querySelector('.footnote-popup-title');
        const popupContent = footnotePopup.querySelector('.footnote-popup-content');
        const popupClose = footnotePopup.querySelector('.footnote-popup-close');
        
        function showFootnotePopup(footnoteId, footnoteElement) {
            // Get title (verse info) and content using class names
            const titleEl = footnoteElement.querySelector('.footnote-title');
            const contentEl = footnoteElement.querySelector('.footnote-body');
            
            const title = titleEl ? titleEl.textContent.trim() : 'Footnote ' + footnoteId;
            const content = contentEl ? contentEl.innerHTML : footnoteElement.innerHTML;
            
            popupTitle.textContent = title;
            popupContent.innerHTML = content;
            
            // Show popup
            requestAnimationFrame(() => {
                footnotePopupOverlay.classList.add('active');
                footnotePopup.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        }
        
        function showFootnotePopupFallback(footnoteId) {
            popupTitle.textContent = 'Footnote ' + footnoteId;
            popupContent.innerHTML = '<p>Footnote content not found. Please open the Notes panel to view all footnotes.</p>';
            
            requestAnimationFrame(() => {
                footnotePopupOverlay.classList.add('active');
                footnotePopup.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        }
        
        function closeFootnotePopup() {
            footnotePopupOverlay.classList.remove('active');
            footnotePopup.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Close handlers
        popupClose.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeFootnotePopup();
        });
        
        footnotePopupOverlay.addEventListener('click', closeFootnotePopup);
        
        footnotePopup.addEventListener('click', function(e) {
            e.stopPropagation();
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && footnotePopup.classList.contains('active')) {
                closeFootnotePopup();
            }
        });
        
        // Initial attach
        attachFootnoteHandlers();
        
        // Re-attach when content changes
        const contentObserver = new MutationObserver(attachFootnoteHandlers);
        if (mainTextArea) {
            contentObserver.observe(mainTextArea, { childList: true, subtree: true });
        }
        
        // Initialize verse refs on load
        toggleVerseRefs();

        // ============================================
        // Tooltip Touch/Click Support
        // ============================================
        
        // Create tooltip overlay element
        let tooltipOverlay = document.querySelector('.tooltip-overlay');
        if (!tooltipOverlay) {
            tooltipOverlay = document.createElement('div');
            tooltipOverlay.className = 'tooltip-overlay';
            document.body.appendChild(tooltipOverlay);
        }
        
        let activeTooltip = null;
        
        function openTooltip(tooltipEl) {
            if (activeTooltip) {
                closeTooltip();
            }
            
            // Add close button if not present
            if (!tooltipEl.querySelector('.tooltip-close-btn')) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'tooltip-close-btn';
                closeBtn.innerHTML = 'Ã—';
                closeBtn.setAttribute('aria-label', 'Close');
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeTooltip();
                });
                tooltipEl.insertBefore(closeBtn, tooltipEl.firstChild);
            }
            
            activeTooltip = tooltipEl;
            tooltipOverlay.classList.add('active');
            tooltipEl.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeTooltip() {
            if (activeTooltip) {
                activeTooltip.classList.remove('active');
                activeTooltip = null;
            }
            tooltipOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Attach click/touch listeners to tooltip containers
        function attachTooltipListeners() {
            const tooltipContainers = document.querySelectorAll('.tooltip-container');
            tooltipContainers.forEach(container => {
                // Skip if already initialized
                if (container.dataset.tooltipInit) return;
                container.dataset.tooltipInit = 'true';
                
                container.addEventListener('click', function(e) {
                    // Don't trigger if clicking a link inside
                    if (e.target.tagName === 'A') return;
                    
                    const tooltip = container.querySelector('.tooltip, .tooltip2');
                    if (tooltip) {
                        e.preventDefault();
                        e.stopPropagation();
                        openTooltip(tooltip);
                    }
                });
            });
        }
        
        // Close tooltip when clicking overlay
        tooltipOverlay.addEventListener('click', closeTooltip);
        
        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && activeTooltip) {
                closeTooltip();
            }
        });
        
        // Initialize tooltip listeners
        attachTooltipListeners();
        
        // Re-attach when content changes
        const tooltipObserver = new MutationObserver(attachTooltipListeners);
        tooltipObserver.observe(document.body, { childList: true, subtree: true });
    });
</script>

<script>
    {% if cache_hit %}
        console.log("Verse(s) served from cache.");
    {% else %}
        console.log("Verse(s) not served from cache.");
    {% endif %}
</script>

{% endblock %}