{% extends 'base.html' %}
{% block title %}Real Bible Translation - {{ page_title }}{% endblock %}
{% load custom_tags %}
{% block content %}
<p><a href="/">Back to Search</a></p>

<div style="padding-bottom: 20px;">
<strong>Select a Chapter:</strong>
    {{ chapters|safe }}
</div>

{% with title_prefix=book|title %}
<div id="toggleButtonsContainer" style="display: flex; justify-content: flex-end;">
    <div id="h5ToggleButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-eye-slash"></i> Hide Headers (H)
    </div>
    <div id="imageToggleButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-eye-slash"></i> Hide Images (I)
    </div>
    <div id="verseRefToggleButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-eye"></i> Show Verse References (V)
    </div>
    <!-- NEW: Footnotes Toggle Button -->
    {% if footnotes %}
    <div id="footnotesToggleButton" style="font-size: 14px; padding: 6px 10px; text-align: right; color: #ba8666; cursor: pointer;">
        <i class="fas fa-book"></i> Show Notes (N)
    </div>
    {% endif %}
</div>
{% endwith %}
<h1>{{book}} {{ chapter_num }}</h1>
<!-- Main Content Container -->
<div style="display: flex; position: relative;">
    
    <!-- Main Text Area -->
    <div id="mainTextArea" style="flex: 1; transition: margin-right 0.3s ease;">
        
        {% if html %}
        <div style="display: flex; justify-content: space-between;">
            
            <div style="width: 50%; border-right: 1px solid #000; padding-right: 10px;">
                {% if paraphrase %}
                    {{ paraphrase|safe }}
                {% else %}
                    <p>No results found for chapter {{ chapter_num }}.</p>
                {% endif %}
            </div>

            <div style="width: 50%; padding-left: 10px;">
                <h4>RBT Greek Literal</h4>
                {{ html|safe }}
            </div>

        </div>
        {% else %}
            {% if paraphrase %}
                {{ paraphrase|safe }}
            {% else %}
                <p>No results found for chapter {{ chapter_num }}.</p>
            {% endif %}
        {% endif %}

    </div>

    <!-- Footnotes Sidebar -->
    {% if footnotes %}
        <div id="footnotesSidebar" style="position: fixed; right: -400px; top: 0; width: 350px; height: 100vh; background: #f9f9f9; border-left: 2px solid #ba8666; /* padding: 20px; */ padding: 0 20px; overflow-y: auto; transition: right 0.3s ease; z-index: 1000; box-shadow: -2px 0 10px rgba(0,0,0,0.1);">
        <div id="resizeHandle" style="
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 10px;
            height: auto;
            cursor: ew-resize;
            background: transparent;
            z-index: 1001;
        ">
            <div style="
                position: absolute;
                left: 3px;
                top: 40%;
                bottom: 40%;
                width: 4px;
                background: #ba8666;
                border-radius: 2px;
                opacity: 0.8;
            "></div>
        </div>

        <div style="padding: 20px 0;"> <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; position: sticky; top: 0; background: #f9f9f9; padding-bottom: 10px; border-bottom: 2px solid #ba8666; z-index: 10;">
                <h3 style="margin: 0; color: #ba8666;">Footnotes</h3>
                <div id="closeSidebarButton" style="cursor: pointer; font-size: 24px; color: #ba8666;">&times;</div>
            </div>

            <div id="footnotesContent">
                </div>
        </div>
        
        <div id="footnotesContent">
            {% for footnote_id, footnote_data in footnotes.items %}
            <div id="footnote-{{ footnote_id }}" class="footnote-entry" style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #ddd;">
                <div style="font-weight: bold; color: #ba8666; margin-bottom: 5px;">
                    <sup>{{ footnote_id }}</sup> (Verse {{ footnote_data.verse }})
                </div>
                <div style="font-size: 14px; line-height: 1.6;">
                    {{ footnote_data.content|safe }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

</div>

<div style="padding-top: 20px;">
    <strong>Select a Chapter:</strong>
        {{ chapters|safe }}
</div>

<style>
    /* Mobile responsive fixes for main text area */
    #mainTextArea {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }

    @media (max-width: 768px) {
        #mainTextArea {
            padding-left: 15px !important;
            padding-right: 15px !important;
            margin-right: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        
        body {
            overflow-x: hidden;
        }
    }

    /* Ensure smooth transitions */
    #footnotesSidebar {
        transition: right 0.3s ease;
        overflow-y: auto;
        overflow-x: hidden;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    }

    /* Prevent horizontal scroll when sidebar is open */
    body.resizing {
        overflow: hidden;
        user-select: none;
    }
    .footnote-link {
        color: #ba8666;
        text-decoration: none;
    }
    .footnote-link:hover {
        text-decoration: underline;
    }
    .footnote-entry:last-child {
        border-bottom: none;
    }
    
    /* Disable text selection during resize */
    body.resizing {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }
    
    #resizeHandle:hover > div {
        opacity: 0.8 !important;
    }

    /* Ensure all images and videos scale responsively */
    img, video, .tooltip-container img, .tooltip-container video {
        width: 100% !important;
        height: auto !important;
        max-width: 500px;
        display: block;
        margin: 0 auto;
        border-radius: 8px;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    /* Mobile fix */
    @media (max-width: 768px) {
    img, video {
        max-width: 100% !important;
    }
    }

    /* Modern toolbar container */
    #toggleButtonsContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 8px;
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 8px 12px;
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    /* Toolbar buttons */
    #toggleButtonsContainer > div {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        padding: 6px 12px;
        color: #ba8666;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    /* Hover and active states */
    #toggleButtonsContainer > div:hover {
        background: #f4ebe5;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    #toggleButtonsContainer > div:active {
        transform: scale(0.97);
    }

    /* Icon styling */
    #toggleButtonsContainer i {
        color: #ba8666;
        font-size: 14px;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
        #toggleButtonsContainer {
            justify-content: center;
            gap: 6px;
            padding: 10px;
            position: static;
        }

        #toggleButtonsContainer > div {
            font-size: 13px;
            padding: 5px 10px;
        }
    }


</style>
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const literalToggleButton = document.getElementById("literalToggleButton");
        const imageToggleButton = document.getElementById("imageToggleButton");
        const h5ToggleButton = document.getElementById("h5ToggleButton");
        const verseRefToggleButton = document.getElementById("verseRefToggleButton");
        const footnotesToggleButton = document.getElementById("footnotesToggleButton");
        const closeSidebarButton = document.getElementById("closeSidebarButton");
        const footnotesSidebar = document.getElementById("footnotesSidebar");
        const mainTextArea = document.getElementById("mainTextArea");
        const resizeHandle = document.getElementById("resizeHandle");
        const verseRefs = document.querySelectorAll(".verse_ref");
        
        let isLiteralVisible = false;
        let isImageVisible = true;
        let isH5Visible = true;
        let isVerseRefVisible = false;
        let isFootnotesVisible = false;
        
        // Resizing variables
        let isResizing = false;
        let startX = 0;
        let startWidth = 380;
        const minWidth = 250;
        const maxWidth = 800;
        
        // Detect if mobile
        function isMobile() {
            return window.innerWidth <= 768;
        }
        
        // Initialize sidebar positioning based on screen size
        function initializeSidebar() {
            if (!footnotesSidebar) return;
            
            if (isMobile()) {
                // Mobile: Full width overlay, positioned off-screen initially
                footnotesSidebar.style.width = '97vw';
                footnotesSidebar.style.right = '-100vw';
                footnotesSidebar.style.position = 'fixed';
                footnotesSidebar.style.top = '0';
                footnotesSidebar.style.height = '100vh';
                footnotesSidebar.style.zIndex = '1000';
                footnotesSidebar.style.overflowY = 'auto';
                footnotesSidebar.style.overflowX = 'hidden';
                
                // Reset main text area for mobile
                if (mainTextArea) {
                    mainTextArea.style.marginRight = '0';
                    mainTextArea.style.width = '100%';
                    mainTextArea.style.maxWidth = '100%';
                    mainTextArea.style.paddingLeft = '15px';
                    mainTextArea.style.paddingRight = '15px';
                    mainTextArea.style.boxSizing = 'border-box';
                }
                
                // Hide resize handle on mobile
                if (resizeHandle) {
                    resizeHandle.style.display = 'none';
                }
            } else {
                // Desktop: Side panel
                footnotesSidebar.style.width = '380px';
                footnotesSidebar.style.position = 'fixed';
                footnotesSidebar.style.top = '89.6px';
                footnotesSidebar.style.height = 'auto';
                footnotesSidebar.style.maxHeight = 'calc(100vh - 100px)';
                footnotesSidebar.style.zIndex = '100';
                footnotesSidebar.style.overflowY = 'auto';
                footnotesSidebar.style.overflowX = 'hidden';
                
                if (!isFootnotesVisible) {
                    footnotesSidebar.style.right = '-400px';
                }
                
                // Reset main text area for desktop
                if (mainTextArea) {
                    mainTextArea.style.width = '';
                    mainTextArea.style.maxWidth = '';
                    mainTextArea.style.paddingLeft = '';
                    mainTextArea.style.paddingRight = '';
                    mainTextArea.style.boxSizing = '';
                }
                
                // Show resize handle on desktop
                if (resizeHandle) {
                    resizeHandle.style.display = 'block';
                }
            }
        }
        
        // Toggle Footnotes Sidebar
        function toggleFootnotes() {
            if (!footnotesSidebar) return;
            
            if (isFootnotesVisible) {
                // CLOSE sidebar
                if (isMobile()) {
                    footnotesSidebar.style.right = '-100vw';
                    // Remove any backdrop
                    const backdrop = document.getElementById('footnotesBackdrop');
                    if (backdrop) {
                        backdrop.style.opacity = '0';
                        setTimeout(() => backdrop.remove(), 300);
                    }
                    // Ensure main text is full width
                    if (mainTextArea) {
                        mainTextArea.style.marginRight = '0';
                        mainTextArea.style.width = '100%';
                    }
                } else {
                    const sidebarWidth = footnotesSidebar.offsetWidth;
                    footnotesSidebar.style.right = `-${sidebarWidth + 20}px`;
                    if (mainTextArea) {
                        mainTextArea.style.marginRight = '0';
                    }
                }
                footnotesToggleButton.innerHTML = '<i class="fas fa-book"></i> Show Notes (N)';
            } else {
                // OPEN sidebar
                if (isMobile()) {
                    // Create backdrop for mobile
                    let backdrop = document.getElementById('footnotesBackdrop');
                    if (!backdrop) {
                        backdrop = document.createElement('div');
                        backdrop.id = 'footnotesBackdrop';
                        backdrop.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100vw;
                            height: 100vh;
                            background-color: rgba(0, 0, 0, 0.5);
                            z-index: 999;
                            opacity: 0;
                            transition: opacity 0.3s ease;
                        `;
                        backdrop.addEventListener('click', toggleFootnotes);
                        document.body.appendChild(backdrop);
                    }
                    // Trigger reflow for transition
                    setTimeout(() => backdrop.style.opacity = '1', 10);
                    
                    footnotesSidebar.style.right = '0';
                    // Main text stays full width on mobile
                    if (mainTextArea) {
                        mainTextArea.style.marginRight = '0';
                        mainTextArea.style.width = '100%';
                    }
                } else {
                    footnotesSidebar.style.right = '0';
                    const sidebarWidth = footnotesSidebar.offsetWidth;
                    const margin = Math.max(50, sidebarWidth - 330);
                    if (mainTextArea) {
                        mainTextArea.style.marginRight = margin + 'px';
                    }
                }
                footnotesToggleButton.innerHTML = '<i class="fas fa-book-open"></i> Hide Notes (N)';
            }
            isFootnotesVisible = !isFootnotesVisible;
        }
        
        // Resize functionality (desktop only)
        if (resizeHandle) {
            resizeHandle.addEventListener('mousedown', function(e) {
                if (isMobile()) return;

                isResizing = true;
                startX = e.clientX;
                startWidth = footnotesSidebar.offsetWidth;
                document.body.classList.add('resizing');
                footnotesSidebar.style.transition = 'none';
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isResizing || isMobile()) return;
                
                const deltaX = startX - e.clientX;
                let newWidth = startWidth + deltaX;
                
                newWidth = Math.max(minWidth, Math.min(maxWidth, newWidth));
                footnotesSidebar.style.width = newWidth + 'px';
                
                if (isFootnotesVisible) {
                    const margin = Math.max(50, newWidth - 330);
                    mainTextArea.style.marginRight = margin + 'px';
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isResizing) {
                    isResizing = false;
                    document.body.classList.remove('resizing');
                    footnotesSidebar.style.transition = 'right 0.3s ease';
                }
            });
        }
        
        function toggleVerseRefs() {
            verseRefs.forEach(function(ref) {
                ref.style.display = isVerseRefVisible ? "none" : "inline";
            });
            isVerseRefVisible = !isVerseRefVisible;
            verseRefToggleButton.innerHTML = isVerseRefVisible ? 
                '<i class="fas fa-eye-slash"></i> Hide Verse References (V)' : 
                '<i class="fas fa-eye"></i> Show Verse References (V)';       
        }

        function toggleH5Headers() {
            const h5Elements = document.querySelectorAll("h5");
            h5Elements.forEach(function(element) {
                element.style.display = isH5Visible ? "none" : "block";
            });
            isH5Visible = !isH5Visible;
            h5ToggleButton.innerHTML = isH5Visible ? 
                '<i class="fas fa-eye-slash"></i> Hide Headers (H)' : 
                '<i class="fas fa-eye"></i> Show Headers (H)';
        }

        function toggleImages() {
            const tooltipContainers = document.querySelectorAll(".tooltip-container");
            tooltipContainers.forEach(function(container) {
                container.style.display = isImageVisible ? "none" : "block";
            });
            isImageVisible = !isImageVisible;
            imageToggleButton.innerHTML = isImageVisible ? 
                '<i class="fas fa-eye-slash"></i> Hide Images (I)' : 
                '<i class="fas fa-eye"></i> Show Images (I)';
        }

        function handleKeyDown(event) {
            // Don't trigger if user is typing in an input
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            if (event.key === "v" || event.key === "V") {
                toggleVerseRefs();
            } else if (event.key === "h" || event.key === "H") { 
                toggleH5Headers();
            } else if (event.key === "i" || event.key === "I") { 
                toggleImages();
            } else if (event.key === "n" || event.key === "N") {
                toggleFootnotes();
            } else if (event.key === "Escape" && isFootnotesVisible && isMobile()) {
                toggleFootnotes();
            }
        }

        // Event Listeners
        document.addEventListener("keydown", handleKeyDown);
        
        if (h5ToggleButton) h5ToggleButton.addEventListener("click", toggleH5Headers);
        if (imageToggleButton) imageToggleButton.addEventListener("click", toggleImages);
        if (verseRefToggleButton) verseRefToggleButton.addEventListener("click", toggleVerseRefs);
        if (footnotesToggleButton) footnotesToggleButton.addEventListener("click", toggleFootnotes);
        if (closeSidebarButton) closeSidebarButton.addEventListener("click", toggleFootnotes);
        
        // Handle footnote link clicks
        document.querySelectorAll('.footnote-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                if (!isFootnotesVisible) {
                    toggleFootnotes();
                }
                const targetId = this.getAttribute('href');
                const targetElement = document.querySelector(targetId);
                if (targetElement) {
                    setTimeout(() => {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        targetElement.style.backgroundColor = '#ffe6d5';
                        setTimeout(() => {
                            targetElement.style.backgroundColor = '';
                        }, 2000);
                    }, 100);
                }
            });
        });
        
        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                // Close sidebar on resize to prevent layout issues
                if (isFootnotesVisible) {
                    toggleFootnotes();
                }
                initializeSidebar();
            }, 250);
        });
        
        // Initialize on load
        initializeSidebar();
        toggleVerseRefs();
    });
</script>

<script>
    {% if cache_hit %}
        console.log("Verse(s) served from cache.");
    {% else %}
        console.log("Verse(s) not served from cache.");
    {% endif %}
</script>

{% endblock %}