{% extends 'base.html' %}
{% load custom_tags %}
{% block content %}

<style>
    /* Default styles for the desktop view */
    .desktop-view {
        display: block;
    }

    .mobile-view {
        display: none;
    }

    .front_search {
        border: none;
        display: table;
    }

    .front_search form {
        text-align: left;
        margin-bottom: 10px;
    }

    /* Styles for the mobile view */
    @media only screen and (max-width: 767px) {
        .desktop-view {
            display: none;
        }

        .mobile-view {
            display: block;
            margin-bottom: 10px;
        }
    }

    .verse-view {
        margin-top: 1px;
    }
</style>

<h1 style="text-align: center;">RBT Translation Statistics</h1>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<style>


.container {
    max-width: 1400px;
    margin: 0 auto;
}



.controls {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.control-group {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #5d4524;
    font-weight: 600;
}

select, button {
    padding: 8px 16px;
    border: 2px solid #c9b59b; /* muted tan */
    border-radius: 6px;
    background: #fffaf0;
    cursor: pointer;
    transition: all 0.2s;
    color: #4b3621;
    font-weight: 600;
}

select:hover, button:hover {
    border-color: #a67c00; /* warm amber */
    background-color: #fff3b0; /* pale yellow */
    color: #4b3621;
}

button.active {
    background: #a67c00;
    color: #fffaf0;
    border-color: #a67c00;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 20px;

    margin-bottom: 30px;
}

.stat-card {
    background: #fffaf0;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(75, 54, 33, 0.1);
    text-align: center;
    color: #5d4524;
}

.stat-number {
    font-size: 2.5em;
    font-weight: bold;
    color: #a67c00;
    margin-bottom: 5px;
}

.stat-label {
    color: #7a6040;
    font-size: 0.9em;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.charts-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 30px;
}

.chart-container {
    background: #fffaf0;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(75, 54, 33, 0.1);
    color: #5d4524;
}

.chart-title {
    font-size: 1.4em;
    font-weight: 600;
    margin-bottom: 20px;
    color: #5d4524;
}

.chart-wrapper {
    position: relative;
    height: 400px;
}

.chart-wrapper.small {
    height: 300px;
}

.two-column {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
}

.three-column {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 20px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #7a6040;
}

.error {
    background: #fdecea;
    color: #a94442;
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    border: 1px solid #a94442;
}

.reference-list {
    max-height: 400px;
    overflow-y: auto;
    color: #5d4524;
}

.reference-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 0;
    border-bottom: 1px solid #f0e6d2;
    cursor: pointer;
    transition: background-color 0.2s;
}

.reference-item:hover {
    background-color: #f7f1df;
}

.reference-name {
    font-weight: 500;
    color: #5d4524;
}

.reference-count {
    background: #a67c00;
    color: #fffaf0;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: 600;
}

@media (max-width: 768px) {
    .two-column, .three-column {
        grid-template-columns: 1fr;
    }
    
    .controls {
        flex-direction: column;
        align-items: center;
    }
}
</style>


<div class="container">

    <div class="controls">
        <div class="control-group">
            <label for="timeRange">Time Range:</label>
            <select id="timeRange">
                <option value="7">Last 7 days</option>
                <option value="30">Last 30 days</option>
                <option value="90">Last 90 days</option>
                <option value="365">Last year</option>
                <option value="all" selected>All Time</option>
            </select>
        </div>
        <button id="refreshBtn">Refresh Data</button>
    </div>
    
    <div id="loading" class="loading">
        <p>Loading statistics...</p>
    </div>
    
    <div id="error" class="error" style="display: none;">
        <p>Error loading data. Please try again.</p>
    </div>
    
    <div id="dashboard" style="display: none;">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalUpdates">-</div>
                <div class="stat-label">Total Updates</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="uniqueReferences">-</div>
                <div class="stat-label">Unique Verses</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgDaily">-</div>
                <div class="stat-label">Avg Daily Updates</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="mostActiveDay">-</div>
                <div class="stat-label">Peak Day Updates</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="oldTestamentFootnotes">-</div>
                <div class="stat-label">Hebrew Footnotes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newTestamentFootnotes">-</div>
                <div class="stat-label">Greek Footnotes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="bibleCompletion">-</div>
                <div class="stat-label">Real Bible Completed</div>
            </div>
        </div>
        
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">Daily Updates Over Time</h3>
                <div class="chart-wrapper">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>
            
            <div class="two-column">
                <div class="chart-container">
                    <h3 class="chart-title">Weekly Trend</h3>
                    <div class="chart-wrapper small">
                        <canvas id="weeklyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Most Updated/Changed Verses</h3>
                    Some verses are more difficult than others...
                    <div class="reference-list" id="referenceList">
                    </div>
                </div>
            </div>
            
            <div class="three-column">
                <div class="chart-container">
                    <h3 class="chart-title">Hour of Day Pattern</h3>
                    <div class="chart-wrapper small">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Day of Week Pattern</h3>
                    <div class="chart-wrapper small">
                        <canvas id="weekdayChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title">Monthly Overview</h3>
                    <div class="chart-wrapper small">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let charts = {};

async function loadData() {
    const timeRange = document.getElementById('timeRange').value;
    const loading = document.getElementById('loading');
    const error = document.getElementById('error');
    const dashboard = document.getElementById('dashboard');

    loading.style.display = 'block';
    error.style.display = 'none';
    dashboard.style.display = 'none';

    try {
        let endpoint = 'https://read.realbible.tech/stats/';

        if (timeRange === 'all') {
            endpoint += `?days=all`;
        } else {
            endpoint += `?days=${timeRange}`;
        }
        const response = await fetch(endpoint);

        const responseText = await response.text();

        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${responseText}`);
        }

        let data;
        try {
            data = JSON.parse(responseText);
        } catch (parseError) {
            console.error('JSON parse error:', parseError);
            console.error('Response text:', responseText);
            throw new Error(`Invalid JSON response: ${responseText.substring(0, 200)}...`);
        }

        if (data.error) {
            console.error('Server error:', data.error);
            console.error('Traceback:', data.traceback);
            throw new Error(`Server error: ${data.error}`);
        }

        updateDashboard(data);

        loading.style.display = 'none';
        dashboard.style.display = 'block';
    } catch (err) {
        console.error('Error loading data:', err);
        document.getElementById('error').innerHTML = `
            <p><strong>Error loading data:</strong></p>
            <p>${err.message}</p>
            <p>Check the browser console for more details.</p>
        `;
        loading.style.display = 'none';
        error.style.display = 'block';
    }
}

function updateDashboard(data) {
    document.getElementById('totalUpdates').textContent = data.summary.total_updates.toLocaleString();
    document.getElementById('uniqueReferences').textContent = data.summary.unique_references.toLocaleString();
    document.getElementById('avgDaily').textContent = data.summary.average_daily;
    document.getElementById('mostActiveDay').textContent = data.summary.most_active_day ? data.summary.most_active_day.count : 0;
    document.getElementById('oldTestamentFootnotes').textContent = data.summary.ot_footnote_count.toLocaleString();
    document.getElementById('newTestamentFootnotes').textContent = data.summary.nt_footnote_count.toLocaleString();
    document.getElementById('bibleCompletion').textContent =
    data.bible_completion.percentage_complete.toFixed(1) + '%';

    updateDailyChart(data.daily_updates);
    updateWeeklyChart(data.weekly_updates);
    updateHourlyChart(data.hourly_pattern);
    updateWeekdayChart(data.weekday_pattern);
    updateMonthlyChart(data.monthly_updates);
    updateReferenceList(data.top_references);
}

function updateDailyChart(data) {
    const ctx = document.getElementById('dailyChart').getContext('2d');

    if (charts.daily) charts.daily.destroy();

    charts.daily = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.date),
            datasets: [{
                label: 'Daily Updates',
                data: data.map(d => d.count),
                borderColor: '#a67c00',            // warm amber (brownish)
                backgroundColor: 'rgba(166, 124, 0, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(75, 54, 33, 0.1)' // subtle brown grid
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateWeeklyChart(data) {
    const ctx = document.getElementById('weeklyChart').getContext('2d');

    if (charts.weekly) charts.weekly.destroy();

    charts.weekly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => new Date(d.week).toLocaleDateString()),
            datasets: [{
                label: 'Weekly Updates',
                data: data.map(d => d.count),
                backgroundColor: '#5d4524',        // medium brown
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(75, 54, 33, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateHourlyChart(data) {
    const ctx = document.getElementById('hourlyChart').getContext('2d');

    if (charts.hourly) charts.hourly.destroy();

    charts.hourly = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => `${d.hour}:00`),
            datasets: [{
                label: 'Updates by Hour',
                data: data.map(d => d.count),
                backgroundColor: '#c9b59b',        // muted tan
                borderRadius: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(75, 54, 33, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateWeekdayChart(data) {
    const ctx = document.getElementById('weekdayChart').getContext('2d');

    if (charts.weekday) charts.weekday.destroy();

    charts.weekday = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: data.map(d => d.day.substring(0, 3)),
            datasets: [{
                data: data.map(d => d.count),
                backgroundColor: [
                    '#a94442', // muted red
                    '#b35c17', // burnt orange
                    '#a67c00', // warm amber
                    '#ad8b00', // golden brown
                    '#5d4524', // medium brown
                    '#7a6040', // taupe brown
                    '#c9b59b'  // muted tan
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#5d4524'
                    }
                }
            }
        }
    });
}

function updateMonthlyChart(data) {
    const ctx = document.getElementById('monthlyChart').getContext('2d');

    if (charts.monthly) charts.monthly.destroy();

    if (data.length === 0) {
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.fillStyle = '#5d4524';
        ctx.textAlign = 'center';
        ctx.font = '16px sans-serif';
        ctx.fillText('No monthly data available', ctx.canvas.width / 2, ctx.canvas.height / 2);
        return;
    }

    charts.monthly = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.month),
            datasets: [{
                label: 'Monthly Updates',
                data: data.map(d => d.count),
                borderColor: '#7a6040',            // taupe brown
                backgroundColor: 'rgba(122, 96, 64, 0.1)',
                borderWidth: 2,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(75, 54, 33, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function updateReferenceList(data) {
    const container = document.getElementById('referenceList');
    container.innerHTML = '';

    data.forEach((ref, index) => {
        const item = document.createElement('div');
        item.className = 'reference-item';
        item.innerHTML = `
            <span class="reference-name">
                #${index + 1}
                <a href="${ref.link}" target="_blank" style="color: inherit; text-decoration: underline;">
                    ${ref.reference}
                </a>
            </span>
            <span class="reference-count">${ref.count}</span>
        `;
        container.appendChild(item);
    });
}

// Event listeners
document.getElementById('timeRange').addEventListener('change', loadData);
document.getElementById('refreshBtn').addEventListener('click', loadData);

// Initial load
loadData();
</script>

{% endblock %}