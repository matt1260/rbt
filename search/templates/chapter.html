{% extends 'base.html' %}
{% block title %}Real Bible Translation - {{ page_title }}{% endblock %}
{% load custom_tags %}
{% load static %}
{% block content %}
<!-- Preload and apply chapter CSS (Firefox-friendly) to avoid FOUC -->
<link rel="preload" href="{% static 'chapter-viewer.css' %}" as="style">
<link rel="stylesheet" href="{% static 'chapter-viewer.css' %}" media="print" onload="this.media='all'">
<noscript><link rel="stylesheet" href="{% static 'chapter-viewer.css' %}"></noscript>
<script src="{% static 'translation-manager.js' %}"></script>
<script src="{% static 'chapter-viewer.js' %}" defer></script>

<!-- Language Selection Modal -->
<div id="languageModal" class="language-modal-overlay" style="display:none;visibility:hidden;opacity:0;">
    <div class="language-modal">
        <button class="language-modal-close" onclick="closeLanguageModal()" aria-label="Close">&times;</button>
        <div class="language-modal-header">
            <i class="fas fa-language"></i>
            <h3>Select Language</h3>
        </div>
        <div class="language-modal-content">
            <button class="language-option {% if current_language == 'en' or not current_language %}active{% endif %}" onclick="changeLanguage('en')">
                <span class="lang-name">English</span>
                {% if current_language == 'en' or not current_language %}<i class="fas fa-check"></i>{% endif %}
            </button>
            {% for lang_code, lang_name in supported_languages.items %}
            <button class="language-option {% if current_language == lang_code %}active{% endif %}" onclick="changeLanguage('{{ lang_code }}')">
                <span class="lang-name">{{ lang_name }}</span>
                {% if current_language == lang_code %}<i class="fas fa-check"></i>{% endif %}
            </button>
            {% endfor %}
        </div>
        <p class="language-modal-hint">AI-powered translations via Google Gemini</p>
    </div>
</div>

{% if translation_quota_exceeded %}
<!-- Translation Quota Exceeded Modal -->
<div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: flex; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px 50px; border-radius: 12px; text-align: center; max-width: 450px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div style="margin-bottom: 20px;">
            <i class="fas fa-exclamation-triangle" style="font-size: 56px; color: #ff9800;"></i>
        </div>
        <h2 style="margin: 0 0 15px 0; color: #333; font-size: 24px;">Translation Quota Exceeded</h2>
        <p style="color: #666; margin: 0 0 20px 0; font-size: 16px; line-height: 1.6;">
            The Gemini API translation quota has been exceeded for today.
        </p>
        <p style="color: #999; margin: 0 0 30px 0; font-size: 14px;">
            Please try again tomorrow when the quota resets, or switch back to English.
        </p>
        <button onclick="changeLanguage('en')" style="background: #ba8666; color: white; border: none; padding: 12px 30px; font-size: 16px; border-radius: 6px; cursor: pointer; transition: background 0.3s;">
            Switch to English
        </button>
    </div>
</div>
{% else %}
<!-- Translation Loading Modal (starts hidden, JS shows it when needed) -->
<div id="translationLoadingModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10000; display: none; align-items: center; justify-content: center; opacity: 1;">
    <div style="background: white; padding: 40px 50px; border-radius: 12px; text-align: center; max-width: 450px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
        <div style="margin-bottom: 20px;">
            <i class="fas fa-language" style="font-size: 56px; color: #ba8666; animation: pulse 1.5s ease-in-out infinite;"></i>
        </div>
        <h2 style="margin: 0 0 10px 0; color: #333; font-size: 24px;">Translating Content...</h2>
        <p style="color: #666; margin: 0 0 8px 0; font-size: 16px;">
            {{ supported_languages|get_item:current_language|default:current_language }} Translation
        </p>
        <p id="translationProgressText" style="color: #999; margin: 0 0 15px 0; font-size: 13px;">
            Preparing translation request...
        </p>
        <div style="width: 100%; height: 4px; background: #eee; border-radius: 2px; overflow: hidden; margin-bottom: 15px;">
            <div style="height: 100%; background: linear-gradient(90deg, #ba8666, #d4a574, #ba8666); animation: loading 2s ease-in-out infinite;"></div>
        </div>
        <p style="color: #aaa; margin: 0; font-size: 11px; font-style: italic;">
            Translating with Google Gemini. This can take 1-3 minutes. Model may be overloaded and not work; we can only use Google's free API keys with limited quota because there is no funding.<br>You can leave this page and return later.
        </p>
    </div>
</div>

<style>
@keyframes pulse {
    0%, 100% { opacity: 1; transform: scale(1); }
    50% { opacity: 0.6; transform: scale(1.15); }
}
@keyframes loading {
    0% { width: 0%; margin-left: 0%; }
    50% { width: 60%; margin-left: 20%; }
    100% { width: 0%; margin-left: 100%; }
}
</style>

<script>
// Functions to show/hide translation loading modal
function showTranslationLoading() {
    const modal = document.getElementById('translationLoadingModal');
    if (modal) {
        modal.style.display = 'flex';
        modal.style.opacity = '1';
    }
}

function hideTranslationLoading() {
    const modal = document.getElementById('translationLoadingModal');
    if (modal) {
        modal.style.transition = 'opacity 0.5s ease-out';
        modal.style.opacity = '0';
        setTimeout(function() {
            modal.style.display = 'none';
        }, 500);
    }
}
</script>
{% endif %}

<p><a href="/">Back to Search</a></p>

<!-- make this a python generated variable depending on book i.e. 'Genesis Chapters: '-->
<div style="padding-bottom: 20px;">
<strong>Select a Chapter:</strong>
    {{ chapters|safe }}
</div>

<h1>{{ book }} {{ chapter_num }}</h1>
{% with title_prefix=book|title %}
<div id="toggleButtonsContainer">
    <div id="imageToggleButton"><i class="fas fa-eye-slash"></i> Images (I)</div>
    <div id="literalToggleButton"><i class="fas fa-eye"></i> Literal (L)</div>
    <div id="verseRefToggleButton"><i class="fas fa-eye-slash"></i> Verse References (V)</div>
    <div id="parenthesesToggleButton"><i class="fas fa-eye"></i> Names (P)</div>
    <div id="notesToggleButton"><i class="fas fa-book"></i> Notes (N)</div>
    <div id="fontDecreaseButton"><i class="fas fa-minus"></i></div>
    <div id="fontIncreaseButton"><i class="fas fa-plus"></i></div>
    {% if paraphrase %}
    <div id="languageSelector" class="language-selector" onclick="openLanguageModal()" aria-haspopup="dialog" role="button" title="Select language">
        <i class="fas fa-language"></i> <span class="language-label">{{ supported_languages|get_item:current_language|default:'English' }}</span>
    </div>
    {% endif %}
</div>

{% endwith %}

{% if current_language in 'ar,he,ur,fa' %}
<style>
    /* RTL support for Arabic, Hebrew, Urdu, Persian */
    #paraphraseContainer, #toggleDivContainer, #literal-pane, #notes-pane {
        direction: rtl;
        text-align: right;
    }
    
    /* Adjust borders for RTL */
    #paraphraseContainer {
        padding-right: 0 !important;
        padding-left: 10px !important;
    }
    
    #toggleDivContainer {
        border-left: none !important;
        border-right: 1px solid #000 !important;
        padding-left: 0 !important;
        padding-right: 10px !important;
    }
</style>
{% endif %}

<div id="container" style="display: flex; justify-content: space-between;">
    <div id="paraphraseContainer" style="width: 50%; padding-right: 10px;">
        <h4>RBT Paraphrase</h4>
        {% if paraphrase %}
            {{ paraphrase|safe }}
        {% else %}
            <p>No results found for chapter {{ chapter_num }}.</p>
        {% endif %}
    </div>

    <div id="toggleDivContainer" style="width: 50%; padding-left: 10px; border-left: 1px solid #000; display: none;">
        <div id="literal-pane" style="display: none;">
            <h4>RBT Hebrew Literal</h4>
            {% if html %}
                {{ html|safe }}
            {% else %}
                <p>No results found for chapter {{ chapter_num }}.</p>
            {% endif %}
        </div>

        <div id="notes-pane" style="display: none;">
            <h4>Notes</h4>
            {% if notes_html %}
                {{ notes_html|safe }}
            {% else %}
                <p class="notes-empty">No notes collected for this chapter.</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .notes-empty {
        margin: 0;
        font-size: 14px;
        color: #666;
    }

    /* Modern toolbar container */
    #toggleButtonsContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 8px;
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 8px 12px;
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    #toggleButtonsContainer #languageSelector {
        text-align: right;
    }

    /* Toolbar buttons */
    #toggleButtonsContainer > div {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        padding: 6px 12px;
        color: #ba8666;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    /* Hover and active states */
    #toggleButtonsContainer > div:hover {
        background: #f4ebe5;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    /* Icon styling */
    #toggleButtonsContainer i {
        color: #ba8666;
        font-size: 14px;
    }

    #paraphraseContainer {
        margin-bottom: 20px;
    }

    /* Mobile styles */
    @media (max-width: 768px) {
        #container {
            flex-direction: column !important;
        }
        
        #paraphraseContainer {
            width: 100% !important;
            padding-right: 0 !important;
            margin-bottom: 20px;
        }
        
        #toggleDivContainer {
            width: 100% !important;
            padding-left: 0 !important;
            border-left: none !important;
            border-top: 1px solid #000;
            padding-top: 20px;
        }
        
        #toggleButtonsContainer {
            justify-content: center !important;
            gap: 5px;
        }
        
        #toggleButtonsContainer > div {
            font-size: 12px !important;
            padding: 4px 6px !important;
        }
    }

    #notes-pane {
        font-size: 13px;
        color: #333;
        line-height: 1.4;
    }

    #notes-pane table {
        font-size: inherit;
    }

    #notes-pane td,
    #notes-pane th,
    #notes-pane p,
    #notes-pane li {
        color: inherit;
    }

    #notes-pane .rbt_footnote {
        font-size: inherit;
        color: inherit;
        line-height: inherit;
    }

    #notes-pane .note-location {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
    }

    .hebrew_footnote {
        font-size: 1.5em;
    }

    /* Footnote excerpt styling */
    #notes-pane .notes-table {
        width: 100%;
        border-collapse: collapse;
    }

    #notes-pane .notes-table td:first-child {
        width: 40px;
        vertical-align: top;
        padding-top: 8px;
    }

    #notes-pane .notes-table td:last-child {
        padding: 8px 0;
    }

    #notes-pane .notes-table .footnote-excerpt {
        max-height: 4.2em;
        overflow: hidden;
        position: relative;
        line-height: 1.4;
    }

    #notes-pane .notes-table .footnote-excerpt::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1.4em;
        background: linear-gradient(transparent, #fff);
        pointer-events: none;
    }

    #notes-pane .notes-table .footnote-excerpt.short::after {
        display: none;
    }

    #notes-pane .notes-table .read-more-hint {
        font-size: 11px;
        color: #b78550;
        margin-top: 4px;
        font-style: italic;
    }

    /* Modern footnote reference badge styling */
    a[href*="footnote="] {
        color: #b78550;
        text-decoration: none;
        cursor: pointer;
    }

    a[href*="footnote="] sup {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 600;
        font-style: normal;
        color: #885616;
        background: #d4a57473;
        padding: 1px 4px;
        border-radius: 3px;
        margin: 0 1px;
        vertical-align: super;
        position: relative;
        top: -4px;
        min-width: 14px;
        text-align: center;
        transition: all 0.2s ease;
        line-height: 1.2;
    }

    a[href*="footnote="]:hover sup {
        background: #d0d0d0;
        color: #333;
    }

    /* Footnote popup overlay */
    .footnote-popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.25s ease;
    }

    .footnote-popup-overlay.active {
        display: block;
        opacity: 1;
    }

    /* Footnote popup modal */
    .footnote-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        padding: 0;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        z-index: 10001;
        opacity: 0;
        transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .footnote-popup.active {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .footnote-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #b78550, #d4a574);
        color: #fff;
    }

    .footnote-popup-title {
        font-size: 15px;
        font-weight: 600;
        margin: 0;
    }

    .footnote-popup-close {
        width: 28px;
        height: 28px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #fff;
        transition: background 0.2s ease;
    }

    .footnote-popup-close:hover {
        background: rgba(255, 255, 255, 0.35);
    }

    .footnote-popup-content {
        padding: 20px;
        font-size: 16px;
        line-height: 1.7;
        color: #333;
        overflow-y: auto;
        max-height: calc(80vh - 100px);
    }

    .footnote-popup-content .hebrew_footnote {
        font-size: 1.4em;
    }
    
    /* List styling for footnote content */
    .footnote-popup-content ol,
    .footnote-popup-content ul {
        margin: 10px 0;
        padding-left: 20px;
    }
    
    .footnote-popup-content li {
        margin: 8px 0;
        padding-left: 5px;
    }
    
    .footnote-popup-content li p:first-child {
        margin-top: 0;
    }
    
    .footnote-popup-content li p:last-child {
        margin-bottom: 0;
    }
    
    /* Blockquote styling for footnote content */
    .footnote-popup-content blockquote {
        position: relative;
        margin: 20px 0;
        padding: 15px 20px 15px 60px;
        background: #f9f9f9;
        border-left: 4px solid #4a90e2;
        font-style: italic;
    }
    
    .footnote-popup-content blockquote:before {
        content: '"';
        position: absolute;
        left: 15px;
        top: 10px;
        font-size: 3em;
        color: #4a90e2;
        opacity: 0.3;
        font-family: Georgia, serif;
        line-height: 1;
    }
    
    .footnote-popup-content blockquote:after {
        content: '"';
        position: absolute;
        right: 15px;
        bottom: -10px;
        font-size: 3em;
        color: #4a90e2;
        opacity: 0.3;
        font-family: Georgia, serif;
        line-height: 1;
    }

    .footnote-popup-hint {
        padding: 10px 20px;
        background: #f8f8f8;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #999;
        text-align: center;
    }

    @media (max-width: 600px) {
        .footnote-popup {
            width: 94%;
            max-height: 85vh;
        }
        
        .footnote-popup-content {
            font-size: 15px;
            max-height: calc(85vh - 100px);
        }
        
        .footnote-popup-hint {
            display: none;
        }
    }

    /* Footnote zoom functionality */
    #notes-pane .notes-table tr {
        cursor: pointer;
        transition: background-color 0.2s ease;
        position: relative;
    }

    #notes-pane .notes-table tr:hover {
        background-color: #f8f4f0;
    }

    #notes-pane .notes-table tr:hover .read-more-hint {
        color: #8b5a3c;
    }

    #notes-pane .notes-table tr td {
        position: relative;
    }

    /* Zoom overlay for footnotes */
    .footnote-zoom-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9998;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .footnote-zoom-overlay.active {
        display: block;
        opacity: 1;
    }

    .footnote-zoom-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        padding: 24px 28px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 9999;
        font-size: 18px;
        line-height: 1.7;
        color: #333;
        opacity: 0;
        transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .footnote-zoom-container.active {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .footnote-zoom-container .zoom-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #b78550;
    }

    .footnote-zoom-container .zoom-location {
        font-size: 14px;
        font-weight: 600;
        color: #b78550;
    }

    .footnote-zoom-container .zoom-close {
        width: 32px;
        height: 32px;
        border: none;
        background: #f0f0f0;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #666;
        transition: all 0.2s ease;
    }

    .footnote-zoom-container .zoom-close:hover {
        background: #e0e0e0;
        color: #333;
    }

    .footnote-zoom-container .zoom-content {
        font-size: 18px;
        line-height: 1.8;
    }

    .footnote-zoom-container .zoom-content .hebrew_footnote {
        font-size: 1.6em;
    }

    /* Proper list formatting in zoom content */
    .footnote-zoom-container .zoom-content ul,
    .footnote-zoom-container .zoom-content ol {
        margin: 12px 0;
        padding-left: 28px;
    }

    .footnote-zoom-container .zoom-content li {
        margin-bottom: 8px;
        padding-left: 4px;
    }

    .footnote-zoom-container .zoom-content ul ul,
    .footnote-zoom-container .zoom-content ol ol,
    .footnote-zoom-container .zoom-content ul ol,
    .footnote-zoom-container .zoom-content ol ul {
        margin: 8px 0;
        padding-left: 24px;
    }

    .footnote-zoom-container .zoom-content p {
        margin: 12px 0;
    }

    .footnote-zoom-container .zoom-content p:first-child {
        margin-top: 0;
    }

    .footnote-zoom-container .zoom-content p:last-child {
        margin-bottom: 0;
    }

    .footnote-zoom-container .zoom-hint {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #999;
        text-align: center;
    }

    /* Tap indicator for mobile */
    #notes-pane .notes-table tr::after {
        content: 'üëÜ Tap to enlarge';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        color: #999;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }

    @media (hover: hover) {
        #notes-pane .notes-table tr:hover::after {
            opacity: 1;
        }
        #notes-pane .notes-table tr::after {
            content: 'üîç Click to enlarge';
        }
    }

    @media (max-width: 768px) {
        .footnote-zoom-container {
            width: 92vw;
            padding: 20px;
            max-width: 95vw;
            max-height: 85vh;
            font-size: 17px;
        }

        .footnote-zoom-container .zoom-content {
            font-size: 17px;
        }

        #notes-pane .notes-table tr::after {
            display: none;
        }
    }

    /* Hide touch indicator on desktop */
    .touch-indicator {
        display: none;
    }

    /* Show touch indicator only on mobile/touch devices */
    @media (max-width: 768px), (hover: none) {
        .touch-indicator {
            display: block;
        }
    }
</style>
<!-- Main chapter viewer UI scripts loaded from chapter-viewer.js -->

{% if needs_translation and paraphrase %}
<script>
    // Detect browser back/forward cache (bfcache) loads
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            // Page was loaded from bfcache (browser back/forward button)
            console.log('Page loaded from bfcache, cleaning up active modals and overlays');

            // Hide translation loading modals (several variants used across templates)
            const tlById = document.getElementById('translationLoadingModal');
            if (tlById) {
                try { tlById.style.display = 'none'; } catch(e){}
                tlById.classList.remove('active');
                tlById.style.opacity = '';
            }
            const tlOverlay = document.querySelector('.translation-loading-overlay');
            if (tlOverlay) tlOverlay.classList.remove('active');

            // Close language modal if it was left open
            const langModal = document.getElementById('languageModal');
            if (langModal) langModal.classList.remove('active');

            // Close any active tooltips, footnote popups, and zooms
            document.querySelectorAll('.tooltip.active, .tooltip2.active, .footnote-popup.active, .footnote-zoom-container.active, .footnote-popup-overlay.active, .footnote-zoom-overlay.active, .tooltip-overlay.active, .language-modal-overlay.active').forEach(el => {
                el.classList.remove('active');
                try { el.style.display = 'none'; } catch(e){}
            });

            // Reset body overflow (prevent cut-off page)
            try { document.body.style.overflow = ''; } catch(e){}

            // Scroll to top to avoid any clipped view restored by bfcache
            try { window.scrollTo(0,0); } catch(e){}
        }
    });
    
    document.addEventListener('DOMContentLoaded', function() {
        // Check if this is a reload after successful translation (has _t parameter)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('_t')) {
            console.log("Post-translation reload detected, skipping translation trigger");
            // Clean up the URL by removing the _t parameter
            urlParams.delete('_t');
            const cleanUrl = window.location.pathname + (urlParams.toString() ? '?' + urlParams.toString() : '');
            window.history.replaceState({}, '', cleanUrl);
            // Hide modal if visible
            var modal = document.getElementById('translationLoadingModal');
            if (modal) modal.style.display = 'none';
            return; // Don't trigger translation again
        }
        
        // Check server-side flag whether translation is needed
        const needsTranslation = {{ needs_translation|yesno:'true,false'|default:'false' }};
        if (!needsTranslation) {
            console.log('No translations required (cached). Skipping translation trigger.');
            return; // Do not show the modal or start a translation job
        }

        console.log("Translations needed, triggering API...");
        
        // Use original book name from context (not display name)
        const book = '{{ original_book|default:book }}';
        const chapter = '{{ chapter_num }}';
        const lang = '{{ current_language }}';
        
        console.log(`Triggering translation for: ${book} ch${chapter} (${lang})`);

        if (book && chapter && lang && lang !== 'en') {
            // Prevent rapid re-triggers from reload or quick refreshes
            try {
                const triggerKey = `trans_trigger:${book}:${chapter}:${lang}`;
                const last = sessionStorage.getItem(triggerKey);
                if (last && (Date.now() - parseInt(last, 10) < 30000)) { // 30s guard
                    console.log('Translation recently triggered; skipping re-trigger.');
                    return;
                }
                sessionStorage.setItem(triggerKey, String(Date.now()));
            } catch (e) { /* sessionStorage may be unavailable */ }

            // Small delay to ensure page content is rendered before showing modal
            setTimeout(function() {
                // Show the loading modal
                var modal = document.getElementById('translationLoadingModal');
                var progressText = document.getElementById('translationProgressText');
                if (modal) modal.style.display = 'flex';
                if (typeof showTranslationLoading === 'function') {
                    showTranslationLoading();
                }
                
                // Update progress text
                if (progressText) progressText.textContent = 'Starting background translation job...';
                
                // Start background translation job (non-blocking)
                fetch(`/api/translation/start/?book=${encodeURIComponent(book)}&chapter=${chapter}&lang=${lang}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ok' && data.job_id) {
                            console.log("Translation job started:", data.job_id);
                            if (progressText) progressText.textContent = 'Translation job started. Processing...';
                            
                            // Poll for job status
                            pollJobStatus(data.job_id, book, chapter, lang, progressText);
                        } else if (data.status === 'ok' && !data.job_id) {
                            // No translation needed (cached)
                            console.log('No translation required; cached.');
                            if (progressText) {
                                progressText.innerHTML = '<span style="color: #2e7d32;">‚úÖ Translation already available in cache.</span>';
                            }
                            setTimeout(() => {
                                if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                            }, 1500);
                        } else {
                            console.error('Failed to start translation job:', data.message);
                            if (progressText) {
                                progressText.innerHTML = '<span style="color: #d32f2f;">‚ö†Ô∏è Failed to start translation</span><br><span style="font-size: 11px; color: #666;">' + (data.message || 'Unknown error') + '</span>';
                            }
                            setTimeout(() => {
                                if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                            }, 5000);
                        }
                    })
                    .catch(err => {
                        console.error('API Error:', err);
                        if (progressText) {
                            progressText.innerHTML = '<span style="color: #d32f2f;">‚ö†Ô∏è Connection failed</span><br><span style="font-size: 11px; color: #666;">Unable to connect to translation service.</span>';
                        }
                        setTimeout(() => {
                            if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                        }, 5000);
                    });
            }, 100);
        }
    });
    
    // Poll for translation job status
    function pollJobStatus(jobId, book, chapter, lang, progressText) {
        const pollInterval = 2000; // Poll every 2 seconds
        const maxPolls = 300; // Max 10 minutes (300 * 2 seconds)
        let pollCount = 0;
        
        const poll = () => {
            pollCount++;
            
            fetch(`/api/translation/status/?job_id=${jobId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Job status:", data);
                    
                    if (data.status === 'completed') {
                        // Job completed successfully
                        const verses = data.translated_verses || 0;
                        const footnotes = data.translated_footnotes || 0;
                        if (progressText) {
                            progressText.textContent = `Translated ${verses} verses and ${footnotes} footnotes. Clearing cache...`;
                        }
                        
                        // Clear cache and reload
                        fetch(`/api/translation/clear-cache/?book=${encodeURIComponent(book)}&chapter=${chapter}&lang=${lang}`)
                            .then(() => {
                                if (progressText) progressText.textContent = 'Reloading page...';
                                setTimeout(() => {
                                    const url = new URL(window.location.href);
                                    url.searchParams.set('_t', Date.now());
                                    window.location.href = url.toString();
                                }, 500);
                            });
                            
                    } else if (data.status === 'failed') {
                        // Job failed
                        console.error('Translation job failed:', data.error);
                        if (progressText) {
                            let errorMsg = data.error || 'Unknown error';
                            if (errorMsg.includes('quota') || errorMsg.includes('429')) {
                                progressText.innerHTML = '<span style="color: #d32f2f;">‚ö†Ô∏è Translation quota exhausted</span><br><span style="font-size: 11px; color: #666;">API limits reached. Please try again later.</span>';
                            } else {
                                progressText.innerHTML = '<span style="color: #d32f2f;">‚ö†Ô∏è Translation failed</span><br><span style="font-size: 11px; color: #666;">' + errorMsg + '</span>';
                            }
                        }
                        setTimeout(() => {
                            if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                        }, 5000);
                        
                    } else if (data.status === 'processing' || data.status === 'pending') {
                        // Still processing - update progress and poll again
                        const progress = data.progress || 0;
                        const verses = data.translated_verses || 0;
                        const totalVerses = data.total_verses || 0;
                        const footnotes = data.translated_footnotes || 0;
                        const totalFootnotes = data.total_footnotes || 0;
                        
                        if (progressText) {
                            if (data.status === 'pending' && data.queue_position) {
                                // Show queue position
                                let queueMsg = `Position in queue: #${data.queue_position}`;
                                if (data.current_job) {
                                    queueMsg += `<br><span style="font-size: 11px; color: #666;">Currently processing: ${data.current_job.book} ${data.current_job.chapter} (${data.current_job.progress}%)</span>`;
                                }
                                progressText.innerHTML = queueMsg;
                            } else if (totalVerses > 0 || totalFootnotes > 0) {
                                progressText.textContent = `Translating ${data.book || ''} ${data.chapter || ''}... ${progress}% (${verses}/${totalVerses} verses, ${footnotes}/${totalFootnotes} footnotes)`;
                            } else {
                                progressText.textContent = data.status === 'pending' ? 'Starting translation...' : 'Processing translation...';
                            }
                        }
                        
                        if (pollCount < maxPolls) {
                            setTimeout(poll, pollInterval);
                        } else {
                            // Timeout
                            if (progressText) {
                                progressText.innerHTML = '<span style="color: #d32f2f;">‚ö†Ô∏è Translation timeout</span><br><span style="font-size: 11px; color: #666;">Translation is taking too long. It will continue in the background.</span>';
                            }
                            setTimeout(() => {
                                if (typeof hideTranslationLoading === 'function') hideTranslationLoading();
                            }, 5000);
                        }
                        
                    } else {
                        // Unknown status
                        console.warn('Unknown job status:', data.status);
                        if (pollCount < maxPolls) {
                            setTimeout(poll, pollInterval);
                        }
                    }
                })
                .catch(err => {
                    console.error('Poll error:', err);
                    // Retry a few times on network errors
                    if (pollCount < maxPolls) {
                        setTimeout(poll, pollInterval * 2);
                    }
                });
        };
        
        // Start polling
        poll();
    }
</script>
{% endif %}

{% endblock %}