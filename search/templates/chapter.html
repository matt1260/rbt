{% extends 'base.html' %}
{% block title %}Real Bible Translation - {{ page_title }}{% endblock %}
{% load custom_tags %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" crossorigin="anonymous">
<p><a href="/">Back to Search</a></p>

<!-- make this a python generated variable depending on book i.e. 'Genesis Chapters: '-->
<div style="padding-bottom: 20px;">
<strong>Select a Chapter:</strong>
    {{ chapters|safe }}
</div>

<h1>{{ book }} {{ chapter_num }}</h1>
{% with title_prefix=book|title %}
<div id="toggleButtonsContainer">
    <div id="h5ToggleButton"><i class="fas fa-eye-slash"></i> Headers (H)</div>
    <div id="imageToggleButton"><i class="fas fa-eye-slash"></i> Images (I)</div>
    <div id="literalToggleButton"><i class="fas fa-eye"></i> Literal (L)</div>
    <div id="verseRefToggleButton"><i class="fas fa-eye-slash"></i> Verse References (V)</div>
    <div id="parenthesesToggleButton"><i class="fas fa-eye"></i> Names (P)</div>
    <div id="notesToggleButton"><i class="fas fa-book"></i> Notes (N)</div>
    <div id="fontDecreaseButton"><i class="fas fa-minus"></i></div>
    <div id="fontIncreaseButton"><i class="fas fa-plus"></i></div>
</div>

{% endwith %}
<div id="container" style="display: flex; justify-content: space-between;">
    <div id="paraphraseContainer" style="width: 50%; padding-right: 10px;">
        <h4>RBT Paraphrase</h4>
        {% if paraphrase %}
            {{ paraphrase|safe }}
        {% else %}
            <p>No results found for chapter {{ chapter_num }}.</p>
        {% endif %}
    </div>

    <div id="toggleDivContainer" style="width: 50%; padding-left: 10px; border-left: 1px solid #000; display: none;">
        <div id="literal-pane" style="display: none;">
            <h4>RBT Hebrew Literal</h4>
            {% if html %}
                {{ html|safe }}
            {% else %}
                <p>No results found for chapter {{ chapter_num }}.</p>
            {% endif %}
        </div>

        <div id="notes-pane" style="display: none;">
            <h4>Notes</h4>
            {% if notes_html %}
                {{ notes_html|safe }}
            {% else %}
                <p class="notes-empty">No notes collected for this chapter.</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .notes-empty {
        margin: 0;
        font-size: 14px;
        color: #666;
    }

    /* Modern toolbar container */
    #toggleButtonsContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 8px;
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 8px 12px;
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    /* Toolbar buttons */
    #toggleButtonsContainer > div {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        padding: 6px 12px;
        color: #ba8666;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    /* Hover and active states */
    #toggleButtonsContainer > div:hover {
        background: #f4ebe5;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    /* Icon styling */
    #toggleButtonsContainer i {
        color: #ba8666;
        font-size: 14px;
    }

    #paraphraseContainer {
        margin-bottom: 20px;
    }

    /* Mobile styles */
    @media (max-width: 768px) {
        #container {
            flex-direction: column !important;
        }
        
        #paraphraseContainer {
            width: 100% !important;
            padding-right: 0 !important;
            margin-bottom: 20px;
        }
        
        #toggleDivContainer {
            width: 100% !important;
            padding-left: 0 !important;
            border-left: none !important;
            border-top: 1px solid #000;
            padding-top: 20px;
        }
        
        #toggleButtonsContainer {
            justify-content: center !important;
            gap: 5px;
        }
        
        #toggleButtonsContainer > div {
            font-size: 12px !important;
            padding: 4px 6px !important;
        }
    }

    #notes-pane {
        font-size: 13px;
        color: #333;
        line-height: 1.4;
    }

    #notes-pane table {
        font-size: inherit;
    }

    #notes-pane td,
    #notes-pane th,
    #notes-pane p,
    #notes-pane li {
        color: inherit;
    }

    #notes-pane .rbt_footnote {
        font-size: inherit;
        color: inherit;
        line-height: inherit;
    }

    #notes-pane .note-location {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
    }

    .hebrew_footnote {
        font-size: 1.5em;
    }

    /* Footnote excerpt styling */
    #notes-pane .notes-table {
        width: 100%;
        border-collapse: collapse;
    }

    #notes-pane .notes-table td:first-child {
        width: 40px;
        vertical-align: top;
        padding-top: 8px;
    }

    #notes-pane .notes-table td:last-child {
        padding: 8px 0;
    }

    #notes-pane .notes-table .footnote-excerpt {
        max-height: 4.2em;
        overflow: hidden;
        position: relative;
        line-height: 1.4;
    }

    #notes-pane .notes-table .footnote-excerpt::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 1.4em;
        background: linear-gradient(transparent, #fff);
        pointer-events: none;
    }

    #notes-pane .notes-table .footnote-excerpt.short::after {
        display: none;
    }

    #notes-pane .notes-table .read-more-hint {
        font-size: 11px;
        color: #b78550;
        margin-top: 4px;
        font-style: italic;
    }

    /* Modern footnote reference badge styling */
    a[href*="footnote="] {
        color: #b78550;
        text-decoration: none;
        cursor: pointer;
    }

    a[href*="footnote="] sup {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 9px;
        font-weight: 600;
        font-style: normal;
        color: #a26b24;
        background: #e8e8e8;
        padding: 1px 4px;
        border-radius: 3px;
        margin: 0 1px;
        vertical-align: super;
        position: relative;
        top: -4px;
        min-width: 14px;
        text-align: center;
        transition: all 0.2s ease;
        line-height: 1.2;
    }

    a[href*="footnote="]:hover sup {
        background: #d0d0d0;
        color: #333;
    }

    /* Footnote popup overlay */
    .footnote-popup-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.25s ease;
    }

    .footnote-popup-overlay.active {
        display: block;
        opacity: 1;
    }

    /* Footnote popup modal */
    .footnote-popup {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        padding: 0;
        width: 90%;
        max-width: 500px;
        max-height: 80vh;
        overflow: hidden;
        z-index: 10001;
        opacity: 0;
        transition: opacity 0.25s ease, transform 0.25s ease;
    }

    .footnote-popup.active {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .footnote-popup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px;
        background: linear-gradient(135deg, #b78550, #d4a574);
        color: #fff;
    }

    .footnote-popup-title {
        font-size: 15px;
        font-weight: 600;
        margin: 0;
    }

    .footnote-popup-close {
        width: 28px;
        height: 28px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #fff;
        transition: background 0.2s ease;
    }

    .footnote-popup-close:hover {
        background: rgba(255, 255, 255, 0.35);
    }

    .footnote-popup-content {
        padding: 20px;
        font-size: 16px;
        line-height: 1.7;
        color: #333;
        overflow-y: auto;
        max-height: calc(80vh - 100px);
    }

    .footnote-popup-content .hebrew_footnote {
        font-size: 1.4em;
    }

    .footnote-popup-hint {
        padding: 10px 20px;
        background: #f8f8f8;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #999;
        text-align: center;
    }

    @media (max-width: 600px) {
        .footnote-popup {
            width: 94%;
            max-height: 85vh;
        }
        
        .footnote-popup-content {
            font-size: 15px;
            max-height: calc(85vh - 100px);
        }
        
        .footnote-popup-hint {
            display: none;
        }
    }

    /* Footnote zoom functionality */
    #notes-pane .notes-table tr {
        cursor: pointer;
        transition: background-color 0.2s ease;
        position: relative;
    }

    #notes-pane .notes-table tr:hover {
        background-color: #f8f4f0;
    }

    #notes-pane .notes-table tr:hover .read-more-hint {
        color: #8b5a3c;
    }

    #notes-pane .notes-table tr td {
        position: relative;
    }

    /* Zoom overlay for footnotes */
    .footnote-zoom-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        z-index: 9998;
        opacity: 0;
        transition: opacity 0.2s ease;
    }

    .footnote-zoom-overlay.active {
        display: block;
        opacity: 1;
    }

    .footnote-zoom-container {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        padding: 24px 28px;
        max-width: 90vw;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 9999;
        font-size: 18px;
        line-height: 1.7;
        color: #333;
        opacity: 0;
        transition: opacity 0.2s ease, transform 0.2s ease;
    }

    .footnote-zoom-container.active {
        display: block;
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }

    .footnote-zoom-container .zoom-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 12px;
        border-bottom: 2px solid #b78550;
    }

    .footnote-zoom-container .zoom-location {
        font-size: 14px;
        font-weight: 600;
        color: #b78550;
    }

    .footnote-zoom-container .zoom-close {
        width: 32px;
        height: 32px;
        border: none;
        background: #f0f0f0;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        color: #666;
        transition: all 0.2s ease;
    }

    .footnote-zoom-container .zoom-close:hover {
        background: #e0e0e0;
        color: #333;
    }

    .footnote-zoom-container .zoom-content {
        font-size: 18px;
        line-height: 1.8;
    }

    .footnote-zoom-container .zoom-content .hebrew_footnote {
        font-size: 1.6em;
    }

    /* Proper list formatting in zoom content */
    .footnote-zoom-container .zoom-content ul,
    .footnote-zoom-container .zoom-content ol {
        margin: 12px 0;
        padding-left: 28px;
    }

    .footnote-zoom-container .zoom-content li {
        margin-bottom: 8px;
        padding-left: 4px;
    }

    .footnote-zoom-container .zoom-content ul ul,
    .footnote-zoom-container .zoom-content ol ol,
    .footnote-zoom-container .zoom-content ul ol,
    .footnote-zoom-container .zoom-content ol ul {
        margin: 8px 0;
        padding-left: 24px;
    }

    .footnote-zoom-container .zoom-content p {
        margin: 12px 0;
    }

    .footnote-zoom-container .zoom-content p:first-child {
        margin-top: 0;
    }

    .footnote-zoom-container .zoom-content p:last-child {
        margin-bottom: 0;
    }

    .footnote-zoom-container .zoom-hint {
        margin-top: 16px;
        padding-top: 12px;
        border-top: 1px solid #eee;
        font-size: 12px;
        color: #999;
        text-align: center;
    }

    /* Tap indicator for mobile */
    #notes-pane .notes-table tr::after {
        content: 'üëÜ Tap to enlarge';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 11px;
        color: #999;
        opacity: 0;
        transition: opacity 0.2s ease;
        pointer-events: none;
    }

    @media (hover: hover) {
        #notes-pane .notes-table tr:hover::after {
            opacity: 1;
        }
        #notes-pane .notes-table tr::after {
            content: 'üîç Click to enlarge';
        }
    }

    @media (max-width: 768px) {
        .footnote-zoom-container {
            width: 92vw;
            padding: 20px;
            max-width: 95vw;
            max-height: 85vh;
            font-size: 17px;
        }

        .footnote-zoom-container .zoom-content {
            font-size: 17px;
        }

        #notes-pane .notes-table tr::after {
            display: none;
        }
    }

    /* Hide touch indicator on desktop */
    .touch-indicator {
        display: none;
    }

    /* Show touch indicator only on mobile/touch devices */
    @media (max-width: 768px), (hover: none) {
        .touch-indicator {
            display: block;
        }
    }

    /* Responsive images and videos in tooltip containers */
    .tooltip-container img,
    .tooltip-container video {
        max-width: 500px;
        width: 100% !important;
        height: auto !important;
        display: block;
        margin: 0 auto;
    }

    @media (max-width: 768px) {
        .tooltip-container img,
        .tooltip-container video {
            max-width: 100%;
            width: 100% !important;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Parentheses toggle logic
        function wrapParenthesesText(element) {
            if (!element) return;
            // Only wrap text nodes, not HTML tags
            function wrapTextNodes(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    // Replace space + ( ... ) with span (include preceding space)
                    // Only match parentheses that contain double-quoted text, e.g. ("word")
                    let replaced = node.textContent.replace(/\s\(\s*\"([^\"]+)\"\s*\)/g, function(match) {
                        return '<span class="paren-hide">' + match + '</span>';
                    });
                    if (replaced !== node.textContent) {
                        const temp = document.createElement('span');
                        temp.innerHTML = replaced;
                        while (temp.firstChild) {
                            node.parentNode.insertBefore(temp.firstChild, node);
                        }
                        node.parentNode.removeChild(node);
                    }
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    Array.from(node.childNodes).forEach(wrapTextNodes);
                }
            }
            wrapTextNodes(element);
        }

        // Wrap parentheses in both areas on page load
        wrapParenthesesText(document.getElementById('paraphraseContainer'));
        wrapParenthesesText(document.getElementById('literal-pane'));
        
        // Hide parentheses by default (including server-side rendered ones)
        setTimeout(() => {
            document.querySelectorAll('.paren-hide').forEach(span => {
                span.style.setProperty('display', 'none', 'important');
            });
        }, 0);

        const literalToggleButton = document.getElementById("literalToggleButton");
        const imageToggleButton = document.getElementById("imageToggleButton");
        const h5ToggleButton = document.getElementById("h5ToggleButton");
        const verseRefToggleButton = document.getElementById("verseRefToggleButton");
        const parenthesesToggleButton = document.getElementById("parenthesesToggleButton");
        const notesToggleButton = document.getElementById("notesToggleButton");
        const toggleDivContainer = document.getElementById("toggleDivContainer");
        const paraphraseContainer = document.getElementById("paraphraseContainer");
        const container = document.getElementById("container");
        const verseRefs = document.querySelectorAll(".verse_ref");
        const literalPane = document.getElementById("literal-pane");
        const notesPane = document.getElementById("notes-pane");
        const fontDecreaseButton = document.getElementById("fontDecreaseButton");
        const fontIncreaseButton = document.getElementById("fontIncreaseButton");
        
        // Check if device is mobile
        const isMobile = window.innerWidth <= 768;
        
        // Font size management
        let currentFontSize = 100; // percentage
        const MIN_FONT_SIZE = 80;
        const MAX_FONT_SIZE = 150;
        const FONT_STEP = 10;
        
        function updateFontSize() {
            document.getElementById('container').style.fontSize = currentFontSize + '%';
            localStorage.setItem('chapterFontSize', currentFontSize);
        }
        
        // Load saved font size
        const savedFontSize = localStorage.getItem('chapterFontSize');
        if (savedFontSize) {
            currentFontSize = parseInt(savedFontSize);
            updateFontSize();
        }
        
        let isLiteralVisible = false; // Hide literal by default
        let isImageVisible = true;
        let isH5Visible = true;
        let isVerseRefVisible = false;
        let isParenthesesVisible = false;
        let isNotesVisible = false; // Hide notes by default

        function updateLiteralButtonLabel() {
            literalToggleButton.innerHTML = isLiteralVisible
                ? '<i class="fas fa-eye-slash"></i> Literal (L)'
                : '<i class="fas fa-eye"></i> Literal (L)';
        }

        function updateLayout() {
            const isWideScreen = window.innerWidth > 768;

            if (isNotesVisible) {
                notesPane.style.display = "block";
                literalPane.style.display = "none";
                toggleDivContainer.style.display = "block";
                paraphraseContainer.style.width = isWideScreen ? "50%" : "100%";
                notesToggleButton.innerHTML = '<i class="fas fa-book-open"></i> Notes (N)';
            } else {
                notesPane.style.display = "none";
                literalPane.style.display = isLiteralVisible ? "block" : "none";

                if (isLiteralVisible) {
                    toggleDivContainer.style.display = "block";
                    paraphraseContainer.style.width = isWideScreen ? "50%" : "100%";
                } else {
                    toggleDivContainer.style.display = "none";
                    paraphraseContainer.style.width = "100%";
                }

                 notesToggleButton.innerHTML = '<i class="fas fa-book"></i> Notes (N)';
            }

            updateLiteralButtonLabel();
        }

        updateLayout();
        
        function toggleVerseRefs() {
            verseRefs.forEach(function(ref) {
                if (isVerseRefVisible) {
                    ref.style.display = "none";
                } else {
                    ref.style.display = "inline"; // Change to "block" if necessary
                }
            });
            isVerseRefVisible = !isVerseRefVisible; // Toggle the visibility state
            verseRefToggleButton.innerHTML = isVerseRefVisible ? '<i class="fas fa-eye-slash"></i> Verse References (V)' : '<i class="fas fa-eye"></i> Verse References (V)';
        }

        literalToggleButton.addEventListener("click", function() {
            if (isNotesVisible) {
                // Override notes view: show literal instead
                isNotesVisible = false;
                isLiteralVisible = true;
            } else {
                isLiteralVisible = !isLiteralVisible;
            }

            updateLayout();
        });

        h5ToggleButton.addEventListener("click", function() {
            const h5Elements = document.querySelectorAll("h3, h4, h5, h6");
            h5Elements.forEach(function(element) {
                if (isH5Visible) {
                    element.style.display = "none";
                    h5ToggleButton.innerHTML = '<i class="fas fa-eye"></i> Headers (H)';
                } else {
                    element.style.display = "block";
                    h5ToggleButton.innerHTML = '<i class="fas fa-eye-slash"></i> Headers (H)';
                }
            });
            isH5Visible = !isH5Visible; // Toggle the visibility state
        });

        imageToggleButton.addEventListener("click", function() {
            const tooltipContainers = document.querySelectorAll(".tooltip-container");
            tooltipContainers.forEach(function(container) {
                if (isImageVisible) {
                    container.style.display = "none";
                    imageToggleButton.innerHTML = '<i class="fas fa-eye"></i> Images (I)';
                } else {
                    container.style.display = "block";
                    imageToggleButton.innerHTML = '<i class="fas fa-eye-slash"></i> Images (I)';
                }
            });
            isImageVisible = !isImageVisible; // Toggle the visibility state
        });

        verseRefToggleButton.addEventListener("click", function() {
            toggleVerseRefs();
        });

        notesToggleButton.addEventListener("click", function() {
            isNotesVisible = !isNotesVisible;
            updateLayout();
        });
        
        function toggleParentheses() {
            document.querySelectorAll('.paren-hide').forEach(span => {
                if (isParenthesesVisible) {
                    span.style.setProperty('display', 'none', 'important');
                } else {
                    span.style.setProperty('display', 'inline', 'important');
                }
            });
            isParenthesesVisible = !isParenthesesVisible;
            parenthesesToggleButton.innerHTML = isParenthesesVisible ? 
                '<i class="fas fa-eye-slash"></i> Names (P)' : 
                '<i class="fas fa-eye"></i> Names (P)';
        }
        
        parenthesesToggleButton.addEventListener("click", toggleParentheses);
        
        fontIncreaseButton.addEventListener("click", function() {
            if (currentFontSize < MAX_FONT_SIZE) {
                currentFontSize += FONT_STEP;
                updateFontSize();
            }
        });
        
        fontDecreaseButton.addEventListener("click", function() {
            if (currentFontSize > MIN_FONT_SIZE) {
                currentFontSize -= FONT_STEP;
                updateFontSize();
            }
        });

        function handleKeyDown(event) {
            // Don't trigger if user is typing in an input
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }
            
            if (event.key === "v") {
                toggleVerseRefs();
            } else if (event.key === "h") { 
                h5ToggleButton.click();
            } else if (event.key === "i") { 
                imageToggleButton.click();
            } else if (event.key === "l") { 
                literalToggleButton.click();
            } else if (event.key === "p") {
                toggleParentheses();
            } else if (event.key === "n") {
                notesToggleButton.click();
            } else if (event.key === "+" || event.key === "=") {
                fontIncreaseButton.click();
            } else if (event.key === "-" || event.key === "_") {
                fontDecreaseButton.click();
            }
        }
        document.addEventListener("keydown", handleKeyDown);

        // Handle window resize
        window.addEventListener('resize', function() {
            const currentIsMobile = window.innerWidth <= 768;
            if (currentIsMobile !== isMobile) {
                location.reload(); // Reload page to reset mobile state
            }
        });

        // Initialize verse references as hidden
        toggleVerseRefs();

        const paneButtons = document.querySelectorAll('#toggleDivContainer .pane-button');
        const paneContents = document.querySelectorAll('#toggleDivContainer .pane-content');

        paneButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');

                paneButtons.forEach((btn) => btn.classList.toggle('active', btn === button));
                paneContents.forEach((pane) => pane.classList.toggle('active', pane.id === targetId));
            });
        });

        // ============================================
        // Footnote Zoom Functionality
        // ============================================
        
        // Create zoom overlay and container elements
        const zoomOverlay = document.createElement('div');
        zoomOverlay.className = 'footnote-zoom-overlay';
        document.body.appendChild(zoomOverlay);

        const zoomContainer = document.createElement('div');
        zoomContainer.className = 'footnote-zoom-container';
        zoomContainer.innerHTML = `
            <div class="zoom-header">
                <span class="zoom-location"></span>
                <button class="zoom-close" aria-label="Close">&times;</button>
            </div>
            <div class="zoom-content"></div>
            <div class="zoom-hint">Press Escape or click outside to close</div>
        `;
        document.body.appendChild(zoomContainer);

        const zoomLocation = zoomContainer.querySelector('.zoom-location');
        const zoomContent = zoomContainer.querySelector('.zoom-content');
        const zoomClose = zoomContainer.querySelector('.zoom-close');

        function openFootnoteZoom(row) {
            // Get the footnote content from the second cell (the content cell)
            const cells = row.querySelectorAll('td');
            if (cells.length < 2) return;

            const contentCell = cells[1];
            const locationEl = contentCell.querySelector('.note-location');
            const location = locationEl ? locationEl.textContent : '';
            
            // Use stored full content if available, otherwise clone
            let fullContent;
            if (contentCell.hasAttribute('data-full-content')) {
                fullContent = contentCell.getAttribute('data-full-content');
                // Remove the note-location from the full content for display
                const temp = document.createElement('div');
                temp.innerHTML = fullContent;
                const locEl = temp.querySelector('.note-location');
                if (locEl) locEl.remove();
                fullContent = temp.innerHTML;
            } else {
                // Fallback: Clone content without the location div
                const contentClone = contentCell.cloneNode(true);
                const locClone = contentClone.querySelector('.note-location');
                if (locClone) locClone.remove();
                fullContent = contentClone.innerHTML;
            }

            zoomLocation.textContent = location;
            zoomContent.innerHTML = fullContent;

            // Activate with slight delay for animation
            requestAnimationFrame(() => {
                zoomOverlay.classList.add('active');
                zoomContainer.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        }

        function closeFootnoteZoom() {
            zoomOverlay.classList.remove('active');
            zoomContainer.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Wrap footnote content in excerpt containers for truncation
        function wrapFootnoteExcerpts() {
            const footnoteRows = document.querySelectorAll('#notes-pane .notes-table tr');
            footnoteRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 2) return;
                
                const contentCell = cells[1];
                // Skip if already wrapped
                if (contentCell.querySelector('.footnote-excerpt')) return;
                
                // Find the note-location element
                const locationEl = contentCell.querySelector('.note-location');
                
                // Get all content except the location
                const excerptWrapper = document.createElement('div');
                excerptWrapper.className = 'footnote-excerpt';
                
                // Store original full HTML for the modal
                const fullContentHtml = contentCell.innerHTML;
                contentCell.setAttribute('data-full-content', fullContentHtml);
                
                // Move non-location content into the excerpt wrapper
                Array.from(contentCell.childNodes).forEach(node => {
                    if (node !== locationEl) {
                        excerptWrapper.appendChild(node.cloneNode(true));
                    }
                });
                
                // Clear and rebuild the cell
                contentCell.innerHTML = '';
                if (locationEl) contentCell.appendChild(locationEl);
                contentCell.appendChild(excerptWrapper);
                
                // Add "tap to read" hint
                const hint = document.createElement('div');
                hint.className = 'read-more-hint';
                hint.textContent = 'Tap to read full note';
                contentCell.appendChild(hint);
                
                // After a frame, check if content is short (doesn't overflow)
                requestAnimationFrame(() => {
                    if (excerptWrapper.scrollHeight <= excerptWrapper.clientHeight + 5) {
                        excerptWrapper.classList.add('short');
                        hint.style.display = 'none';
                    }
                });
            });
        }

        // Attach click listeners to footnote rows
        function attachFootnoteZoomListeners() {
            const footnoteRows = document.querySelectorAll('#notes-pane .notes-table tr');
            footnoteRows.forEach(row => {
                row.addEventListener('click', function(e) {
                    // Don't zoom if clicking a link
                    if (e.target.tagName === 'A') return;
                    openFootnoteZoom(row);
                });
            });
        }

        // Close handlers
        zoomClose.addEventListener('click', closeFootnoteZoom);
        zoomOverlay.addEventListener('click', closeFootnoteZoom);

        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && zoomContainer.classList.contains('active')) {
                closeFootnoteZoom();
            }
        });

        // Prevent closing when clicking inside the zoom container
        zoomContainer.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Initialize footnote excerpts and zoom listeners
        wrapFootnoteExcerpts();
        attachFootnoteZoomListeners();

        // Re-wrap and re-attach listeners when notes pane changes (in case it loads dynamically)
        const notesObserver = new MutationObserver(function() {
            wrapFootnoteExcerpts();
            attachFootnoteZoomListeners();
        });
        if (notesPane) {
            notesObserver.observe(notesPane, { childList: true, subtree: true });
        }

        // ============================================
        // Inline Footnote Popup System
        // ============================================
        
        // Create popup overlay and container
        let footnotePopupOverlay = document.createElement('div');
        footnotePopupOverlay.className = 'footnote-popup-overlay';
        document.body.appendChild(footnotePopupOverlay);

        let footnotePopup = document.createElement('div');
        footnotePopup.className = 'footnote-popup';
        footnotePopup.innerHTML = `
            <div class="footnote-popup-header">
                <h3 class="footnote-popup-title">Footnote</h3>
                <button class="footnote-popup-close" aria-label="Close">&times;</button>
            </div>
            <div class="footnote-popup-content"></div>
            <div class="footnote-popup-hint">Press Escape or click outside to close</div>
        `;
        document.body.appendChild(footnotePopup);

        const footnotePopupTitle = footnotePopup.querySelector('.footnote-popup-title');
        const footnotePopupContent = footnotePopup.querySelector('.footnote-popup-content');
        const footnotePopupClose = footnotePopup.querySelector('.footnote-popup-close');

        function showFootnotePopup(footnoteId, content, title) {
            footnotePopupTitle.textContent = title || 'Footnote ' + footnoteId;
            footnotePopupContent.innerHTML = content || '<p>Loading footnote content...</p>';
            
            requestAnimationFrame(() => {
                footnotePopupOverlay.classList.add('active');
                footnotePopup.classList.add('active');
                document.body.style.overflow = 'hidden';
            });
        }

        function closeFootnotePopup() {
            footnotePopupOverlay.classList.remove('active');
            footnotePopup.classList.remove('active');
            document.body.style.overflow = '';
        }

        // Close handlers for popup
        footnotePopupClose.addEventListener('click', function(e) {
            e.stopPropagation();
            closeFootnotePopup();
        });
        
        footnotePopupOverlay.addEventListener('click', closeFootnotePopup);
        
        footnotePopup.addEventListener('click', function(e) {
            e.stopPropagation();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && footnotePopup.classList.contains('active')) {
                closeFootnotePopup();
            }
        });

        // Pre-load footnote data from notes table
        const footnoteCache = {};
        function preloadFootnoteData() {
            // Strategy: Find all footnote links in the content (paraphrase & literal panes)
            // and match them to content in the notes table by verse reference
            
            const allFootnoteLinks = document.querySelectorAll('a[href*="?footnote="]');
            const notesPane = document.getElementById('notes-pane');
            
            if (!notesPane) {
                console.log('Notes pane not found');
                return;
            }
            
            const notesTable = notesPane.querySelector('table');
            if (!notesTable) {
                console.log('Notes table not found');
                return;
            }
            
            console.log('Found', allFootnoteLinks.length, 'footnote links in content');
            
            // Build a map of verse references to table rows
            const verseToRows = {};
            const footnoteRows = notesTable.querySelectorAll('tr');
            
            footnoteRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                if (cells.length < 2) return;
                
                const verseRef = cells[0].textContent.trim(); // e.g., "Eze. 16:4"
                if (!verseRef) return;
                
                if (!verseToRows[verseRef]) {
                    verseToRows[verseRef] = [];
                }
                
                const contentCell = cells[1];
                const locationEl = contentCell.querySelector('.note-location');
                const location = locationEl ? locationEl.textContent.trim() : verseRef;
                
                let content;
                if (contentCell.hasAttribute('data-full-content')) {
                    content = contentCell.getAttribute('data-full-content');
                } else {
                    const contentClone = contentCell.cloneNode(true);
                    const locClone = contentClone.querySelector('.note-location');
                    if (locClone) locClone.remove();
                    content = contentClone.innerHTML;
                }
                
                verseToRows[verseRef].push({ location, content });
            });
            
            // Now match footnote links to table rows
            allFootnoteLinks.forEach(link => {
                const href = link.getAttribute('href');
                const match = href.match(/[?&]footnote=([^&]+)/);
                if (!match) return;
                
                const footnoteId = match[1]; // e.g., "Eze-16-13-05"
                
                // Parse the verse reference from the ID: "Eze-16-13-05" -> "Eze. 16:13"
                const parts = footnoteId.split('-');
                if (parts.length < 3) return;
                
                const book = parts[0];
                const chapter = parts[1];
                const verse = parts[2];
                const verseRef = `${book}. ${chapter}:${verse}`;
                
                // Find matching rows for this verse
                const rows = verseToRows[verseRef];
                if (rows && rows.length > 0) {
                    // Use the first matching row (or we could try to match by position)
                    const rowIndex = Math.min(rows.length - 1, 0);
                    footnoteCache[footnoteId] = {
                        title: rows[rowIndex].location,
                        content: rows[rowIndex].content
                    };
                }
            });
            
            console.log('Pre-loaded', Object.keys(footnoteCache).length, 'footnotes');
        }
        
        // Pre-load on page load
        preloadFootnoteData();

        // Attach click handlers to inline footnote links
        function attachFootnotePopupHandlers() {
            const footnoteLinks = document.querySelectorAll('a[href*="?footnote="]');
            
            footnoteLinks.forEach(link => {
                // Skip if already handled or is inside notes panel
                if (link.dataset.footnoteHandled) return;
                if (link.closest('#notes-pane')) return;
                
                link.dataset.footnoteHandled = 'true';
                
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const href = link.getAttribute('href');
                    const match = href.match(/\?footnote=([^&]+)/);
                    if (!match) return;
                    
                    const footnoteId = match[1];
                    console.log('Footnote clicked:', footnoteId, 'Cached?', !!footnoteCache[footnoteId]);
                    
                    // Check cache first (pre-loaded from notes table)
                    if (footnoteCache[footnoteId]) {
                        console.log('Loading from cache');
                        showFootnotePopup(footnoteId, footnoteCache[footnoteId].content, footnoteCache[footnoteId].title);
                        return;
                    }
                    
                    console.log('Not in cache, fetching from API...');
                    
                    // Fetch footnote content via JSON API (fallback)
                    fetch('/footnote/' + footnoteId + '/json/')
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Footnote not found');
                            }
                            return response.json();
                        })
                        .then(data => {
                            const title = data.title || 'Footnote ' + footnoteId;
                            const content = data.content || '<p>No content available</p>';
                            
                            console.log('Fetched from API, caching result');
                            // Cache the result
                            footnoteCache[footnoteId] = { title: title, content: content };
                            
                            showFootnotePopup(footnoteId, content, title);
                        })
                        .catch(error => {
                            console.error('Error fetching footnote:', error);
                            // Fallback: navigate to footnote page
                            window.location.href = '/?footnote=' + footnoteId;
                        });
                });
            });
        }

        // Initialize footnote popup handlers
        attachFootnotePopupHandlers();

        // Re-attach when content changes
        const footnotePopupObserver = new MutationObserver(attachFootnotePopupHandlers);
        footnotePopupObserver.observe(document.body, { childList: true, subtree: true });

        // ============================================
        // Tooltip Touch/Click Support
        // ============================================
        
        // Create tooltip overlay element
        let tooltipOverlay = document.querySelector('.tooltip-overlay');
        if (!tooltipOverlay) {
            tooltipOverlay = document.createElement('div');
            tooltipOverlay.className = 'tooltip-overlay';
            document.body.appendChild(tooltipOverlay);
        }
        
        let activeTooltip = null;
        
        function openTooltip(tooltipEl) {
            if (activeTooltip) {
                closeTooltip();
            }
            
            // Add close button if not present
            if (!tooltipEl.querySelector('.tooltip-close-btn')) {
                const closeBtn = document.createElement('button');
                closeBtn.className = 'tooltip-close-btn';
                closeBtn.innerHTML = '√ó';
                closeBtn.setAttribute('aria-label', 'Close');
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    closeTooltip();
                });
                tooltipEl.insertBefore(closeBtn, tooltipEl.firstChild);
            }
            
            activeTooltip = tooltipEl;
            tooltipOverlay.classList.add('active');
            tooltipEl.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeTooltip() {
            if (activeTooltip) {
                activeTooltip.classList.remove('active');
                activeTooltip = null;
            }
            tooltipOverlay.classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // Attach click/touch listeners to tooltip containers
        function attachTooltipListeners() {
            const tooltipContainers = document.querySelectorAll('.tooltip-container');
            tooltipContainers.forEach(container => {
                // Skip if already initialized
                if (container.dataset.tooltipInit) return;
                container.dataset.tooltipInit = 'true';
                
                container.addEventListener('click', function(e) {
                    // Don't trigger if clicking a link inside
                    if (e.target.tagName === 'A') return;
                    
                    const tooltip = container.querySelector('.tooltip, .tooltip2');
                    if (tooltip) {
                        e.preventDefault();
                        e.stopPropagation();
                        openTooltip(tooltip);
                    }
                });
            });
        }
        
        // Close tooltip when clicking overlay
        tooltipOverlay.addEventListener('click', closeTooltip);
        
        // Close on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && activeTooltip) {
                closeTooltip();
            }
        });
        
        // Initialize tooltip listeners
        attachTooltipListeners();
        
        // Re-attach when content changes
        const tooltipObserver = new MutationObserver(attachTooltipListeners);
        tooltipObserver.observe(document.body, { childList: true, subtree: true });
    });
</script>

{% endblock %}