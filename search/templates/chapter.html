{% extends 'base.html' %}
{% block title %}Real Bible Translation - {{ page_title }}{% endblock %}
{% load custom_tags %}
{% block content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css" crossorigin="anonymous">
<p><a href="/">Back to Search</a></p>

<!-- make this a python generated variable depending on book i.e. 'Genesis Chapters: '-->
<div style="padding-bottom: 20px;">
<strong>Select a Chapter:</strong>
    {{ chapters|safe }}
</div>

<h1>{{ book }} {{ chapter_num }}</h1>
{% with title_prefix=book|title %}
<div id="toggleButtonsContainer">
    <div id="h5ToggleButton"><i class="fas fa-eye-slash"></i> Hide Headers (H)</div>
    <div id="imageToggleButton"><i class="fas fa-eye-slash"></i> Hide Images (I)</div>
    <div id="literalToggleButton"><i class="fas fa-eye"></i> Show Literal (L)</div>
    <div id="verseRefToggleButton"><i class="fas fa-eye-slash"></i> Hide Verse References (V)</div>
    <div id="notesToggleButton"><i class="fas fa-book"></i> Show Notes (N)</div>
    <div id="fontDecreaseButton"><i class="fas fa-minus"></i> A-</div>
    <div id="fontIncreaseButton"><i class="fas fa-plus"></i> A+</div>
</div>

{% endwith %}
<div id="container" style="display: flex; justify-content: space-between;">
    <div id="paraphraseContainer" style="width: 50%; padding-right: 10px;">
        <h4>RBT Paraphrase</h4>
        {% if paraphrase %}
            {{ paraphrase|safe }}
        {% else %}
            <p>No results found for chapter {{ chapter_num }}.</p>
        {% endif %}
    </div>

    <div id="toggleDivContainer" style="width: 50%; padding-left: 10px; border-left: 1px solid #000; display: none;">
        <div id="literal-pane" style="display: none;">
            <h4>RBT Hebrew Literal</h4>
            {% if html %}
                {{ html|safe }}
            {% else %}
                <p>No results found for chapter {{ chapter_num }}.</p>
            {% endif %}
        </div>

        <div id="notes-pane" style="display: none;">
            <h4>Notes</h4>
            {% if notes_html %}
                {{ notes_html|safe }}
            {% else %}
                <p class="notes-empty">No notes collected for this chapter.</p>
            {% endif %}
        </div>
    </div>
</div>

<style>
    .notes-empty {
        margin: 0;
        font-size: 14px;
        color: #666;
    }

    /* Modern toolbar container */
    #toggleButtonsContainer {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-end;
        gap: 8px;
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        padding: 8px 12px;
        margin-bottom: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        position: sticky;
        top: 0;
        z-index: 50;
    }

    /* Toolbar buttons */
    #toggleButtonsContainer > div {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 14px;
        padding: 6px 12px;
        color: #ba8666;
        background: white;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s ease;
        user-select: none;
    }

    /* Hover and active states */
    #toggleButtonsContainer > div:hover {
        background: #f4ebe5;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }

    /* Icon styling */
    #toggleButtonsContainer i {
        color: #ba8666;
        font-size: 14px;
    }

    /* Mobile styles */
    @media (max-width: 768px) {
        #container {
            flex-direction: column !important;
        }
        
        #paraphraseContainer {
            width: 100% !important;
            padding-right: 0 !important;
            margin-bottom: 20px;
        }
        
        #toggleDivContainer {
            width: 100% !important;
            padding-left: 0 !important;
            border-left: none !important;
            border-top: 1px solid #000;
            padding-top: 20px;
        }
        
        #toggleButtonsContainer {
            justify-content: center !important;
            gap: 5px;
        }
        
        #toggleButtonsContainer > div {
            font-size: 12px !important;
            padding: 4px 6px !important;
        }
    }

    #notes-pane {
        font-size: 13px;
        color: #333;
        line-height: 1.4;
    }

    #notes-pane table {
        font-size: inherit;
    }

    #notes-pane td,
    #notes-pane th,
    #notes-pane p,
    #notes-pane li {
        color: inherit;
    }

    #notes-pane .rbt_footnote {
        font-size: inherit;
        color: inherit;
        line-height: inherit;
    }

    #notes-pane .note-location {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
    }

    .hebrew_footnote {
        font-size: 1.5em;
    }

    /* Hide touch indicator on desktop */
    .touch-indicator {
        display: none;
    }

    /* Show touch indicator only on mobile/touch devices */
    @media (max-width: 768px), (hover: none) {
        .touch-indicator {
            display: block;
        }
    }

    /* Responsive images and videos in tooltip containers */
    .tooltip-container img,
    .tooltip-container video {
        max-width: 500px;
        width: 100% !important;
        height: auto !important;
        display: block;
        margin: 0 auto;
    }

    @media (max-width: 768px) {
        .tooltip-container img,
        .tooltip-container video {
            max-width: 100%;
            width: 100% !important;
        }
    }
</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const literalToggleButton = document.getElementById("literalToggleButton");
        const imageToggleButton = document.getElementById("imageToggleButton");
        const h5ToggleButton = document.getElementById("h5ToggleButton");
        const verseRefToggleButton = document.getElementById("verseRefToggleButton");
        const notesToggleButton = document.getElementById("notesToggleButton");
        const toggleDivContainer = document.getElementById("toggleDivContainer");
        const paraphraseContainer = document.getElementById("paraphraseContainer");
        const container = document.getElementById("container");
        const verseRefs = document.querySelectorAll(".verse_ref");
        const literalPane = document.getElementById("literal-pane");
        const notesPane = document.getElementById("notes-pane");
        const fontDecreaseButton = document.getElementById("fontDecreaseButton");
        const fontIncreaseButton = document.getElementById("fontIncreaseButton");
        
        // Check if device is mobile
        const isMobile = window.innerWidth <= 768;
        
        // Font size management
        let currentFontSize = 100; // percentage
        const MIN_FONT_SIZE = 80;
        const MAX_FONT_SIZE = 150;
        const FONT_STEP = 10;
        
        function updateFontSize() {
            document.getElementById('container').style.fontSize = currentFontSize + '%';
            localStorage.setItem('chapterFontSize', currentFontSize);
        }
        
        // Load saved font size
        const savedFontSize = localStorage.getItem('chapterFontSize');
        if (savedFontSize) {
            currentFontSize = parseInt(savedFontSize);
            updateFontSize();
        }
        
        let isLiteralVisible = false; // Hide literal by default
        let isImageVisible = true;
        let isH5Visible = true;
        let isVerseRefVisible = false;
        let isNotesVisible = false; // Hide notes by default

        function updateLiteralButtonLabel() {
            literalToggleButton.innerHTML = isLiteralVisible
                ? '<i class="fas fa-eye-slash"></i> Hide Literal (L)'
                : '<i class="fas fa-eye"></i> Show Literal (L)';
        }

        function updateLayout() {
            const isWideScreen = window.innerWidth > 768;

            if (isNotesVisible) {
                notesPane.style.display = "block";
                literalPane.style.display = "none";
                toggleDivContainer.style.display = "block";
                paraphraseContainer.style.width = isWideScreen ? "50%" : "100%";
                notesToggleButton.innerHTML = '<i class="fas fa-book-open"></i> Hide Notes (N)';
            } else {
                notesPane.style.display = "none";
                literalPane.style.display = isLiteralVisible ? "block" : "none";

                if (isLiteralVisible) {
                    toggleDivContainer.style.display = "block";
                    paraphraseContainer.style.width = isWideScreen ? "50%" : "100%";
                } else {
                    toggleDivContainer.style.display = "none";
                    paraphraseContainer.style.width = "100%";
                }

                 notesToggleButton.innerHTML = '<i class="fas fa-book"></i> Show Notes (N)';
            }

            updateLiteralButtonLabel();
        }

        updateLayout();
        
        function toggleVerseRefs() {
            verseRefs.forEach(function(ref) {
                if (isVerseRefVisible) {
                    ref.style.display = "none";
                } else {
                    ref.style.display = "inline"; // Change to "block" if necessary
                }
            });
            isVerseRefVisible = !isVerseRefVisible; // Toggle the visibility state
            verseRefToggleButton.innerHTML = isVerseRefVisible ? '<i class="fas fa-eye-slash"></i> Hide Verse References (V)' : '<i class="fas fa-eye"></i> Show Verse References (V)';
        }

        literalToggleButton.addEventListener("click", function() {
            if (isNotesVisible) {
                // Override notes view: show literal instead
                isNotesVisible = false;
                isLiteralVisible = true;
            } else {
                isLiteralVisible = !isLiteralVisible;
            }

            updateLayout();
        });

        h5ToggleButton.addEventListener("click", function() {
            const h5Elements = document.querySelectorAll("h3, h4, h5, h6");
            h5Elements.forEach(function(element) {
                if (isH5Visible) {
                    element.style.display = "none";
                    h5ToggleButton.innerHTML = '<i class="fas fa-eye"></i> Show Headers (H)';
                } else {
                    element.style.display = "block";
                    h5ToggleButton.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Headers (H)';
                }
            });
            isH5Visible = !isH5Visible; // Toggle the visibility state
        });

        imageToggleButton.addEventListener("click", function() {
            const tooltipContainers = document.querySelectorAll(".tooltip-container");
            tooltipContainers.forEach(function(container) {
                if (isImageVisible) {
                    container.style.display = "none";
                    imageToggleButton.innerHTML = '<i class="fas fa-eye"></i> Show Images (I)';
                } else {
                    container.style.display = "block";
                    imageToggleButton.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Images (I)';
                }
            });
            isImageVisible = !isImageVisible; // Toggle the visibility state
        });

        verseRefToggleButton.addEventListener("click", function() {
            toggleVerseRefs();
        });

        notesToggleButton.addEventListener("click", function() {
            isNotesVisible = !isNotesVisible;
            updateLayout();
        });
        
        fontIncreaseButton.addEventListener("click", function() {
            if (currentFontSize < MAX_FONT_SIZE) {
                currentFontSize += FONT_STEP;
                updateFontSize();
            }
        });
        
        fontDecreaseButton.addEventListener("click", function() {
            if (currentFontSize > MIN_FONT_SIZE) {
                currentFontSize -= FONT_STEP;
                updateFontSize();
            }
        });

        function handleKeyDown(event) {
            if (event.key === "v") {
                toggleVerseRefs();
            } else if (event.key === "h") { 
                h5ToggleButton.click();
            } else if (event.key === "i") { 
                imageToggleButton.click();
            } else if (event.key === "l") { 
                literalToggleButton.click();
            } else if (event.key === "n") {
                notesToggleButton.click();
            } else if (event.key === "+" || event.key === "=") {
                fontIncreaseButton.click();
            } else if (event.key === "-" || event.key === "_") {
                fontDecreaseButton.click();
            }
        }
        document.addEventListener("keydown", handleKeyDown);

        // Handle window resize
        window.addEventListener('resize', function() {
            const currentIsMobile = window.innerWidth <= 768;
            if (currentIsMobile !== isMobile) {
                location.reload(); // Reload page to reset mobile state
            }
        });

        // Initialize verse references as hidden
        toggleVerseRefs();

        const paneButtons = document.querySelectorAll('#toggleDivContainer .pane-button');
        const paneContents = document.querySelectorAll('#toggleDivContainer .pane-content');

        paneButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const targetId = button.getAttribute('data-target');

                paneButtons.forEach((btn) => btn.classList.toggle('active', btn === button));
                paneContents.forEach((pane) => pane.classList.toggle('active', pane.id === targetId));
            });
        });
    });
</script>

{% endblock %}