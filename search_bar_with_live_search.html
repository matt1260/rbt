<style>
/* Search Bar Styles */
.front_search {
    width: 100%;
    border: none;
    margin-bottom: 20px;
}

.front_search input[type="text"] {
    width: 80%;
    padding: 12px;
    font-size: 16px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    transition: all 0.3s;
}

.front_search input[type="text"]:focus {
    outline: none;
    border-color: #b78550;
    box-shadow: 0 0 0 3px rgba(183, 133, 80, 0.15);
}

.front_search button {
    padding: 12px 24px;
    background: #b78550;
    color: #fff;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 10px;
}

.front_search button:hover {
    background: #965f35;
    transform: translateY(-2px);
}

.front td {
    padding: 15px;
}

/* Live Results Dropdown */
.search-wrapper {
    position: relative;
}

.live-results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    display: none;
    margin-top: 8px;
}

.live-results.active {
    display: block;
}

.result-item {
    padding: 12px 15px;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
    transition: background 0.15s;
    text-decoration: none;
    display: block;
    color: inherit;
}

.result-item:hover {
    background: #f8f9fa;
}

.result-reference {
    font-weight: 600;
    color: #b78550;
    margin-bottom: 5px;
}

.result-preview {
    font-size: 14px;
    color: #555;
    line-height: 1.5;
}

.result-preview mark {
    background: #ffeb3b;
    padding: 1px 3px;
    border-radius: 2px;
}

.results-meta {
    padding: 10px 15px;
    background: #f8f9fa;
    border-bottom: 1px solid #e0e0e0;
    font-size: 13px;
    color: #666;
}

.no-results {
    padding: 20px;
    text-align: center;
    color: #999;
}

/* Responsive */
@media (min-width: 768px) {
    .mobile-view { display: none; }
}

@media (max-width: 767px) {
    .desktop-view { display: none; }
    .front_search input[type="text"] {
        width: 70%;
    }
}
</style>

<!-- Desktop View -->
<div class="desktop-view">
    <table class="front_search" style="border: none;">
        <tbody>
            <tr>
                <td>
                    <div class="search-wrapper">
                        <form method="get" action="https://read.realbible.tech/" style="text-align: left;">
                            <input type="text" name="ref" id="refInputDesktop" placeholder="Enter a reference..." autocomplete="off">
                            <button type="submit">Go</button>
                            <div class="live-results" id="refResultsDesktop"></div>
                        </form>
                    </div>
                </td>
                <td class="front">
                    <div class="search-wrapper">
                        <form method="get" action="https://read.realbible.tech/" style="text-align: left;">
                            <input type="text" name="q" id="keywordInputDesktop" placeholder="Enter a search word..." autocomplete="off">
                            <button type="submit">Search</button>
                            <div class="live-results" id="keywordResultsDesktop"></div>
                        </form>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Mobile View -->
<div class="mobile-view">
    <table class="front_search" style="border: none;">
        <tbody>
            <tr>
                <td class="front">
                    <div class="search-wrapper">
                        <form method="get" action="https://read.realbible.tech/">
                            <input type="text" name="ref" id="refInputMobile" placeholder="Enter a reference..." autocomplete="off">
                            <button type="submit">Go</button>
                            <div class="live-results" id="refResultsMobile"></div>
                        </form>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
    <table class="front_search" style="border: none;">
        <tbody>
            <tr>
                <td class="front">
                    <div class="search-wrapper">
                        <form method="get" action="https://read.realbible.tech/">
                            <input type="text" name="q" id="keywordInputMobile" placeholder="Enter a search word..." autocomplete="off">
                            <button type="submit">Search</button>
                            <div class="live-results" id="keywordResultsMobile"></div>
                        </form>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>

<script>
// Live Search Functionality
(function() {
    let searchTimeout;
    // Production WordPress → Django API (cross-origin request)
    const API_BASE = 'https://read.realbible.tech';
    
    // Debounce function
    function debounce(func, wait) {
        return function executedFunction(...args) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => func(...args), wait);
        };
    }
    
    // Setup live search for an input
    function setupLiveSearch(inputId, resultsId, searchType) {
        const input = document.getElementById(inputId);
        const results = document.getElementById(resultsId);
        
        if (!input || !results) return;
        
        // Handle input changes
        input.addEventListener('input', debounce(function(e) {
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                results.classList.remove('active');
                return;
            }
            
            // Build search URL - API is at /api/live/ not /api/search/
            let searchUrl;
            if (searchType === 'reference') {
                searchUrl = `${API_BASE}/api/live/?type=reference&q=${encodeURIComponent(query)}`;
            } else {
                searchUrl = `${API_BASE}/api/live/?type=keyword&q=${encodeURIComponent(query)}`;
            }
            
            // Fetch results
            fetch(searchUrl)
                .then(response => response.json())
                .then(data => displayResults(data, results, query))
                .catch(error => {
                    console.error('Search error:', error);
                    results.innerHTML = '<div class="no-results">Search unavailable</div>';
                    results.classList.add('active');
                });
        }, 300));
        
        // Close results when clicking outside
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !results.contains(e.target)) {
                results.classList.remove('active');
            }
        });
        
        // Show results when input is focused with existing query
        input.addEventListener('focus', function() {
            if (input.value.trim().length >= 2 && results.innerHTML) {
                results.classList.add('active');
            }
        });
    }
    
    // Display search results with categories
    function displayResults(data, resultsContainer, query) {
        const results = data.results || data;
        let html = '';
        let totalShown = 0;
        
        // Calculate total count
        const totalCount = data.total || 0;
        
        if (totalCount === 0) {
            resultsContainer.innerHTML = '<div class="no-results">No results found</div>';
            resultsContainer.classList.add('active');
            return;
        }
        
        // Meta header with total count
        html += `<div class="results-meta">Found ${totalCount} result${totalCount !== 1 ? 's' : ''}</div>`;
        
        // Helper to add category results
        function addCategory(items, title, limit = 3) {
            if (!items || items.length === 0) return;
            
            html += `<div class="results-category"><i class="fas fa-bookmark"></i> ${title} (${items.length})</div>`;
            const displayItems = items.slice(0, limit);
            
            displayItems.forEach(item => {
                const ref = item.display || `${item.book} ${item.chapter}:${item.verse}`;
                const preview = item.text ? highlightMatch(item.text, query, 150) : 
                               item.english ? `English: ${item.english}` :
                               item.hebrew ? item.hebrew : '';
                const version = item.version ? ` <span class="source-badge">${item.version}</span>` : '';
                
                html += `
                    <a href="${item.url}" class="result-item">
                        <div class="result-reference">${ref}${version}</div>
                        ${preview ? `<div class="result-preview">${preview}</div>` : ''}
                    </a>
                `;
                totalShown++;
            });
        }
        
        // Add results by category
        if (results.references && results.references.length > 0) {
            addCategory(results.references, 'References', 3);
        }
        if (results.ot_verses && results.ot_verses.length > 0) {
            addCategory(results.ot_verses, 'Old Testament', 3);
        }
        if (results.ot_hebrew && results.ot_hebrew.length > 0) {
            addCategory(results.ot_hebrew, 'Hebrew Words', 3);
        }
        if (results.nt_verses && results.nt_verses.length > 0) {
            addCategory(results.nt_verses, 'New Testament', 3);
        }
        if (results.nt_greek && results.nt_greek.length > 0) {
            addCategory(results.nt_greek, 'Greek Words', 3);
        }
        if (results.footnotes && results.footnotes.length > 0) {
            addCategory(results.footnotes, 'Footnotes', 2);
        }
        
        // Add "View All Results" link if there are more results
        if (totalCount > totalShown) {
            html += `<a href="https://read.realbible.tech/search/?q=${encodeURIComponent(query)}" class="view-all-results">
                View All ${totalCount} Results →
            </a>`;
        }
        
        resultsContainer.innerHTML = html;
        resultsContainer.classList.add('active');
    }
    
    // Highlight matching text
    function highlightMatch(text, query, maxLength = 200) {
        if (!text || !query) return text;
        
        // Escape special regex characters
        const escaped = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(${escaped})`, 'gi');
        
        // Truncate long text
        let truncated = text.substring(0, maxLength);
        if (text.length > maxLength) truncated += '...';
        
        return truncated.replace(regex, '<mark>$1</mark>');
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Desktop inputs
        setupLiveSearch('refInputDesktop', 'refResultsDesktop', 'reference');
        setupLiveSearch('keywordInputDesktop', 'keywordResultsDesktop', 'keyword');
        
        // Mobile inputs
        setupLiveSearch('refInputMobile', 'refResultsMobile', 'reference');
        setupLiveSearch('keywordInputMobile', 'keywordResultsMobile', 'keyword');
    });
})();
</script>
